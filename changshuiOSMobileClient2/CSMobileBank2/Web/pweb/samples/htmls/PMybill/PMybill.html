<div v-view-setup="PMybillCtrl" v-init="init()">
	<!-- 我的账单 -->
	<div style="padding-bottom:0" v-page v-transition="native" title="我的账单">
		<div v-repeat="credit in credList">
		<div class="creditcard" v-click="showMore($index,credit)" style="background:white;">
				<div class="radio_cont1" id="debitCard" style="color:#666">
					<b>
						<img class="p1" src="images/kongbaige.png" style="width:5%;padding-left:5px;" v-hide="moreInfo==$index"/>
						<img class="p2" src="images/huangqueren.png" style="width:5%;padding-left:5px;font-color:black" v-show="moreInfo==$index" />&nbsp;{{credit.creditCardNo}}
						&nbsp;<em class="gzk">{{credit.AcAlias}}</em>
					</b>
				</div>
			</div>
		<div v-show="moreInfo==$index">
			<div class="creditcard_box">
			<div class="zz_cont">
				<div class="bor_1" style="width:100%;height:40px;line-height:35px;float:left;margin-bottom:10px;background:white;color:#fff;border:#fff 1px solid;margin-top:10px">
				<div class="set_right set1" v-click="optionsCard($index,credit,'haveGiven')" style="background-color:white;color:black;">已出账单</div>
					<div class="set_left set2 " v-click="optionsCard($index,credit,'noGiven')" style="background-color:white;color:#0084ff;">未出账单</div>
				</div>
				<div class="d1" style="height:10px;width:100%;background:white;float:left;"><div class="d3" style="height:2px;width:6%;background:white;float:left"></div><div class="d2" style="height:2px;width:38%;background:#0084ff;float:left"></div></div>
				
			</div>
			<div class="zz_cont">
				<ul>
<!-- 						<li> -->
<!--  							<em style="width: 47%;">币种:&nbsp;&nbsp;&nbsp;</em> -->
<!-- 							<i style="width: 53%;"> -->
<!-- 								<select v-model="amountType" name="amountType" style="font-size:12px;width: 50%;"> -->
<!-- 									<option value="1">人民币</option> -->
<!-- 								</select> -->
<!-- 							</i> -->
<!-- 						</li> -->
						<li v-show="isGiven=='no'">
							<em style="width: 47%;float:left">已入账金额:&nbsp;&nbsp;&nbsp;</em>
							<i style="width: 53%;">
								{{totalInAmount?totalInAmount:0|number:2}}元
							</i>
						</li>
				 </ul>
			</div>
			</div>
				<div v-show="isGiven=='no'">
			     <div class="khh" v-repeat="BillIn in BillInMesgList">
			     	<div style="height:50px;">
			     	<div style="float:left;width: 40%;height:75%;padding-left:10px;">
			     		<div>{{BillIn.tranDescrition|accountStar}}</div>
			     	</div>
			     	<div style="float:right;width: 55%;height:100%;">
			     		<div style="text-align:right;margin-bottom:3px;padding-right:25%;" v-show="BillIn.amtFlag=='-'" ><i style="color:red"><em v-hide="BillIn.amtFlag=='+'">{{BillIn.amtFlag}}</em>{{BillIn.tranAmount|number:2}}</i></div>
			     		<div style="text-align:right;margin-bottom:3px;padding-right:25%;" v-show="BillIn.amtFlag=='+'"><i style="color:green"><em v-hide="BillIn.amtFlag=='+'">{{BillIn.amtFlag}}</em>{{BillIn.tranAmount|number:2}}</i></div>
						<div style="text-align:right;padding-right:25%"><i style="float:center;">{{BillIn.purchaseDate|formatDate}}&nbsp;{{BillIn.purchaseTime|formatTime}}</i></div>
					</div>
					</div>
		    	</div>
		    	<div class="zz_cont" v-show="billInTurnPageFlag=='1'">
			     	<input type="submit" id="billInButton"  class="button_1" name="billInButton" value="查看更多" v-click="billInMorepage()">
			     </div>
			     </br>
		    	<div class="zz_cont">
		     		<input type="submit" class="button_1" name="Submit" value="我要还款" v-click="toPRepay(credit.creditCardNo)">
		     	 </div>
			</div>
				
			<div v-show="isGiven=='yes'">
			<div class="khh" v-repeat="BillOut in BillOutMesgList1" v-click="toTransDetail(credit.creditCardNo,BillOut,true)">
				 <div class="xiangq_img1" v-click="toTransDetail(credit.creditCardNo,BillOut,true)"><a href="#"><img src="images/more.png"/></a></div>
				      <ul>
							<li><em style="width:65%">月份：</em><i style="width:24%">{{BillOut.tranYM|formatShortDate}}</i></li>
							<li><em style="width:65%">本期应还金额：</em><i style="width:24%">{{BillOut.nowRepayAmt|number:2}}元</i></li>
					  </ul>
		    	</div>
		    <div class="5BillGiven">
		    <div class="khh" v-repeat="BillOut in BillOutMesgList2" v-click="toTransDetail(credit.creditCardNo,BillOut,false)">
		    	<div class="xiangq_img1" v-click="toTransDetail(credit.creditCardNo,BillOut,false)"><a href="#"><img src="images/more.png"/></a></div>
				      <ul>
							<li><em style="width:65%">月份：</em><i style="width:24%">{{BillOut.tranYM|formatShortDate}}</i></li>
							<li><em style="width:65%">本期应还金额：</em><i style="width:24%">{{BillOut.nowRepayAmt|number:2}}元</i></li>
					  </ul>
		    </div>
		    </div>
		    <div class="zz_cont moreBtn">
		     		<input type="submit" class="button_1" name="Submit" value="查看更多" v-click="toMoreInfo($index,credit)">
		     	 </div>
			</div>
			</div>
		</div>
	</div>
	<div v-page v-transition="native" title="已出账单交易查询">
		<div class="bg_box">
			<div class="box_cont">
				<div class="zz_cont">
					<ul>
<!-- 						<li><em>币种：</em><i>{{moneyKind}}</i></li> -->
						<li><em>账单日：</em><i>每月{{billOutDay}}日</i></li>
<!-- 						<li><em>本期账单金额：</em><i style="color:red">{{BillOutInfo.nowRepayAmt|number:2}}元</i></li> -->
						<li><em>到期还款日：</em><i>{{BillOutInfo.endDate?BillOutInfo.endDate:"--"}}</i></li>
						<li><em>本期应还金额：</em><i style="color:red">{{BillOutInfo.nowRepayAmt|number:2}}元</i></li>
						<li><em>最低还款金额：</em><i style="color:red">{{BillOutInfo.minRepayAmt|number:2}}元</i></li>
						<!-- <li><em>本期新增积分：</em><i style="color:#ff6000;">--</i></li>
						<li><em>本期兑换积分：</em><i>--</i></li>
						<li><em>剩余积分：</em><i>--</i></li> -->
				  </ul>
				</div>
			</div>
		</div>
	 	<div v-show="payFlag">
	 		<div class="zz_cont">
    			<input type="submit" class="button_1" name="Submit" value="我要还款" v-click="toPRepay(cardNo)">
			</div>
		</div>
		<div class="bg_box">
			<div class="box_cont">
			     <div class="khh" v-repeat="BillOut in BillOutList" v-hide="!BillOut.serialNo">
			     	<div style="height:50px;" >
			     	<div style="float:left;width: 40%;height:75%;padding-left:10px;">
			     		<div>{{BillOut.tranDescrition|accountStar}}</div>
			     	</div>
			     	<div style="float:right;width: 55%;height:100%;">
			     		<div style="text-align:right;margin-bottom:3px;padding-right:15%;" v-show="BillOut.amtFlag=='-'" ><i style="color:red"><em v-hide="BillIn.amtFlag=='+'">{{BillOut.amtFlag}}</em>{{BillOut.tranAmount|number:2}}</i></div>
			     		<div style="text-align:right;margin-bottom:3px;padding-right:15%;" v-show="BillOut.amtFlag=='+'"><i style="color:green"><em v-hide="BillIn.amtFlag=='+'">{{BillOut.amtFlag}}</em>{{BillOut.tranAmount|number:2}}</i></div>
						<div style="text-align: center;"><i style="float:center;">{{BillOut.purchaseDate|formatDate}}&nbsp;{{BillOut.purchaseTime|formatTime}}</i></div>
					</div>
					</div>
		    	</div>
		    	<div v-show="billOutTurnPageFlag=='1'">
			     	<input type="submit" id="billOutButton"  class="button_1" name="billOutButton" value="查看更多" v-click="billOutMorepage()">
			     </div>
		    </div>
		</div>
	</div>
</div>
<script>
PMybillCtrl.$inject = ["$scope","$remote","$targets","$context","$timeout"];
function PMybillCtrl($scope,$remote,$targets,$context,$timeout){
	$scope.init=function(){
		$scope.billInTurnPageFlag='0';
		$scope.billOutTurnPageFlag='0';
		//查询到信用卡账号
		$remote.post("/pmobile/ActListQry.do",{},function(data){
			$scope.credList=data.CreditList;
			var fristcard=$context.getJson().selectedNum;
			var f;
			if($scope.credList.length==0){
				$scope.alert("无信用卡加挂信息或卡片未激活");
			}else if($scope.credList.length==1){
				$scope.showMore(0,$scope.credList[0]);
			}else{
				vx.forEach($scope.credList,function(item,index){
					if(fristcard==item.creditCardNo){
						f=index;
					}
				});
				//console.log("3");
				$scope.showMore(f,$scope.credList[f]);
				//console.log("4");
			}
		});
		//获取服务器当前时间
		$remote.post("/pmobile/GenTimeStamp.do",{},function(data){
			var serviceTime=data._sysDate;//如：20150613161540
			//获取年月日
			$scope.tranYMD=serviceTime.substring(0,8);
		});
		//币种
		$scope.amountType=1;
	}
	//选中账号
	$scope.showMore=function(index,card){
		console.log(index);
		$timeout(function(){
		if($scope.moreInfo!=index){
			$scope.moreInfo=index;//点击，展开对应信用卡账单信息
		}else{
			$scope.moreInfo=-1;//点击，收起对应信用卡账单信息
		}
		$scope.isGiven="no";
// 		var el=$(event.target).find("img:eq(0)");
// 		var el2=$(event.target).find("img:eq(1)");
		var el=$("#p1:eq("+index+")");
		var el2=$("#p2:eq("+index+")");
		if($scope.moreInfo==index){
			$('.set2').css('color','#0084ff');
			$('.set1').css('color','black');
			$('.d3').css('width','6%');
			$scope.isGiven="no";
			$scope.BillInQry(card);
		}else{
			$('.set1').css('color','#0084ff');
			$('.set2').css('color','black');
			$('.d3').css('width','57%');
			$(".5BillGiven:eq("+index+")").css("display","none");
			$(".moreBtn:eq("+index+")").css("display","block");
			$scope.isGiven="yes";
		}
		},500);
	}
	//未出账单查询
	$scope.BillInQry=function(card){
		$scope.billInTurnPageFlag='0';
		$scope.billOutTurnPageFlag='0';
		$scope.BillInMesgList=[];
		$scope.creditCardNo = card.creditCardNo;
		$remote.post("/pmobile/CreditcardBillIn.do",{"CreditNo":card.creditCardNo},function(data){
			console.log(data);
			$scope.billInTurnPageFlag = data.turnPageFlag;
			$scope.BillInMesgList=data.List;
			var temp=0;
			vx.forEach($scope.BillInMesgList,function(item){
				if(item.tranAmount!=""&&item.tranAmount!=null){
					temp=temp+parseFloat(item.tranAmount);
				}
			});
			//已入账交易金额合计
			$scope.totalInAmount=temp;
		},function(data){
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			$scope.BillInMesgList="";
			$scope.totalInAmount=0;
			return data.jsonError;
		});
	}
	//迭代获取n月之前的月份
	$scope.getMonth=function(tranY,tranM,n){
		if(tranM=="01"){
			tranY=tranY-1;
			tranM="12";
		}else if(tranM=="11"||tranM=="12"){
			tranM=tranM-1;
		}else{
			tranM=tranM-1;
			tranM="0"+tranM;
		}
		if(n>0){
			return $scope.getMonth(tranY,tranM,n-1)
		}else if(n==0){
			return tranYM=(tranY+tranM).substring(2,6);
		}
		
	}
	//已出账单查询
	$scope.BillOutQry=function(card){
		$scope.creditCardNo = card.creditCardNo;
		//查询账单日和还款日
		$remote.post("/pmobile/CreditcardPublicInfo.do",{"CreditNo":card.creditCardNo},function(data){
			$scope.billOutDay=data.cyNBR;
			if($scope.billOutDay){
				var tranY= $scope.tranYMD.substring(0,4);
				var tranM= $scope.tranYMD.substring(4,6);
				var tranD= $scope.tranYMD.substring(6,8);
				if(parseFloat(tranD) < parseFloat($scope.billOutDay)){
					$scope.tranYM1=$scope.getMonth(tranY,tranM,0);
				}else{
					$scope.tranYM1=$scope.tranYMD.substring(2,6);
				}
				
				//已出账单近一个月明细
				$remote.post("/pmobile/CreditcardBillOut1.do",{"CreditNo":card.creditCardNo,"tranYM":$scope.tranYM1},function(data){
					$scope.BillOutMesgList1=data.List;
				},function(data){
					if(data.jsonError){
						$scope.alert(data.jsonError);
					}
					$scope.BillOutMesgList1="";
					return data.jsonError;
				});
			}
		});
	}
	//选项卡切换
	$scope.optionsCard=function(index,card,id){
		if(id=="noGiven"){
			$('.set2').css('color','#0084ff');
			$('.set1').css('color','black');
			$('.d3').css('width','6%');
			$scope.isGiven="no";
			$scope.BillInQry(card);
		}else if(id=="haveGiven"){
			$('.set1').css('color','#0084ff');
			$('.set2').css('color','black');
			$('.d3').css('width','57%');
			$(".5BillGiven:eq("+index+")").css("display","none");
			$(".moreBtn:eq("+index+")").css("display","block");
			$scope.isGiven="yes";
			$scope.BillOutQry(card);
		}
	}
	//已出账单-查看更多
	$scope.toMoreInfo=function(index,card){
		$scope.creditCardNo = card.creditCardNo;
		//账单另五个月明细
		$remote.post("/pmobile/CreditcardBillOut2.do",{"CreditNo":card.creditCardNo,"tranYM":$scope.tranYM1},function(data){
			console.log(data);
			console.log($scope.tranYM1);
			if(!data.List){
				alert("未找到更多账单");
			}else{
				$scope.BillOutMesgList2=data.List;
			}
		});
		$(".5BillGiven:eq("+index+")").css("display","block");
		$(".moreBtn:eq("+index+")").css("display","none");
	}
	//已出账单详情
	$scope.toTransDetail=function(cardNo,BillOut,payFlag){
		$scope.moneyKind="人民币";
		$scope.payFlag=payFlag;
		$scope.cardNo=cardNo;
		$scope.BillOutInfo=BillOut;
		$scope.billOutTurnPageFlag = BillOut.turnPageFlag;
		$scope.billOuttranYM = BillOut.tranYM;
		$scope.BillOutList=BillOut.List;
		console.log($scope.BillOutList);
		$targets("content","#2");
	}
	//进入我要还款
	$scope.toPRepay=function(cardNo){
		$context.setJson({"selectedAcc":cardNo});
		$scope.goto("PMybill","PRepayment");
	}
	
	$scope.billInMorepage = function(){
		var leg = $scope.BillInMesgList.length-1;
		var formData = {
				"CreditNo":$scope.creditCardNo,
				"turnPageFlag":"1",
				"bookingDate":$scope.BillInMesgList[leg].bookingDate,
				"purchaseDate":$scope.BillInMesgList[leg].purchaseDate,
				"purchaseTime":$scope.BillInMesgList[leg].purchaseTime,
				"serialNo":$scope.BillInMesgList[leg].serialNo
		};
		$remote.post("/pmobile/CreditcardBillIn.do",formData,function(data){
			console.log(data);
			$scope.billInTurnPageFlag = data.turnPageFlag;
			$scope.BillInMesgList=$scope.BillInMesgList.concat(data.List);
			var temp=0;
			vx.forEach($scope.BillInMesgList,function(item){
				if(item.tranAmount!=""&&item.tranAmount!=null){
					temp=temp+parseFloat(item.tranAmount);
				}
			});
			//已入账交易金额合计
			$scope.totalInAmount=temp;
		},function(data){
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			$scope.BillInMesgList="";
			$scope.totalInAmount=0;
			return data.jsonError;
		});
	};
	$scope.billOutMorepage = function(){
		$scope.start=1;//不是第一次进入
		var leg = $scope.BillOutList.length-1;
		var formData = {
				"CreditNo":$scope.creditCardNo,
				"tranYM":$scope.billOuttranYM,
				"turnPageFlag":"1",
				"bookingDate":$scope.BillOutList[leg].bookingDate,
				"purchaseDate":$scope.BillOutList[leg].purchaseDate,
				"purchaseTime":$scope.BillOutList[leg].purchaseTime,
				"serialNo":$scope.BillOutList[leg].serialNo
		};
		//已出账单近一个月明细
		$remote.post("/pmobile/CreditcardBillOut1.do",formData,function(data){
			$scope.BillOutMesgListMore=data.List;
			$scope.billOutTurnPageFlag = $scope.BillOutMesgListMore[0].turnPageFlag
			$scope.BillOutList=$scope.BillOutList.concat($scope.BillOutMesgListMore[0].List);
		},function(data){
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			$scope.BillOutList="";
			return data.jsonError;
		});
	};
}
</script>