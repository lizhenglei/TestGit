<div v-view-setup="AddAccountCtrl" v-init="init()">
	<div class="bg_box" v-page v-transition="native" title="新增账户">
		<div class="box_cont">
			<div class="zz_cont">
					<ul>
						<li>
							<em>账号：</em>
							<i>
								<input type="text" placeholder="请输入账号" name="rCard" v-model="rCard" ui-num='{"maxlength":22,"hasDot":false,"tip":"账号"}' class="y_srk" required/>
							</i>
						</li>
						<li>
							<em>别名：</em>
							<i>
								<input type="text" placeholder="非必输" name="Alias" v-model="Alias" class="y_srk" required maxlength="10"/>
							</i>
						</li>
						<!-- <li v-show="userType=='T'&&actype==0">
							<em>单笔限额：</em>
							<i>
								<input type="text" placeholder="非必输" name="accSingleLimit" v-model="accSingleLimit" class="y_srk" ui-num='{"maxlength":11,"hasDot":true}'/>
							</i>
						</li>
						<li v-show="userType=='T'&&actype==0">
							<em>日累计限额：</em>
							<i>
								<input type="text" placeholder="非必输" name="accDayLimit" v-model="accDayLimit" class="y_srk" ui-num='{"maxlength":11,"hasDot":true}'/>
							</i>
						</li> -->
						<li v-hide="selcAcc=='credit'||selcAcc=='creditFromMyCC'">
							<em>账户类型：</em>
							<i>
								<select v-model="actype" name="actype" >
									<option value="0">借记卡/存折</option>
									<option value="4">信用卡</option>
								</select>
							</i>
						</li>
						
					</ul>
			</div>
			
			<div class="zz_cont">
			      <ul>
						<li v-show="security=='07'&&userType=='T'&&actype==0">
							<em>卡密码：</em>
							<i><input  id="cardpassword" type="password" name="cardpassword" class="y_srk" value="" placeholder="请输入密码" v-click="getPW()" readonly/></i>
						</li>
						<li v-show="security=='07'&&userType=='T'&&actype==0">
							<em>手机动态码：</em>
							<i>
								<input type="tel" id="dycode" name="dycode" v-model="dycode" maxlength=6 class="y_srk_50" placeholder="请输入动态码"/>
								<button id="anniu" class="inp_butt" v-sms="getDYcode()">获取动态码</button>
							</i>
						</li>
						<li v-show="security=='05'&&userType=='T'&&actype==0">
							<em>音频Key密码：</em>
							<i><input type="password" name="keypassword" v-model="keypassword" class="y_srk" placeholder="请输入音频Key密码"/></i>
						</li>
				  </ul>
		     </div>
		    
		    <div class="zz_cont">
		     		<input type="submit"  class="button_1" name="Submit" v-show="security=='07'&&userType=='T'&&actype==0" v-disabled="!dycode||(buttonDis=='false')" value="确认" v-click="toResult()">
		     		<input type="submit"  class="button_1" name="Submit" v-show="security=='05'&&userType=='T'&&actype==0" v-disabled="!keypassword" value="确认" v-click="toResult()">
		     		<input type="submit"  class="button_1" name="Submit" v-show="userType!='T'||actype!=0" value="确认" v-click="toResult()">
		    </div>
		</div>
	</div>
	
	<div class="zz_cont"><img src="images/ts.png" />
		    <font class="tishi">
				温馨提示</br>
			</font>
				<div v-show="selcAcc!='credit'&&selcAcc!='creditFromMyCC'">&nbsp;&nbsp;1、仅可以添加本人的借记卡、存折、信用卡。</div>
				<div v-show="selcAcc=='credit'||selcAcc=='creditFromMyCC'">&nbsp;&nbsp;1、仅可以添加本人信用卡。</div>
				&nbsp;&nbsp;2、别名支持数字、英文、汉字等，最长10位。</br>
			<div style="font-size:12px; line-height:16px; color:#929292;"> </div>
	 </div>
	
</div>
<script>
AddAccountCtrl.$inject = ["$scope","$remote","$targets","$context"];
function AddAccountCtrl($scope,$remote,$targets,$context){
	$scope.init=function(){
		$scope.buttonDis="false";
		//其他页面选中信用卡的标志
		$scope.selcAcc=$context.getJson().selectedAcc;
		$scope.getClientState(function(response){
			var resJson=vx.fromJson(response);
			$scope.userType=resJson.Userinfo.UserType;
			if($scope.userType == "T"){
				//查询当前认证方式
				 $remote.post("/pmobile/ChannelAuthTypeQry.do",{},function(data){
					$scope.security=data.OldSecurity;
					//客户的限额
 					 $remote.post("/pmobile/ApproveTypeQry.do",{channelCode:"01",security:$scope.security},function(data){
 						$scope.bankSingleLimit=data.bankSingleLimit;
 						$scope.bankDaylimit=data.bankDaylimit;
 					}); 
				});
			}
		});
		if($scope.selcAcc=='credit'||$scope.selcAcc=="creditFromMyCC"){
			$scope.actype=4;
		}else{
			$scope.actype=0;
		}
		 $scope.accSingleLimit="999999999999.00";
		 $scope.accDayLimit="999999999999.00";
		 $scope.getMessageCode();
	}

	//调用密码控件
	$scope.getPW=function(){
		$("#cardpassword").val("");
		$scope.buttonDis="false";
		var scrollHeight=$scope.getPWPosition($("#cardpassword").get(0));//定位当前密码输入栏位在文档中的位置
		$scope.getPassword(function(pwResponse){
			var resJson=vx.fromJson(pwResponse);
			if(resJson.Flag==0){
				$("#cardpassword").val(resJson.passWord);
			}else if(resJson.Flag==1){
				$scope.miwen=resJson.passWord;
				$scope.buttonDis = resJson.buttonDis;
			}
		},scrollHeight);
	}
	$scope.getMessageCode=function(){
		$scope.getMseCode(function(pwResponse){
			$("#dycode").val(pwResponse);
			$scope.dycode=pwResponse;
		});
	}
	//倒计时的回调函数
	$scope.getDYcode=function(){
		$scope.getClientState(function(response){
		var resJson=vx.fromJson(response);
		var mobileNo=resJson.Userinfo.MobileNo;
		
		$scope.businessName="账户加挂";
		var params={
				"BusinessName":$scope.businessName,
				"MobileNo":mobileNo,
				"ServiceCode":"CUM001005"
		}
		//获取手机动态码
		$remote.post("/pmobile/GenTokenName.do",params,function(data){
			$scope.msmNo=data.SerialNo;
		});
	});
	}
	
	//专业版添加借记卡存折
	$scope.doIt=function(){
		$remote.post("/pmobile/AccountNoAddAll.do",$scope.params,function(data){
			$scope.alert("添加成功");
			NativeCall.goBack();
		},function(data){
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			$scope.keypassword="";
			$("#cardpassword").val("");
			$scope.miwen="";
			$scope.getToken();
			return data.jsonError;
		});
	}
	
	//增加账户
	$scope.toResult=function(){
		 $remote.post("/pmobile/getNewTokenName.do",{},function(data){
				$scope.tokenName=data._tokenName;
				
				if(!$scope.rCard){
					NativeCall.toast("账号不能为空");
					return false;
				}
				//别名不能为空
				if(!$scope.Alias){
					var temp=$scope.rCard;
					$scope.Alias=temp.substr(temp.length-5);
				}
				

				if(($scope.userType=="P"&&$scope.actype==0)||$scope.actype==4){//大众版用户添加借记卡存折、所有用户添加信用卡
					
					var params={
							"AcNo":$scope.rCard,
							"channelCode":"01",//00：个人网银，01：手机银行
							"accountAlias":$scope.Alias,
							"accountType":$scope.actype// 存折/借记卡-0;；信用卡-4  
					}
					$remote.post("/pmobile/AddAccount.do",params,function(data){
						//$timeout(function(){
							if($scope.selcAcc=="creditFromMyCC"){
								$context.setJson({"MyCardStatus":data.state});//保存新增信用卡的核心状态
								$scope.goto("MyCreditCard");
							}else{
								NativeCall.goBack();//跳转至我的账户（账户总览）
								$scope.alert("添加成功");
							}
							//NativeCall.goBack();
								
						//},500);
						
					});
				}
				else if($scope.userType=="T"&&$scope.actype==0){//专业版用户添加,并且是借记卡
					
				
					if($scope.security=="05"){//音频key
						
						//音频PKY制签名需要的数据
						var inputData={"accountNo":$scope.rCard,"accSingleLimit":$scope.accSingleLimit,"accDayLimit":$scope.accDayLimit,"accountType":$scope.actype};
						var sourceField = "签约账号#"+inputData.accountNo;
						//调用音频KEY字段转换xml格式的方法
						var sinData = $scope.getSignSourceValue(sourceField,"账号类型#"+inputData.accountType+"|单笔限额#"+inputData.accSingleLimit+"|日累计限额#"+inputData.accDayLimit);
						var subData={"sinData":sinData,"YPKPassword":$scope.keypassword};
						//通过原生调用音频key
						$scope.getSignData(function(outputdata){
							$scope.signData=outputdata;
							$scope.params={
									"AcNo":$scope.rCard,
									"channelCode":"01",//00：个人网银，01：手机银行
									"accountAlias":$scope.Alias,
									"accountType":$scope.actype,// 存折/借记卡-0;；信用卡-4  
	 								"accSingleLimit":$scope.accSingleLimit,//单笔限额
									"accDayLimit":$scope.accDayLimit,//日累计限额 
									"_tokenName":$scope.tokenName,
									"SignData":$scope.signData
							}
							$scope.doIt();
						},vx.toJson(subData));
						
					}		
					else if($scope.security=="07"){//手机动态码+卡密码
						//卡密码不能为空
// 						if($("#cardpassword").attr("value")==""){
// 							$scope.alert("卡密码不能为空");
// 							return false;
// 						}
						if(!$scope.dycode){
							NativeCall.toast("请输入手机动态码");
							return false;
						}
						$scope.params={
								"AcNo":$scope.rCard,
								"channelCode":"01",//00：个人网银，01：手机银行
								"accountAlias":$scope.Alias,
								"accountType":$scope.actype,// 存折/借记卡-0;；信用卡-4  
 								"accSingleLimit":$scope.accSingleLimit,//单笔限额
								"accDayLimit":$scope.accDayLimit,//日累计限额 
								"SmsCode":$scope.dycode,
								"TrsPassword":$scope.miwen,
								"SerialNo":$scope.msmNo,
								"_tokenName":$scope.tokenName
						}
						$scope.doIt();
					}
				}
				else{//其他情况用户添加失败
					$scope.alert("添加失败");
					$("#cardpassword").val("");
					$scope.miwen="";
					$scope.keypassword="";
				}
			});
	}
}
</script>