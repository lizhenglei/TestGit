<div v-view-setup="PChangeInfoCtrl" v-init="init()">
	<!-- 积分兑换明细查询页面 -->
	<div v-page v-transition="native" title="积分明细">
		<form name="OrderInput" class="bg_box">
			<div class="box_cont" v-show="queryDiv">
			<div class="zz_cont">
				
				<ul>
						<li><em>开始日期：</em><i style="padding-top:8px"><input type="date" name="beginDate" id="beginDate" placeholder="请选择开始日期" ui-calendar='{"maxView":3,"todayBtn":1,"minView":2,"autoclose": true,"format": "yyyy-mm-dd"}' v-model="beginDate"  style="height:20px;margin-top:10px" class="y_srk" readonly="readonly"></i></li>
						<li><em>结束日期：</em><i style="padding-top:8px"><input type="date" name="endDate" id="endDate" placeholder="请选择结束日期" ui-calendar='{"maxView":3,"todayBtn":1,"minView":2,"autoclose": true,"format": "yyyy-mm-dd"}' v-model="endDate" style="height:20px;margin-top:10px" class="y_srk" readonly="readonly"></i></li>
						<li><em>查询类型：</em>
						<i>
							<select name="type" id="type" class="y_srk" >
								<option value="0" selected="selected">转入</option>
								<option value="1" >转出</option>
								</select>
						</i></li>
				  </ul>
			</div>
			 <div class="zz_cont">
		     		<input type="submit"  class="button_1" name="Submit"  value="查询" v-click="query()">
		    </div>
			</div>
		</form>
		
		<div v-more-page="p in testList">
		<div class="khh" v-show="InResultDiv">
			     <div class="xiangq_img1"></div>
				  <ul>
				  	<li style="line-height:10px;float:left;">
				  		<em style="width:100%;color: red">+{{p.goldNum}}</em>
				  	</li>
				  	<li style="line-height: 20px;float:right;margin-right:5%">
					  	<i style="width:100%">{{p.gotDate|formatDate}}</i>
					</li>
					<li style="line-height:10px;float:left;">
						<em style="width:100%">{{p.businessName}}</em>
					</li>
				  </ul>
		 </div>
	
		<div class="khh" v-click="queryDetail(p)" v-show="OutResultDiv">
			     <div class="xiangq_img1"><a href="#"><img src="images/more.png"/></a></div>
				  <ul>
				  	<li style="line-height:10px;float:left;">
				  		<em style="width:100%;color: blue">-{{p.point}}</em>
				  	</li>
				  	<li style="line-height: 20px;float:right;margin-right:5%">
					  	<i style="width:100%">{{p.tranTime|formatDate}}</i>
					</li>
					<li style="line-height:10px;float:left;" v-show="p.toHostCustNo!=''">
						<em style="width:100%">转赠</em>
					</li>
				  	<li style="line-height:10px;float:left;" v-show="p.toHostCustNo==''">
						<em style="width:100%">兑换</em>
					</li>
				  </ul>
		 </div>
	</div>		
					<div >
			     		<input type="submit" id="nextButton"  class="button_1" name="Submit" value="查看更多" v-click="PAGE.moreNextPage()">
			     	</div>
	
	</div>
	
	<!-- 详情页面 -->
	<div v-page  v-transition="native">
		<div class="creditcard_box">
			<div class="box_cont">
			<div class="zz_cont">
				
				<ul>
						<li><em>对方手机号：</em><i>{{MobileNo}}</i></li>
						<li><em>对方用户名：</em><i>{{UserName}}</i></li>
						<li><em>交易数量：</em><i>{{ConvertNum}}</i></li>
				  </ul>
			</div>
			</div>
		</div>
	</div>
</div>
<script>
PChangeInfoCtrl.$inject = ["$scope","$remote","$targets","$filter","$context","$timeout","$window"];
function PChangeInfoCtrl($scope,$remote,$targets,$filter,$context,$timeout,$window){
	$scope.init=function(){
		$scope.queryDiv=true;
		//获取服务器当前时间
		$remote.post("/pmobile/GenTimeStamp.do",{},function(data){
			var serviceTime=data._sysDate;
			$scope.beginDate=$scope.formartDate(serviceTime,-7,"-");
			$scope.endDate=$scope.formartDate(serviceTime,0,"-");
		});
	}
	//查询结果
	$scope.query=function(){
		if($scope.endDate<$scope.beginDate){
			$scope.alert("结束日期不得小于开始日期!");
			return false;
		}else{
			$("#nextButton").css("display","none");
			$scope.getClientState(function(response){
				var resJson=vx.fromJson(response);
				$scope.HostCustNo = resJson.Userinfo.HexinKehuhao;
				$scope.UserName = resJson.Userinfo.CifName;
				$scope.MobilePhone = resJson.Userinfo.MobileNo;
			});
			var params={
					"HostCustNo":$scope.HostCustNo,
					"TranTime1":$scope.beginDate.replace(/-/g,"")+"000000",
					"TranTime2":$scope.endDate.replace(/-/g,"")+"595959",
					"PageCount":1,
					"IsCreateFile":"2",
					"JumpPages":"10",
					"IsAll":"2"
			};
			if($("#type").val()=="0"){
				$remote.post("/pmobile/LiJinCoinSourceQry.do",params,function(data){
					console.log(data);
					if(data._RejCode=="000000"){
						if(data.TotalCount=="0"){
							$scope.testList=[];
							$scope.InResultDiv=false;
							$scope.OutResultDiv=false;
							$scope.totalnumber = data.TotalCount;//总条数
							$scope.alert("查询无记录!");
						}else{
							$scope.testList=data.List;
							$scope.InResultDiv=true;
							$scope.OutResultDiv=false;
							$scope.totalnumber = data.TotalCount;//总条数
						}
					}
				},function(data){ 
					if(data.jsonError){
						$scope.alert(data.jsonError);
					}	
					$scope.testList=[];
					$scope.InResultDiv=false;
					$scope.OutResultDiv=false;
				});
			}else{
				$remote.post("/pmobile/LiJinCoinRecordQry.do",params,function(data){
					console.log(data);
					if(data._RejCode=="000000"){
						if(data.TotalCount=="0"){
							$scope.testList=[];
							$scope.InResultDiv=false;
							$scope.OutResultDiv=false;
							$scope.totalnumber = data.TotalCount;//总条数
							$scope.alert("查询无记录!");
						}else{
							$scope.testList=data.List;
							$scope.InResultDiv=false;
							$scope.OutResultDiv=true;
							$scope.totalnumber = data.TotalCount;//总条数
						}
					}
				},function(data){ 
					if(data.jsonError){
						$scope.alert(data.jsonError);
					}	
					$scope.testList=[];
					$scope.InResultDiv=false;
					$scope.OutResultDiv=false;
				});
			}
		}
	}
	
	$scope.morepage = function(qishi,zhongzhi,zengliang,list){
		$scope.start=1;//不是第一次进入
		$scope.getClientState(function(response){
			var resJson=vx.fromJson(response);
			$scope.HostCustNo = resJson.Userinfo.HexinKehuhao;
			$scope.UserName = resJson.Userinfo.CifName;
			$scope.MobilePhone = resJson.Userinfo.MobileNo;
		});
		var params={
				"HostCustNo":$scope.HostCustNo,
				"TranTime1":$scope.beginDate.replace(/-/g,"")+"000000",
				"TranTime2":$scope.endDate.replace(/-/g,"")+"595959",
				"PageCount":qishi/10+1,
				"IsCreateFile":"2",
				"JumpPages":"10",
				"IsAll":"2"
		};
		if($("#type").val()=="0"){
			$remote.post("/pmobile/LiJinCoinSourceQry.do",params,function(data){
				console.log(data);
				if(data._RejCode=="000000"){
					$scope.InResultDiv=true;
					$scope.OutResultDiv=false;
					$scope.testList=data.List;
				}
			},function(data){ 
				if(data.jsonError){
					$scope.alert(data.jsonError);
				}	
				$scope.testList=[];
			});
		}else{
			$remote.post("/pmobile/LiJinCoinRecordQry.do",params,function(data){
				console.log(data);
				if(data._RejCode=="000000"){
					$scope.InResultDiv=false;
					$scope.OutResultDiv=true;
					$scope.testList=data.List;
				}
			},function(data){ 
				if(data.jsonError){
					$scope.alert(data.jsonError);
				}	
				$scope.testList=[];
			});
		}
	};
	
	//跳转详情
	$scope.queryDetail=function(obj){
		$targets("content","#2");
		if(obj.toHostCustNo==""){
			$scope.MobileNo=obj.mobileNo;
			$scope.UserName=obj.custName;
		}else{
			$scope.MobileNo=obj.toMobile;
			$scope.UserName=obj.toCstName;
		}
		
		$scope.ConvertNum=obj.point;
	}
}
</script>