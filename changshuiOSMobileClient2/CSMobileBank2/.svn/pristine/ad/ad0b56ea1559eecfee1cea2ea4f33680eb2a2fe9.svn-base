<div v-view-setup="PNoCardOrderCtrl" v-init="init()">
	<!-- 无卡取款预约查询页面 -->
	<div v-page v-transition="native" title="现金取款">
		<form  name="transStatus" class="bg_box">
			<div class="box_cont">
				<div class="zz_cont">
					<ul>
						<li>
							<em>账号：</em>
							<i>
								<select  v-change="getCardInfo(AccNo)" v-model="AccNo" name="AccNo" v-options="ac.AcNo1 for ac in acList" >
								</select>
							</i>
						</li>
						<li>
							<em>预约状态：</em>
							<i>{{status==1?"已预约":"未预约"}}</i>
						</li>
						
					</ul>
				</div>
				<div class="zz_cont" v-show="status!=1">
					<input type="button" class="button_1" name="button" value="预约" v-disabled="!AccNo" v-click="toOrderInput()">
				</div>
				<div class="zz_cont" v-show="status==1">
					<input type="button" class="button_1" name="button" value="查询" v-disabled="!AccNo" v-click="toQueryDetail()">
				</div>
				<div class="zz_cont"><img src="images/ts.png" />
				    <font class="tishi">
						温馨提示</br>
					</font>
					<div style="font-size:12px; line-height:16px; color:#929292;">1、实际取款金额可以少于预约取款金额<br/>2、预约取款金额可以多于卡内余额
</div>
		    	</div>
			</div>
		</form>
	</div>
	
	<!-- 无卡取款预约详情 -->
	<div v-page v-transition="native" title="现金取款详情">
		<form  name="transDetail" class="bg_box">
			<div class="box_cont">
	
				<div class="zz_cont">
					<ul>
						<li>
							<em>预约时间：</em>
							<i>{{orderedCardInfo.ScheduleDate}}&nbsp;{{orderedCardInfo.ScheduleTime}}</i>
						</li>
						<li>
							<em >预约编号：</em>
							<i style="color:red;">{{orderedCardInfo.Seq}}</i>
						</li>
						<li>
							<em>预约账号：</em>
							<i>{{orderedCardInfo.PayerAcNo|accountNo}}</i>
						</li>
						<li>
							<em>预约手机号：</em>
							<i>{{orderedCardInfo.MobilePhone}}</i>
						</li>
						<li>
							<em>预约金额：</em>
							<i class="colff6">{{orderedCardInfo.Amount|number:2}}元</i>
						</li>
					</ul>
				</div>
				<div class="zz_cont">
					<input type="button" class="button_1" name="button" value="撤销" v-disabled="" v-click="toRescindOrder()">
				</div>
			</div>
		</form>
	</div>
	<!-- 无卡取款预约撤销确认 -->
	<div v-page v-transition="native" title="现金取款撤销">
		 <form name="transRescindConfirm" class="bg_box">
		    <div class="box_cont">
		      <div class="selected">
		        <span><img class="jindu" src="images/u1.png" /></span>
		         <span><img class="jindu" src="images/u2.png" /></span>
		          <span><img class="jindu" src="images/u3_1.png" /></span>
		      </div>
		      <div class="zz_cont">
			      <ul>
						<li><em>预约编号：</em><i>{{orderedCardInfo.Seq}}</i></li>
						<li><em>预约账号：</em><i>{{orderedCardInfo.PayerAcNo|accountNo}}</i></li>
						<li><em>预约手机号：</em><i>{{orderedCardInfo.MobilePhone}}</i></li>
						<li><em>预约金额：</em><i>{{orderedCardInfo.Amount|number:2}}</i></li>
						<li><em>预约时间：</em><i>{{orderedCardInfo.ScheduleDate}}&nbsp;{{orderedCardInfo.ScheduleTime}}</i></li>
				  </ul>
		       </div>
		        <div class="zz_cont">
			      <ul>
						<li>
							<em>验证码：</em>
							<i><input type="tel" name="imgcode" v-model="imgcode" class="y_srk" maxlength=4 placeholder="请输入验证码" style="width:50%"/></i>
							<img id="img" name="img" v-model="img" src="data:image/png;base64,{{TokenImg}}" data-ke-src="data:image/png;base64,{{TokenImg}}"  style="position:relative;left:40%;margin-top:3%" v-click="freshCode()">
<!-- 								<img id="img" name="img" v-model="img" src="/pmobile/GenTokenImg.do?r" style="position:relative;left:40%" v-click="freshCode('img')"> -->
						</li>
				  </ul>
		     	</div>
		     	<div>
		     		<input type="button"  class="button_1" name="button" v-disabled="!imgcode" value="确认" v-click="toRescindResult()">
		     	</div>
		 </div>
		 </form>
	</div>
	<!-- 卡取款预约撤销结果-->
	<div v-page v-transition="native" data-back="false" title="现金取款撤销">
		<div class="bg_box">
		    <div class="box_cont">
			      <div class="selected">
			        <span><img class="jindu" src="images/u1.png" /></span>
			        <span><img class="jindu" src="images/u2.png" /></span>
			        <span><img class="jindu" src="images/u3.png" /></span>
			      </div>
				  <div class="zz_cont">
				  	<div v-show="IsReward=='true'" class="maind" style="margin:0px">
						<div class="d1" style="float:left;padding-left:5px;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:left;width:50%;height:70px;  padding-top:9%;">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 撤销成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{orderAcInfo.ScheduleDate}}&nbsp;{{orderAcInfo.ScheduleTime|formatTime}}</div>
						</div>
						<div class="d3"  style="padding-top: 25px;float:left;width:20%;margin-left:-3%"><img  v-click="gotoRewardPage()" src="images/img_reward.gif" style="width:100px;height:60px;"/></div>
					</div>
					<div v-hide="IsReward=='true'">
						<div class="d1" style="float:left;padding-left:50px;;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:right;width:50%;height:70px;  padding-top:9%;padding-right:30px">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 撤销成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{orderAcInfo.ScheduleDate}}&nbsp;{{orderAcInfo.ScheduleTime|formatTime}}</div>
						</div>
					</div>
<!-- 				     <div class="cc_img" ><img src="images/cg_img.png" style="width:120px;height:120px" /><br/>撤销成功</div> -->
<!-- 				     <div class="transtime" style="padding-top:0px ;padding-bottom:10px;">{{orderAcInfo.ScheduleDate}}&nbsp;{{orderAcInfo.ScheduleTime|formatTime}}</div> -->
				  </div>
		 	</div>
 		</div>
	</div>
	<!-- 无卡取款预约录入 -->
	<div v-page v-transition="native" title="现金取款">
		 <form name="transInput" class="bg_box">
		    <div class="box_cont">
		      <div class="selected">
		        <span><img class="jindu" src="images/u1.png" /></span>
		         <span><img class="jindu" src="images/u2_1.png" /></span>
		          <span><img class="jindu" src="images/u3_1.png" /></span>
		      </div>
		      <div class="zz_cont">
			      <ul>
						<li><em>预约账号：</em><i>{{AccNo.AcNo1}}</i></li>
						<li><em>可用余额：</em><i>{{balance}}</i></li>
						<li><em>预约手机号：</em><i>{{mobilePhone}}</i></li>
						<li><em>预约金额：</em>
							<i class="colff6">
								<input type="text" placeholder="请输入预约金额" name="amount" v-model="amount"  ui-num='{"maxlength":11,"hasDot":true,"tip":"预约金额"}' class="y_srk" required>
							</i></li>
			            
				  </ul>
		       </div>
		     	<div>
		     		<input type="button"  class="button_1" name="button"  v-disabled="transInput.$invalid"  value="确认" v-click="toOrderConfirm(amount)">
		     	</div>
		 </div>
		 </form>		
		 <div class="zz_cont"><img src="images/ts.png" />
		    <font class="tishi">
				温馨提示</br>
			</font>
				&nbsp;&nbsp;1、预约金额必须在100-2000之间，且为100的整数倍。</br>
				&nbsp;&nbsp;2、预约记录有效期为24小时。</br>
				&nbsp;&nbsp;3、无卡取款金额可以选择等同或者小于预约金额。</br>
				&nbsp;&nbsp;4、预约成功后，无需携带粒金借记卡，仅需凭预约手机号及预约编号至我行任意自助设备即可进行无卡取款。</br>
				&nbsp;&nbsp;5、请在取款时确保卡内的余额足够。</br>
			  </div><div style="width:100%;height:40px;"></div>
	   </div> 
	</div>
	
	<!-- 无卡取款预约确认-->
	<div v-page v-transition="native" title="现金取款">
		 <form name="transConfirm" class="bg_box">
		    <div class="box_cont">
		      <div class="selected">
		        <span><img class="jindu" src="images/u1.png" /></span>
		         <span><img class="jindu" src="images/u2.png" /></span>
		          <span><img class="jindu" src="images/u3_1.png" /></span>
		      </div>
		      <div class="zz_cont">
			      <ul>
						<li><em>预约账号：</em><i>{{AccNo.AcNo1}}</i></li>
						<li><em>预约手机号：</em><i>{{mobilePhone}}</i></li>
						<li><em>预约金额：</em><i>{{amount|number:2}}</i></li>
				  </ul>
		       </div>
		       <div class="zz_cont">
			      <ul>
						<li>
							<em>验证码：</em>
							<i><input type="tel" name="imgcode" v-model="imgcode" class="y_srk" maxlength=4 placeholder="请输入验证码" style="width:50%"/></i>
							<img id="img" name="img" v-model="img" src="data:image/png;base64,{{TokenImg}}" data-ke-src="data:image/png;base64,{{TokenImg}}"  style="position:relative;left:40%;margin-top:3%" v-click="freshCode()">
<!-- 							<img id="img" name="img" v-model="img" src="/pmobile/GenTokenImg.do?r" style="position:relative;left:40%" v-click="freshCode('img')">  -->
						</li>
				  </ul>
		     	</div>
		     	<div>
		     		<input type="button"  class="button_1" name="button" v-disabled="!imgcode" value="确认" v-click="toOrderResult()">
		     	</div>
		 </div>
		 </form>
	</div>
	<!-- 无卡取款预约结果 -->
	<div v-page v-transition="native" data-back="false" title="现金取款">
		<div class="bg_box">
		    <div class="box_cont">
			      <div class="selected">
			        <span><img class="jindu" src="images/u1.png" /></span>
			        <span><img class="jindu" src="images/u2.png" /></span>
			        <span><img class="jindu" src="images/u3.png" /></span>
			      </div>
				  <div class="zz_cont">
				  <div v-show="IsReward=='true'" class="maind" style="margin:0px">
						<div class="d1" style="float:left;padding-left:5px;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:left;width:50%;height:70px;  padding-top:9%;">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 交易成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{orderAcInfo.ScheduleDate}}&nbsp;{{orderAcInfo.ScheduleTime}}</div>
						</div>
						<div class="d3"  style="padding-top: 25px;float:left;width:20%;margin-left:-3%"><img  v-click="gotoRewardPage()" src="images/img_reward.gif" style="width:100px;height:60px;"/></div>
					</div>
					<div v-hide="IsReward=='true'">
						<div class="d1" style="float:left;padding-left:50px;;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:right;width:50%;height:70px;  padding-top:9%;padding-right:30px">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 交易成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{orderAcInfo.ScheduleDate}}&nbsp;{{orderAcInfo.ScheduleTime}}</div>
						</div>
					</div>
<!-- 				     <div class="cc_img" ><img src="images/cg_img.png" style="width:120px;height:120px" /><br/>预约成功</div> -->
<!-- 				     <div class="transtime" style="padding-top:0px ;padding-bottom:10px;">{{orderAcInfo.ScheduleDate}}&nbsp;{{orderAcInfo.ScheduleTime}}</div> -->
				     <div class="resultForm">
						<ul>
							<li><em>预约编号：</em><i>{{orderAcInfo.Seq}}</i></li>
							<li><em>预约账号：</em><i>{{orderAcInfo.PayerAcNo|accountNo}}</i></li>
							<li><em>预约手机号：</em><i>{{orderAcInfo.MobilePhone}}</i></li>
							<li><em>预约金额：</em><i style="color:red">{{amount|number:2}}元</i></li>
				  		</ul>
				     </div>
				  </div>
		 	</div>
 		</div>
	</div>
</div>
<script>
PNoCardOrderCtrl.$inject = ["$scope","$remote","$targets","$filter","$context"];
function PNoCardOrderCtrl($scope,$remote,$targets,$filter,$context){
	$scope.init=function(){
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":"现金取款"},function(data){
			$scope.IsReward=data.ISREWARD;
			console.log($scope.IsReward);
		});
		$remote.post("/pmobile/ActListQry.do",{},function(data){
			//从借记卡和存折的列表中筛选出借记卡
			var temp=[];
			vx.forEach(data.AcList,function(item){
				if(item.AcType=="1"){
					temp.push(item);
				}
			});
			$scope.acList=temp;
			var filterFn=$filter("filter");
			$scope.acList=filterFn($scope.acList,function(obj,text){
				if(obj.AcNo != undefined){
					obj.AcNo1=obj.AcNo.substring(0,4)+"****"+ obj.AcNo.substring(obj.AcNo.length-4)
					if(obj.AcAlias.length>4){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias.substring(0,4)+"...";
					}else if(obj.AcAlias.length<=4&&obj.AcAlias.length>0){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias;
					}else{
						obj.AcNo1=obj.AcNo1;
					}
					return true;
				}
			});
			//用户手机号，即预约手机号
			$scope.mobilePhone=data.MobilePhone;
			$scope.AccNo=$scope.acList[0];
			$remote.post("/pmobile/DrawNoCardQry.do",{"PayerAcNo":$scope.acList[0].AcNo},function(data){
				$scope.status=data.status;
			},function(data){ 
				if(data.jsonError&&data.jsonError[0]){
					$scope.status=0;
				}
				return data.jsonError;
			});
		});
		
	}
	$scope.gotoRewardPage=function(){
		$context.clear();
		$scope.TransName="PNoCardOrder";
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":$scope.TransName},function(data){
			if(data.GAMETYPE=="0"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("LotteryDraw");
			}else if(data.GAMETYPE=="2"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("GuaGuaLe");
			}else if(data.GAMETYPE=="3"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("YaoYiYao");
			}
		});
	}
	//获取卡片已预约详情
	$scope.getCardInfo=function(acc){
		$remote.post("/pmobile/DrawNoCardQry.do",{"PayerAcNo":acc.AcNo},function(data){
			$scope.orderedCardInfo=data;
			$scope.status=data.status;
		},function(data){ 
			if(data.jsonError&&data.jsonError[0]){
				$scope.status=0;
			}
			return data.jsonError;
		});
	}
	//跳转到已预约详情页
	$scope.toQueryDetail=function(){
		$scope.getCardInfo($scope.AccNo);
		$targets("content","#2");
	}
	//跳转到预约撤销确认页面
	$scope.toRescindOrder=function(){
		//获取完成交易token防重复码
		$remote.post("/pmobile/getNewTokenName.do",{},function(data){
			if(data._RejCode=="000000"){
				$scope._tokenName=data._tokenName;
				$targets("content","#3");
				$scope.freshCode();
			}
		});
	}
	//跳转到预约撤销结果页面
	$scope.toRescindResult=function(){
		var params={
				"PayerAcNo":$scope.orderedCardInfo.PayerAcNo,
				"Amount":$scope.orderedCardInfo.Amount,
				"OperationType":2,
				"MobilePhone":$scope.orderedCardInfo.MobilePhone,
				"_tokenName":$scope._tokenName,
				"_vTokenName":$scope.imgcode,
				"Seq":$scope.orderedCardInfo.Seq
		};
		$remote.post("/pmobile/DrawNoCardMgmt.do",params,function(data){
			if(data._RejCode=="000000"){
				$scope.orderAcInfo=data;
				$scope._tokenName=data._tokenName;
				$targets("content","#4");
			}
		});
	}
	//跳转到无卡预约录入页面
	$scope.toOrderInput=function(){
		//查询余额
		$remote.post("/pmobile/ActBalQry.do",{"AcNo":$scope.AccNo.AcNo},function(data){
			$scope.balance=data.AvailBal;
		});
		$targets("content","#5");
	}
	//跳转到无卡预约确认页面
	$scope.toOrderConfirm=function(amount){
		if(parseFloat(amount)>2000){
			NativeCall.toast("预约取款金额最高为2000元");
			$scope.amount="";
		}else if(parseFloat(amount)<100||parseFloat(amount)%100!=0){
			NativeCall.toast("预约取款金额为100的倍数");
			$scope.amount="";
		}else{
			//获取完成交易token防重复码
			$remote.post("/pmobile/getNewTokenName.do",{},function(data){
				if(data._RejCode=="000000"){
					$scope._tokenName=data._tokenName;
					$targets("content","#6");
					$scope.freshCode();
				}
			});
		}
	}
	//刷新验证码
	$scope.freshCode=function(id){
		$remote.post("/pmobile/GenTokenImg.do?r"+Math.random(),{},function(data){
			$scope.TokenImg=data.imgKey;
		});
	}
	//跳转到无卡预约结果页面
	$scope.toOrderResult=function(){
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":"PNoCardOrder"},function(data){
			$scope.IsReward=data.ISREWARD;
		});
		var params={
				"PayerAcNo":$scope.AccNo.AcNo,
				"Amount":$scope.amount,
				"OperationType":0,
				"_vTokenName":$scope.imgcode,
				"MobilePhone":$scope.mobilePhone,
				"_tokenName":$scope._tokenName,
		};
		$remote.post("/pmobile/DrawNoCardMgmt.do",params,function(data){
			if(data._RejCode=="000000"){
				$scope.orderAcInfo=data;
				$scope._tokenName=data._tokenName;
				$targets("content","#7");
			}
		});
	}
	
}
</script>