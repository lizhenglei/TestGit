<div v-view-setup="OrderTransferCtrl" v-init="init()">
	<!-- 转账录入页面 -->
	<div v-page>
		<form  name="transInput" class="bg_box">
			<div class="box_cont">
	
				<div class="selected">
					<span><img class="jindu" src="images/u1.png" /></span> <span><img
						class="jindu" src="images/u2_1.png" /></span> <span><img class="jindu" src="images/u3_1.png" /></span>
				</div>
	
				<div class="zz_cont">
					<ul>
						<li>
							<em>付款账号：</em>
							<i>
								<select  v-change="getCardInfo()" v-model="payCard" name="payCard" v-options="ac.AcNo1 for ac in acList" >
								</select>
							</i>
						</li>
						<li>
							<em>账户余额：</em>
							<i class="colff6" >{{cardInfo.AvailBal}}元</i>
						</li>
						<li>
							<em>账户余额：</em>
							<i>{{cardInfo.CurrencyName}}</i>
						</li>
						<li>
							<em>转账类型：</em>
							<i> class="select"/>
								<select  v-model="transType" name="transType" v-options="tt.transName for tt in transTypeList" >
								</select>
							</i>
						</li>
					</ul>
				</div>
				<div class="zz_cont">
					<ul>
						<li>
							<em>收款人卡号：</em>
							<i>
								<input type="text" placeholder="请输入收款人账号" name="rCard" v-model="rCard" ui-num='{"maxlength":20,"hasDot":false,"tip":"收款卡号"}' class="y_srk" required/>
								<span><img src="images/skr_icon.png" /></span>
							</i>
						</li>
						<li>
							<em>收款人姓名：</em>
							<i class="colff6"> 
								<input type="text"  placeholder="请输入收款人姓名" name="rName" v-model="rName" class="y_srk" required/> 
							</i>
						</li>
						<li v-show="transType.transName=='跨行实时'">
							<em>收款人银行：</em>
							<i class="colff6">
								<input type="text"  placeholder="请输入收款人银行" name="rBank" v-model="rBank" class="y_srk">
								<span><img src="images/ss_icon.png" /></span>
							</i>
						</li>
						<li v-show="transType.transName=='跨行快速'">
							<em>收款开户行：</em>
							<i class="colff6">
								<input type="text"  placeholder="请输入开户行" name="rkBank" v-model="rkBank" class="y_srk">
								<span><img src="images/ss_icon.png" /></span>
							</i>
						</li>
						<li>
							<em>保存收款人：</em>
							<i class="colff6">
								<input type="checkbox" name="saveThis" v-model="saveThis" class="checkbox">
							</i>
						</li>
						<li>
							<em>转账金额：</em>
							<i class="colff6">
								<input type="text" placeholder="请输入转账金额" name="amount" v-model="amount"  ui-num='{"maxlength":11,"hasDot":true,"tip":"转账金额"}' class="y_srk" required>
							</i>
						</li>
						<li>
							<em>转账用途：</em>
							<i class="colff6">
							<input type="text" name="yongtu" v-model="yongtu" class="y_srk" value="转账">
							</i>
						</li>
						<li>
							<em>预约日期：</em>
							<i class="colff6">
							<input type="text" name="orderDate" v-model="orderDate" ui-calendar='{"startDate":"today","maxView":2,"todayBtn":1,"minView":2,"autoclose": true,"format": "yyyy-mm-dd"}' class="y_srk">
							</i>
						</li>
					</ul>
				</div>
				<div v-show="transType.transName=='跨行实时'">
					<input type="button" class="button_1" name="button" value="下一步" v-disabled="transInput.$invalid||!rBank" v-click="toConfirm()">
				</div>
				<div v-show="transType.transName=='跨行快速'">
					<input type="button" class="button_1" name="button" value="下一步" v-disabled="transInput.$invalid||!rkBank" v-click="toConfirm()">
				</div>
				<div v-show="transType.transName!='跨行快速'&&transType.transName!='跨行实时'" class="zz_cont">
					<input type="button" class="button_1" name="button" value="下一步" v-disabled="transInput.$invalid" v-click="toConfirm()">
				</div>
			</div>
		</form>
	</div>
	
	<!-- 转账确认页面 -->
	<div v-page>
		 <form name="transConfirm" class="bg_box">
		    <div class="box_cont">
		      <div class="selected">
		        <span><img class="jindu" src="images/u1.png" /></span>
		         <span><img class="jindu" src="images/u2.png" /></span>
		          <span><img class="jindu" src="images/u3_1.png" /></span>
		      </div>
		      <div class="zz_cont">
			      <ul>
						<li><em>付款账号：</em><i>{{payCard.AcNo1}}</i></li>
			            <li><em>收款人账号：</em><i>{{rCard|accountNo}}</i></li>
						<li><em>收款人姓名：</em><i>{{rName}}</i></li>
						<li v-show="transType.transName=='跨行实时'"><em>收款银行：</em><i>{{rBank}}</i></li>
			            <li v-show="transType.transName=='跨行快速'"><em>收款开户行：</em><i>{{rkBank}}</i></li>
						<li><em>转账金额：</em><i style="color:#ff6000;">{{amount|number:2}}元</i></li>
			            <li><em>金额大写：</em><i>{{amount|amount}}</i></li>
			            <li><em>转账用途：</em><i style="color:#ff6000;">{{yongtu}}</i></li>
			            <li><em>执行日期：</em>{{orderDate}}</i></li>
			            
				  </ul>
		       </div>
		       <div class="zz_cont">
			      <ul>
						<li>
							<em>卡密码：</em>
							<i><input type="password" ui-num='{"maxlength":6,"hasDot":false}' name="cardpassword" v-model="cardpassword" class="y_srk" placeholder="请输入密码" required/></i>
						</li>
						<li>
							<em>手机动态码：</em>
							<i>
								<input type="tel" name="dycode" v-model="dycode" maxlength=6 class="y_srk_50" placeholder="请输入动态码" required/>
								<button id="anniu" class="inp_butt" v-sms="getDYcode()">获取动态码</button>
							</i>
						</li>
				  </ul>
		     	</div>
		     	<div>
		     		<input type="submit"  class="button_1" name="Submit" v-disabled='transConfirm.$invalid' value="确认" v-click="toResult()">
		     	</div>
		 </div>
		 </form>
	</div>
	
	
	<!-- 转账结果页面 -->
	<div v-page v-transition="native" data-back="false">
		<div class="bg_box">
		    <div class="box_cont">
			      <div class="selected">
			        <span><img class="jindu" src="images/u1.png" /></span>
			        <span><img class="jindu" src="images/u2.png" /></span>
			        <span><img class="jindu" src="images/u3.png" /></span>
			      </div>
				  <div class="zz_cont">
				    <div v-show="IsReward=='true'" class="maind" style="margin:0px">
						<div class="d1" style="float:left;padding-left:5px;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:left;width:50%;height:70px;  padding-top:9%;">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 交易成功</div>
						</div>
<!-- 						<div class="d3"  style="padding-top: 25px;float:left;width:20%;margin-left:-3%"><img  v-click="gotoRewardPage()" src="images/img_reward.gif" style="width:100px;height:60px;"/></div> -->
					</div>
					<div v-hide="IsReward=='true'">
						<div class="d1" style="float:left;padding-left:50px;;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:right;width:50%;height:70px;  padding-top:9%;padding-right:30px">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 交易成功</div>
						</div>
					</div>
				     <div class="zz_cont">
						<ul>
							<li><em>预约时间：</em><i>{{orderDate}}</i></li>
							<li><em>付款人账号：</em><i>{{payCard.AcNo2|accountNo}}</i></li>
							<li><em>收款人账号：</em><i>{{rCard|accountNo}}</i></li>
							<li><em>收款人姓名：</em><i>{{rName}}</i></li>
							<li><em>转账方式：</em><i>{{transType.transName}}</i></li>
				            <li v-show="transType.transName=='跨行实时'"><em>收款银行：</em><i>{{rBank}}</i></li>
			            	<li v-show="transType.transName=='跨行快速'"><em>收款开户行：</em><i>{{rkBank}}</i></li>
							<li><em>交易金额：</em><i>{{amount|number:2}}元</i></li>
							<li><em>转账用途：</em><i>{{yongtu}}</i></li>
				  		</ul>
				     </div>
				  </div>
			      <div class="zz_cont">
			        <h5>您可以 <font style="color:#f18903;font-size:16px;" v-click="continueTrans()">继续转账</font>，也可以进行以下相关交易：</h5>
			      </div>
			      <div  class="jxzz_cont">
				         <ul>
				           <li><img src="images/hnzz_icon.png" /><br/>行内转账</li>
				           <li><img src="images/khzz_icn.png" /><br/>跨行转账</li>
				           <li><img src="images/dhhz_icon.png" /><br/>定活互转</li>
				           <li><img src="images/tzlc_icon.png"/><br/>投资理财</li>
				         </ul>
			        </div>
		 	</div>
 		</div>
	</div>
</div>
<script>
OrderTransferCtrl.$inject = ["$scope","$remote","$targets","$filter","$context"];
function OrderTransferCtrl($scope,$remote,$targets,$filter,$context){
	$scope.init=function(){
		$scope.transType="1";
		$scope.saveThis=true;
		$scope.yongtu="转账";
		var tdate=new Date();
		$scope.orderDate=$scope.getDate(tdate,1);
		$scope.today=$scope.getDate(tdate,0);
		
		//查询借记卡
		$remote.post("/pmobile/ActListQry.do",{},function(data){
			$scope.acList=data.AcList;
			var filterFn=$filter("filter");
			$scope.acList=filterFn($scope.acList,function(obj,text){
				if(obj.AcNo != undefined){
					obj.AcNo1=obj.AcNo.substring(0,4)+"****"+ obj.AcNo.substring(obj.AcNo.length-4)
					obj.AcNo2=obj.AcNo1;
					if(obj.AcAlias.length>4){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias.substring(0,4)+"...";
					}else if(obj.AcAlias.length<=4&&obj.AcAlias.length>0){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias;
					}else{
						obj.AcNo1=obj.AcNo1;
					}
					return true;
				}
			});
			$scope.payCard=$scope.acList[0];
			$scope.selfRCard=$scope.acList[0];
			//$scope.payCard.AcNo=$filter("accountNo")($scope.payCard.AcNo);
			$scope.getCardInfo();
		});
		
		//获取转账类型
		$remote.get("data/OrderTransfer/OrderTransfer.json", {}, function(data) {
			$scope.transTypeList=data;
			$scope.transType=data[0];
		});
	}
	//改变支付卡
	$scope.getCardInfo=function(){
		//var cardNo=$scope.payCard.AcNo;
		var cardNo="6223230011012881299";
		//查询余额
		$remote.post("/pmobile/ActBalQry.do",{"AcNo":cardNo},function(data){
			$scope.cardInfo=data;
			$scope.balance=data.AvailBal;
		});
	}
	//倒计时的回调函数
	$scope.getDYcode=function(){
		$scope.businessName="预约转账";
		var params={
				"BusinessName":$scope.businessName,
				"MobileNo":$scope.mobileNo,
				"ServiceCode":"DCA000010"
		}
		//获取手机动态码
		$remote.post("/pmobile/GenTokenName.do",params,function(data){
			$scope.msmNo=data.ECIPSerNo;
		});
	}
	//继续转账
	$scope.continueTrans=function(){
		$targets("content","#0");
	}
	//跳转到确认页面
	$scope.toConfirm=function(){
		$("#anniu").text("获取动态码");
		$("#anniu").css("background-color","#0084ff");
		var reg=new RegExp(/^[\u4E00-\u9FA5A-Za-z ]+$/);//姓名只能是中文字符或者英文字符
		if(!reg.test($scope.rName)){
			NativeCall.toast("姓名只能为汉字或字母");
			return false;
		}
		if($scope.transType.transName=='行内转账'){
			$scope.typeNum=0;
		}else if($scope.transType.transName=='银联'){
			
		}else if($scope.transType.transName=='跨行快速'){
			$scope.typeNum=9;
		}else if($scope.transType.transName=='跨行实时'){
			
		}
		var params={
				"TransType":$scope.typeNum,
				"Amount":$scope.amount,
				"PayerAcNo":$scope.payCard.AcNo
		}
		//获取手续费
		$remote.post("/pmobile/ChargeQry.do",params,function(data){
			if(data._RejCode=="000000"){
				$scope.poundage=data;
				$targets("content","#2");
			}
		});
	}
	//跳转到结果页
	$scope.toResult=function(){
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":"PLeYingBao"},function(data){
			$scope.IsReward=data.ISREWARD;
		});
		$remote.post("/pmobile/getNewTokenName.do",{},function(data){
			var params={
					"PayerAcNo":$scope.payCard.AcNo,
					"PayerAcName":$scope.cardInfo.AcName,
					"Amount":$scope.amount,
					"PayeeAcNo":$scope.rCard,
					"PayeeAcName":$scope.rName,
					"Currency":$scope.cardInfo.Currency,
					"PayeeBankNo":"",//收款银行号
					"PayeeBankName":"",//收款银行名称
					"Remark":$scope.yongtu,
					"IsSave":$scope.saveThis?1:0,
					"TransType":$scope.typeNum,
					"originalCharge":$scope.poundage.originalCharge,
					"actualCharge":$scope.poundage.actualCharge,
					"remittanceFee":$scope.poundage.remittanceFee,
					"businessKind":"",//业务类型
					"businessType":"",//业务种类
					"TrsPassword":$scope.cardpassword,
					"SerialNo":$scope.msmNo,
					"SmsCode":$scope.dycode,
					"_tokenName":data._tokenName,
					"AppointDate":$scope.orderDate
			};
			$remote.post("/pmobile/SchedulTransfer.do",params,function(data){
				if(data._RejCode=="000000"){
					$targets("content","#3");
				}
			});
		});
	}
}
</script>