//
//  PiontStoreViewController.m
//  MobileClient
//
//  Created by 李正雷 on 15/7/20.
//  Copyright (c) 2015年 pro. All rights reserved.
//

#import "PiontStoreViewController.h"

#import "CommonFunc.h"

#import "CSIIShareHandle.h"
#import <TencentOpenAPI/QQApi.h>
#import <TencentOpenAPI/QQApiInterfaceObject.h>
#import <TencentOpenAPI/QQApiInterface.h>

#import "CSIISinaAuthorViewController.h"
#import "CSIISinaContentController.h"

@interface PiontStoreViewController ()<UIWebViewDelegate,CSIIShareViewDelegate,ShareHandleTencentDelegate>
{
    UIWebView *webView;
    NSArray *_buttonArray;
}
@end

@implementation PiontStoreViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
   UIButton *rightButton = [UIButton buttonWithType:UIButtonTypeCustom];
    [rightButton setBackgroundImage:IMAGE(@"page_share") forState:UIControlStateNormal];
    [rightButton setBackgroundImage:IMAGE(@"page_share") forState:UIControlStateHighlighted];

    [rightButton addTarget:self action:@selector(rightButtonAction) forControlEvents:UIControlEventTouchUpInside];
    rightButton.frame = CGRectMake(280+22 ,5 ,80/2 ,80/2 );

    UIBarButtonItem *rightItem = [[UIBarButtonItem alloc] initWithCustomView:rightButton];
    self.navigationItem.rightBarButtonItem = rightItem;
    
    webView = [[UIWebView alloc]initWithFrame:CGRectMake(0, 0, self.view.bounds.size.width, self.view.bounds.size.height - 44 - 60-10)];
    webView.delegate= self;
    self.view.backgroundColor = [UIColor clearColor];
    NSString *urlString;
    
    urlString = self.webViewUrl;
    
//    if (self.adverWeb==YES) {
//        urlString = self.webViewUrl;
//    }
//    else{
//        if ([MobileBankSession sharedInstance].isLogin == YES) {
//            NSString *phoneNum = [[MobileBankSession sharedInstance].Userinfo objectForKey:@"MobileNo"];
//            NSData *data = [phoneNum dataUsingEncoding:NSUTF8StringEncoding];
//            NSString *base64String = [CommonFunc base64EncodedStringFrom:data];
//            NSString *md5KeyString = [NSString stringWithFormat:@"%@K74YQXF1RNDPSR5G0815X18H08733OID",phoneNum];
//            NSString *md5String = [CommonFunc md5:md5KeyString];
//            if ([self.webViewUrl rangeOfString:@"?"].length>0) {
//                urlString = [NSString stringWithFormat:@"%@&mobile=%@&crypt=%@",self.webViewUrl,base64String,md5String];
//            }else{
//                urlString = [NSString stringWithFormat:@"%@?mobile=%@&crypt=%@",self.webViewUrl,base64String,md5String];
//            }
//        }else{
//            urlString = self.webViewUrl;
//        }
//    }

    NSURL *url = [NSURL URLWithString:urlString];
//    self.webShareText = @"diany";
   NSURLRequest *request = [NSMutableURLRequest requestWithURL:url cachePolicy:0 timeoutInterval:15.0f];
//    request.cachePolicy = NSURLRequestReturnCacheDataElseLoad;
    [webView loadRequest:request];
    [self.view addSubview:webView];
    
    
//    NSString *dataString = [NSString stringWithContentsOfURL:url encoding:NSUTF8StringEncoding error:nil];
//    [webViewController loadHTMLString:dataString baseURL:nil];
    [[NSNotificationCenter defaultCenter]addObserver:self selector:@selector(getDataPhoneNum) name:@"_GetData" object:nil];
    [[NSNotificationCenter defaultCenter]addObserver:self selector:@selector(goBackToRoot) name:@"goBack2Bank" object:nil];

}
-(void)goBackToRoot
{
    [self.navigationController popViewControllerAnimated:YES];
}
-(void)getDataPhoneNum
{//9030230003553452
    NSMutableString *getPhoneNumStr=[[NSMutableString alloc]init];
    [getPhoneNumStr appendFormat:@"getDataFromIOS('%@')",[[MobileBankSession sharedInstance].Userinfo objectForKey:@"MobileNo"]];
    NSLog(@"手机号%@",getPhoneNumStr);
    [webView stringByEvaluatingJavaScriptFromString:getPhoneNumStr];
}
-(void)webViewDidStartLoad:(UIWebView *)webView
{
    [[MobileBankSession sharedInstance] showMask:nil maskMessage:@"请稍后..." maskType:Common];
}
-(void)webViewDidFinishLoad:(UIWebView *)webView
{
    [[MobileBankSession sharedInstance] hideMask];
}

-(void)webView:(UIWebView *)webView didFailLoadWithError:(NSError *)error
{
    if ([error code]==101) {
        return;
    }
    if([error code] == NSURLErrorCancelled){
        //一个页面没有被完全加载之前收到下一个请求，此时迅速会出现此error=-999
        //此时可能已经加载完成，则忽略此error，继续进行加载。
        return;
    }

    UIAlertView *alert = [[UIAlertView alloc]initWithTitle:@"提示" message:@"请求超时" delegate:self cancelButtonTitle:@"确认" otherButtonTitles:nil, nil];
    [alert show];
}
-(void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex
{
    if (buttonIndex==0) {
        [self.navigationController popViewControllerAnimated:YES];
    }
}
-(BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType{
    
    NSString *urlString = [[request URL]absoluteString];
    NSLog(@"########%@",urlString);
    if ([urlString rangeOfString:@"_GetData"].length>0) {//收单传手机号
        [[NSNotificationCenter defaultCenter] postNotificationName:@"_GetData" object:nil userInfo:nil];
        return NO;
    }
    if ([urlString rangeOfString:@"goBack2Bank"].length>0) {
//        NSArray *array = [urlString componentsSeparatedByString:@"goBack2Bank"];
        [[NSNotificationCenter defaultCenter]postNotificationName:@"goBack2Bank" object:nil userInfo:nil];
//        return NO;
    }
    return YES;
}
-(NSMutableDictionary *)getDicFromUrlstring:(NSString *)urlString
{
    NSMutableDictionary *dic = [[NSMutableDictionary alloc]init];
    NSArray *a = [urlString componentsSeparatedByString:@"?"];
    NSString *b = [a lastObject];
    NSArray *aa = [b componentsSeparatedByString:@"&"];
    for (int i=0; i<aa.count; i++) {
        NSArray *cc = [aa[i] componentsSeparatedByString:@"="];
        [dic setObject:cc[0] forKey:cc[1]];
    }
    return dic;
}
-(void)viewWillAppear:(BOOL)animated
{
    [super viewWillAppear:animated];
    NSString *titleName = nil;
    if (self.webViewName.length>8) {
        titleName = [self.webViewName substringToIndex:8];
        titleName = [titleName stringByAppendingString:@"..."];
    }else{
        titleName = self.webViewName;
    }
    ((UILabel *)[self.navigationController.navigationBar viewWithTag:99]).text = titleName;
}
-(void)viewWillDisappear:(BOOL)animated
{
    [super viewWillDisappear:YES];
    [webView removeFromSuperview];
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

+ (NSString *)base64StringFromTextDES:(NSString *)text//
{
    if (text && ![text isEqualToString:@""]) {
        
        NSString *key = @"CRCBBANK";
        
        NSData *data = [text dataUsingEncoding:NSUTF8StringEncoding];
        //IOS 自带DES加密 Begin
        data = [CommonFunc DESEncrypt:data WithKey:key];
        //IOS 自带DES加密 End
        return [CommonFunc base64EncodedStringFrom:data];
    }
    else {
        return @"";
    }
}


-(void)rightButtonAction
{
    NSLog(@"分享");
    NSDictionary *dict1 = [NSDictionary dictionaryWithObjectsAndKeys:
                           @"logout_weibo",@"img",
                           @"新浪微博",@"title",
                           @"0",@"flag",
                           @"sina",@"subtitle",
                           nil];
    NSDictionary *dict2 = [NSDictionary dictionaryWithObjectsAndKeys:
                           @"logout_weixin",@"img",
                           @"微信好友",@"title",
                           @"1",@"flag",
                           @"weixinFriend",@"subtitle",
                           nil];
    NSDictionary *dict3 = [NSDictionary dictionaryWithObjectsAndKeys:
                           @"logout_pengyouquan",@"img",
                           @"微信朋友圈",@"title",
                           @"2",@"flag",
                           @"weixinCircle",@"subtitle",
                           nil];
    NSDictionary *dict4 = [NSDictionary dictionaryWithObjectsAndKeys:
                           @"logout_qq",@"img",
                           @"腾讯QQ",@"title",
                           @"3",@"flag",
                           @"qq",@"subtitle",
                           nil];
    _buttonArray = [NSArray arrayWithObjects:dict1,dict2,dict3,dict4, nil];
    //初始化分享菜单，指定代理
    CSIIShareView *share = [CSIIShareView shareInstencesWithItems:_buttonArray];
    [CSIIShareView shareViewShow];
    share.delegate = self;
    
}


- (void)clickButton:(UIButton *)button withIndex:(NSInteger)index{
    //获取点击按钮的信息
    NSDictionary *dict = [_buttonArray objectAtIndex:index];
    NSLog(@"点击--->>>%@",[dict objectForKey:@"title"]);
    CSIIShareHandle *handle = [CSIIShareHandle ShareHandleInstance];
    if([[dict objectForKey:@"flag"] isEqualToString:@"0"]){
        //判断是否能用新浪客户端进行授权登录
        
        if([WeiboSDK isCanSSOInWeiboApp]){
            if(![CSIIShareHandle SinaWeiBoTokenIsInvalid]){
                CSIIShareHandle *handle = [CSIIShareHandle ShareHandleInstance];
                //新闻信息
                WBMessageObject *messageObj = [handle messageToSinaShareNews:@"indentifier1" andTitle:@"常熟农商银行" Description:self.webShareText ImgSmall:[UIImage imageNamed:@"shareimage.png"] Url:self.webShareUrl];
                //图文片信息
                //                WBMessageObject *messageObj = [handle messageToSinaShareWords:@"哈哈哈哈——————测试用得åå" andImg:[UIImage imageNamed:@"icon7"]];
                //文字信息
                //WBMessageObject *messageObj = [handle messageToSinaShareOnlyWords:@"仅仅是文字信息的发布。____测试。"];
                
                WBSendMessageToWeiboRequest *request = [WBSendMessageToWeiboRequest requestWithMessage:messageObj authInfo:nil access_token:handle.SinaWBToken];
                [WeiboSDK sendRequest:request];
                
            }else{
                //通过新浪客户端做授权操作
                [handle SinaWeiBoLogin:nil];
                //[self sinaFinishLogin];
                [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(sinaFinishLogin) name:@"sinaClietFinishLogin" object:nil];
            }
        }
        else{
            //如不支持客户端分享，将使用自定义分享
            CSIISinaContentController *content = [[CSIISinaContentController alloc] init];
            content.WebShareName = @"常熟农商银行";
            content.WebShareText = self.webShareText;
            content.WebShareUrl = self.webShareUrl;
            UINavigationController *nav = [[UINavigationController alloc] initWithRootViewController:content];
            [self presentViewController:nav animated:YES completion:nil];
            [CSIIShareView shareViewHide];
        }
        
    }else if ([[dict objectForKey:@"flag"] isEqualToString:@"1"]){
        if ([WXApi isWXAppInstalled] && [WXApi isWXAppSupportApi]){
            handle.WXScene = WXSceneSession;
            [handle messageToWeiXinNews:@"常熟农商银行" Description:self.webShareText content:nil Image:[UIImage imageNamed:@"shareimage.png"] URL:self.webShareUrl shareScene:WXSceneSession];
        }else{
            ShowAlertView(@"提示", @"您尚未安装微信客户端", nil, @"确认", nil);
        }
        
    }else if ([[dict objectForKey:@"flag"] isEqualToString:@"2"]){
        if ([WXApi isWXAppInstalled] && [WXApi isWXAppSupportApi]){
            handle.WXScene = WXSceneTimeline;
            [handle messageToWeiXinNews:@"常熟农商银行" Description:self.webShareText content:nil Image:[UIImage imageNamed:@"shareimage.png"] URL:self.webShareUrl shareScene:WXSceneTimeline];
        }else{
            ShowAlertView(@"提示", @"您尚未安装微信客户端", nil, @"确认", nil);
        }
    }else if ([[dict objectForKey:@"flag"] isEqualToString:@"3"]){
        if ([QQApi isQQInstalled]) {
            if(![CSIIShareHandle TencentTokenIsInvalid]){
                [self TencentLoginSuccess];
            }else{
                [self TencentLoginSuccess];
                //授权
                //handle.tencentDelegate = self;
                //[handle TencentLogin];//腾讯登陆
            }
            
        }else{
            ShowAlertView(@"提示", @"您尚未安装腾讯QQ客户端", nil, @"确认", nil);
        }
    }else if ([[dict objectForKey:@"flag"] isEqualToString:@"4"]){
        handle.WXScene = WXSceneTimeline;
        [handle showSMSPicker:self];
    }
}

#pragma mark - 使用新浪客户端登录授权的通知
- (void)sinaFinishLogin{
    [self performSelector:@selector(sendSinaMessage) withObject:nil afterDelay:1.5];
}

- (void)sendSinaMessage{
    CSIIShareHandle *handle = [CSIIShareHandle ShareHandleInstance];
    WBMessageObject *messageObj = [handle messageToSinaShareWords:@"常熟农商银行-" andImg:[UIImage imageNamed:@"sns_icon_1.png"]];
    //文字信息
    //WBMessageObject *messageObj = [handle messageToSinaShareOnlyWords:@"仅仅是文字信息的发布。____测试。"];
    WBSendMessageToWeiboRequest *request = [WBSendMessageToWeiboRequest requestWithMessage:messageObj authInfo:nil access_token:handle.SinaWBToken];
    [WeiboSDK sendRequest:request];
}

#pragma mark - QQ好友分享，实现回调方便在第一次授权之后自动跳转到分享界面
- (void)TencentLoginSuccess{
    UIImage *image = [UIImage imageNamed:@"shareimage"];
    NSData *imageData = UIImagePNGRepresentation(image);
    CSIIShareHandle *handle = [CSIIShareHandle ShareHandleInstance];
    [handle messageToTencentNews:@"常熟农商银行" Description:self.webShareText URL:self.webShareUrl PreviewImgData:imageData];
}

- (void)TencentNotNetWork{
    
}

- (void)TencentLoginFaield:(NSString *)errInfo{
    
}

- (void)TencentDidLogout{
    
}

@end
