<div v-view-setup="PLoanCtrl" v-init="init()">
	<div v-page v-transition="native" title="我要提款">
		<div  v-show="alist.length" class="zz_cont bor_1" style="border-radius: 8px" v-repeat="lis in alist">
			<div
				style="border-bottom: 1px solid #cccccc; font-size: initial; height: 24px; padding-left: 5px;">薪优贷</div>
			<ul style="position: relative">
				<li><em
					style="width: 40%; line-height: 30px; text-align: center">贷款账号：</em>
					<i style="width: 50%; line-height: 30px;"> {{lis.CrTfrDepCardNo}}
				</i></li>
				<li><em
					style="width: 40%; line-height: 30px; text-align: center">授信额度：</em>
					<i style="width: 50%; line-height: 30px;">
						{{lis.CtrAmt|number:2}} </i></li>
				<li><em
					style="width: 40%; line-height: 30px; text-align: center">可用额度：</em>
					<i style="width: 50%; line-height: 30px;">
						{{lis.CtrAvlBal|number:2}} </i></li>
				<li><em
					style="width: 40%; line-height: 30px; text-align: center">授信期限：</em>
					<i style="width: 50%; line-height: 30px;">
						{{lis.CtrBegDt}}~{{lis.CtrExpDt}}</i></li>
			</ul>
			<div>
				<div class="button_pd" v-click="cancleLJ(lis)">
					<img style="margin-top: -25px; margin-right: -8px;" class="cancel"
						src="images/daikuan.png">
				</div>
			</div>
			<div style="margin-bottom: -20px;">
				<input type="text" style="height: 0px; width: 98.6%; border: white"
					v-disabled="true">
			</div>
		</div>
		<div v-show="!alist.length" style="  margin-top: 45px;font-size: 15px">
			<ul>
				<li class="center">您还没有申请过贷款服务，快去申请吧！</li>
			</ul>
			<div style="  text-align: center;">
			     		<input  style="width:35%;border-radius:20px;height:25px;line-height:20px;" type="submit"  class="button_1" name="Submit" value="我要贷款" v-click="goSalarloan()"/>
			 </div>
		</div>
		
	</div>
	<div v-page v-transition="native" title="我要提款录入">
		<div class="zz_cont" style="background-color: white">
			<ul>
				<li><em>授信可用额度：</em><i>{{num.CtrAvlBal|number:2}}</i></li>
				<li><em>授信到期日：</em><i>{{num.CtrExpDt}}</i></li>
				<li><em>贷款账号：</em><i>{{num.CrTfrDepCardNo}}</i></li>
				<li><em>提款金额：</em><i><input type="text"
						placeholder="请输入提款金额" name="amount" v-model="amount" class="y_srk"></i></li>
				<li><em>大写金额：</em><i>{{amount|amount}}</i></li>
				<li><em>还款方式：</em><select class="sel1" id="sel1"
					style="margin-top: 10px;" v-model="sel1">
						<option value="">每月付息到期还本</option>
						<option value="1">等额本息</option>
				</select></li>
				<li><em>贷款用途：</em><select class="sel2" id="sel2"
					style="margin-top: 10px;" v-model="sel2">
						<option value="">购物</option>
						<option value="2">旅游</option>
						<option value="3">买车</option>
						<option value="4">教育</option>
						<option value="5">耐用消费品</option>
						<option value="6">其他消费</option>
				</select></li>
				<li><em>贷款期限：</em><select class="sel3" id="sel3"
					v-change="change()" style="margin-top: 10px;" v-model="sel3">
						<option value="9">3个月</option>
						<option value="7">6个月</option>
						<option value="8">9个月</option>
						<option value="">12个月</option>
				</select></li>
				<li><em>贷款到期日：</em><i>{{time}}</i></li>
				<li><em>委托扣款日：</em><i style="color: #ff6000;">每月20日</i></li>
				<li><em>月利率：</em><i style="color: #ff6000;">{{loan.ExecIntRate}}‰</i></li>
			</ul>
		</div>
		<div class="zz_cont" style="background-color: white">
			<input type="checkbox" name="agree" v-model="agree" /> 已阅读并同意<a
				style="color: blue" v-click="toXieYiPage()">《客户贷款用途承诺》</a>
			<div>
				<input type="submit" class="button_1" name="Submit" value="下一步"
					v-disabled="!agree" v-click="toconfirm()">
			</div>
		</div>
	</div>
	<div v-page v-transition="native" title="我要提款确认"
		style="background-color: white">
		<div class="zz_cont">
			<ul>
				<li><em>贷款账号：</em><i>{{num.CrTfrDepCardNo}}</i></li>
				<li><em>提款金额：</em><i>{{amount|number:2}}</i></li>
				<li><em>还款方式：</em><i>{{p}}</i></li>
				<li><em>贷款期限：</em><i style="color: #ff6000;">{{l}}个月</i></li>
				<li><em>贷款到期日：</em><i>{{time}}</i></li>
				<li><em>委托扣款日：</em><i style="color: #ff6000;">每月20日</i></li>
				<li><em>验证码：</em> <i> <input type="tel" id="imgcode"
						name="imgcode" maxlength=4 v-model="imgcode" class="y_srk"
						placeholder="请输入验证码" style="width: 50%;" />
				</i> 
				<img id="img" name="img" v-model="img"
					src="data:image/png;base64,{{TokenImg}}"
					data-ke-src="data:image/png;base64,{{TokenImg}}"
					style="position: relative; left: 40%; margin-top: 3%"
					v-click="freshCode()">
<!-- 					 					<img id="img" name="img" v-model="img" src="/pmobile/GenTokenImg.do"  style="position: relative; left: 40%; margin-top: 2%"  v-click="freshCode('img')"> -->
				</li>
			</ul>
		</div>
		<div class="zz_cont" style="background-color: white">
			<div>
				<input type="submit" class="button_1" name="Submit" value="确认"
					v-click="toresult()">
			</div>
		</div>
	</div>
	<div v-page v-transition="native" data-back="false" title="我要提款结果">
		<div class="bg_box">
			<div class="box_cont">
				<div class="selected">
					<span><img class="jindu" src="images/u1.png" /></span> <span><img
						class="jindu" src="images/u2.png" /></span> <span><img
						class="jindu" src="images/u3.png" /></span>
				</div>
				<div class="zz_cont">
					<div v-show="IsReward=='true'" class="maind" style="margin: 0px">
						<div class="d1"
							style="float: left; padding-left: 5px; width: 20%; padding-top: 20px">
							<img src="images/cg_img.png" style="width: 60px; height: 60px" />
						</div>
						<div class="d2"
							style="float: left; width: 50%; height: 70px; padding-top: 10%;">
							<div
								style="text-align: center; font-size: x-large; color: #0069c9">
								交易成功</div>
							<div class="transtime"
								style="padding-bottom: 0px; padding-top: 10px; font-size: inherit;">{{InnerResult.TransDate}}</div>
						</div>
												<div class="d3"
													style="padding-top: 25px; float: left; width: 20%; margin-left: -3%">
													<img v-click="gotoRewardPage()" src="images/img_reward.gif"
														style="width: 100px; height: 60px;" />
												</div>
					</div>
					<div v-hide="IsReward=='true'">
						<div class="d1"
							style="float: left; padding-left: 50px;; width: 20%; padding-top: 20px">
							<img src="images/cg_img.png" style="width: 60px; height: 60px" />
						</div>
						<div class="d2"
							style="float: right; width: 50%; height: 70px; padding-top: 10%; padding-right: 30px">
							<div
								style="text-align: center; font-size: x-large; color: #0069c9">
								交易成功</div>
							<div class="transtime"
								style="padding-bottom: 0px; padding-top: 10px; font-size: inherit;">{{time}}</div>
						</div>
					</div>
					<div class="resultForm">
						<ul>
<!-- 							<li><em>剩余可用额度：</em><i>{{ll.amount|number:2}}</i></li> -->
							<li><em>贷款账号：</em><i>{{ll.LoanAcctNo}}</i></li>
							<li><em>提款金额：</em><i style="width: 30%">{{amount|number:2}}</i>
								<buttom class="button_1"\
									style="width: 30%;  font-size: 1em;padding-left: 10px;padding-right: 10px;line-height: 38px;"
									v-click="gotoplan()">还款计划</buttom></li>
							<li><em>还款方式：</em><i>{{p}}</i></li>
							<li><em>贷款期限：</em><i>{{l}}个月</i></li>
							<li><em>贷款到期日：</em><i>{{time}}</i></li>
							<li><em>委托扣款日：</em><i>每月20日</i></li>
							<li><em>月利率：</em><i>{{loan.ExecIntRate}}‰</i></li>
						</ul>
					</div>
				</div>

			</div>
		</div>

		<div class="zz_cont">
			<div style="font-size: 12px; line-height: 16px; color: #929292;">
			</div>
		</div>
	</div>
	<div v-page v-transition="native" title="还款计划申请">
		<form name="form2" novalidate>
			<div class="container-fluid">
				<div v-repeat="item in plan">
					<div style="border-left: none; border-right: none;">
						<div
							style="float: left; width: 98.3%; border-width: 1px; border-style: ridge; border-color: #666; border-bottom: none; border: none">
							<div style="float: left">第{{item.repayterm}}期</div>
							<div style="float: left; color: #f18903">&nbsp;&nbsp;&nbsp;还款日&nbsp;{{item.repayintedate}}</div>
						</div>
						</br>
						<div
							style="float: left; width: 33%; border-width: 1px; border-style: ridge; border-color: #666; border-right: none">
							<div>应还本金</div>
							<div>{{item.termretprin | number:2}}元</div>
						</div>
						<div
							style="float: left; width: 32%; border: 1px ridge #666; border-right: none"">
							<div>应还利息</div>
							<div>{{item.termretint | number:2}}元</div>
						</div>
						<div style="float: left; width: 33%; border: 1px ridge #666">
							<div>本息合计</div>
							<div>{{item.total | number:2}}元</div>
						</div>

					</div>
				</div>
			</div>
		</form>
	</div>
		<div v-page v-transition="native" title="贷款协议">
		 <div class="bg_box">
		    <div class="box_cont">
			     	<div id="LYBFileId" style="width:100%;height:auto"></div>
			     <div>
			     	<input type="submit"  class="button_1" name="Submit" value="同意" v-click="backInputPage()">
			     </div>
		 	</div>
		 </div>
	</div>
</div>	
<script>
	PLoanCtrl.$inject = [ "$scope", "$remote", "$targets", "$filter",
			"$context" ];
	function PLoanCtrl($scope, $remote, $targets, $filter, $context) {
		$scope.init = function() {
			$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":"PLoan"},function(data){
				$scope.IsReward=data.ISREWARD;
				console.log($scope.IsReward);
			});
			$scope.flg=1;
			//获取当前系统时间
			$remote.post("/pmobile/GenTimeStamp.do", {}, function(data) {
				var serviceTime = data._sysDate;
				$scope.nowdate = $scope.formartDate(serviceTime, 0);
				$scope.betime=$scope.nowdate.substr(0, 4)+"-"+$scope.nowdate.substr(4, 2)+"-"+$scope.nowdate.substr(6, 2);
				$scope.time = parseFloat($scope.nowdate) + 10000 + "";
				$scope.yy = $scope.time.substr(0, 4);
				$scope.mm = $scope.time.substr(4, 2);
				$scope.dd = $scope.time.substr(6, 2);
				$scope.time = $scope.yy + "-" + $scope.mm + "-" + $scope.dd;
			});
			$scope.l = 12;
			$scope.getClientState(function(response){
				var resJson=vx.fromJson(response);
				$scope.ff=resJson.Userinfo.HexinKehuhao;
				$remote.post("/pmobile/CreditLoanQuery.do", {
					"CstNo" : $scope.ff,
// 					"CstNo" : "10000608951",
					"LoanVrty" : "110306"
				}, function(data) {
					$scope.flg=0;
					$scope.alist = data.List;
				});
			});
		}
		$scope.gotoRewardPage=function(){
			$context.clear();
			$scope.TransName="PLoan";
			$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":$scope.TransName},function(data){
				if(data.GAMETYPE=="0"){
					var param={
							"ReWardCount":data.REWARDCOUNT,
							"Count":data.COUNT,
							"GameType":data.GAMETYPE,
							"IsReward":data.ISREWARD,
							"TransName":data.TRANSNAME,
							"UpDateTime":data.UPDATETIME
					}
					$context.setJson({"innerParam":param});
					$scope.goto("LotteryDraw");
				}else if(data.GAMETYPE=="2"){
					var param={
							"ReWardCount":data.REWARDCOUNT,
							"Count":data.COUNT,
							"GameType":data.GAMETYPE,
							"IsReward":data.ISREWARD,
							"TransName":data.TRANSNAME,
							"UpDateTime":data.UPDATETIME
					}
					$context.setJson({"innerParam":param});
					$scope.goto("GuaGuaLe");
				}else if(data.GAMETYPE=="3"){
					var param={
							"ReWardCount":data.REWARDCOUNT,
							"Count":data.COUNT,
							"GameType":data.GAMETYPE,
							"IsReward":data.ISREWARD,
							"TransName":data.TRANSNAME,
							"UpDateTime":data.UPDATETIME
					}
					$context.setJson({"innerParam":param});
					$scope.goto("YaoYiYao");
				}
			});
		}
		$scope.cancleLJ = function(obj) {
			$context.setJson({
					"thing" : obj
			});
			$scope.num = $context.getJson().thing;
			$targets("content", "#2");
			$remote.post("/pmobile/LoansRateQuery.do", {
				"LoanVrty" : "110306",
				"CtrNo" : obj.CtrNo,
				"BegDt": $scope.betime,
				"ExpDt": $scope.time
			}, function(data) {
				$scope.loan = data;
			});
		}
		$scope.goSalarloan=function(){
			$scope.goto("Salaryloan");
		}
		$scope.change = function() {
			$scope.l;
			if ($("#sel3").val() == "") {
				$scope.l = 12;
			}
			if ($("#sel3").val() == "7") {
				$scope.l = 6;
			}
			if ($("#sel3").val() == "8") {
				$scope.l = 9;
			}
			if ($("#sel3").val() == "9") {
				$scope.l = 3;
			}
			$scope.yy = $scope.nowdate.substr(0, 4);
			$scope.mm = $scope.nowdate.substr(4, 2);
			$scope.dd = $scope.nowdate.substr(6, 2);
			if (parseFloat($scope.mm) + parseFloat($scope.l) > 12) {
				$scope.yy = parseFloat($scope.yy) + 1;
				$scope.mm = parseFloat($scope.mm) + parseFloat($scope.l) - 12;
				if($scope.mm<10){
					$scope.mm=0+""+$scope.mm;
				}
			}else{
				$scope.mm = parseFloat($scope.mm) + parseFloat($scope.l);
				if($scope.mm<10){
					$scope.mm=0+""+$scope.mm;
				}
			}
			if(($scope.yy%4==0 && $scope.yy%100!=0)||($scope.yy%100==0 && $scope.yy%400==0)){
				if($scope.mm==02){
					if($scope.dd>=29){
						$scope.dd=29;
					}
				}
			}else{
				if($scope.mm==02){
					if($scope.dd>=28){
						$scope.dd=28;
					}
				}
			}
			if($scope.mm==04||$scope.mm==06||$scope.mm==09||$scope.mm==11){
				if($scope.dd>=30){
					$scope.dd=30;
				}
			}
			$scope.time = $scope.yy + "-" + $scope.mm + "-" + $scope.dd;
			$remote.post("/pmobile/LoansRateQuery.do", {
				"LoanVrty" : "110306",
				"CtrNo" : $scope.alist.CtrNo,
				"BegDt": $scope.betime,
				"ExpDt": $scope.time
			}, function(data) {
				$scope.loan = data;
			});
// 			$remote.post("/pmobile/LoansRateQuery.do", {
// 				"LoanVrty" : "110306",
// 				"CtrNo" : $scope.alist.CtrNo,
// 				"BegDt": $scope.alist.CtrBegDt,
// 				"ExpDt": $scope.alist.CtrExpDt
// 			}, function(data) {
// 				$scope.loan = data;
// 			});
// 			if ($scope.alist.rateChgType == '2') {
// 				$scope.zheng = $scope.alist.zxRate;
// 				$scope.yu = $scope.alist.zxRate * 1.3;
// 			} else if ($scope.alist.rateChgType == '1') {
// 				$scope.zheng = $scope.loan.lnsRate
// 						* (1 + $scope.alist.floatRate);
// 				$scope.yu = $scope.zheng * 1.5;
// 			};
		}
		$scope.toconfirm = function() {
			if (parseFloat($scope.amount) < 5000) {
				NativeCall.toast("购买金额不能低于5000元");
				return false;
			}
			if (parseFloat($scope.amount) % 1000 != 0) {
				NativeCall.toast("累加金额应为1000的整数倍");
				return false;
			}
			$scope.imgcode = "";
			$scope.p;
			$scope.payf1;
			if ($("#sel1").val() == "") {
				$scope.p = "每月付息到期还本";
				$scope.payf1 = "A004";
			}
			if ($("#sel1").val() == "1") {
				$scope.p = "等额本息";
				$scope.payf1 = "A002";
			}
			$scope.yongtu;
			if ($("#sel2").val() == "") {
				$scope.yongtu = "购物";
			}
			if ($("#sel2").val() == "2") {
				$scope.yongtu = "旅游";
			}
			if ($("#sel2").val() == "3") {
				$scope.yongtu = "买车";
			}
			if ($("#sel2").val() == "4") {
				$scope.yongtu = "教育";
			}
			if ($("#sel2").val() == "5") {
				$scope.yongtu = "耐用消费品";
			}
			if ($("#sel2").val() == "6") {
				$scope.yongtu = "其他消费";
			}
			if (parseFloat($scope.num.CtrAvlBal) < parseFloat($scope.amount)) {
				$scope.alert("余额不足");
				return false;
			}
			var y = $scope.num.CtrExpDt.split("-")[0];
			var m = $scope.num.CtrExpDt.split("-")[1];
			var d = $scope.num.CtrExpDt.split("-")[2];
			if (parseFloat(m) + 3 > 12) {
				y = parseFloat(y) + 1;
				m = m - 9;
				m = "0" + m;
			} else {
				m=parseFloat(m) + 3
				if(m<10){
					m="0"+m;
				}
			}
			var h = y + "" + m + d;
			var yy = $scope.time.split("-")[0];
			var mm = $scope.time.split("-")[1];
			var dd = $scope.time.split("-")[2];
			var hh = yy + "" + mm + dd;
			if (parseFloat(hh) - parseFloat(h)>0) {
				$scope.alert("对不起，授信期限最多可延迟三个月，请重新选择贷款期限");
				return false;
			}
			var para = {
				"LoanVrty" : "110306",
				"AplyAmt" : $scope.amount,
				"CtrNo" : $scope.num.CtrNo
			}
			$remote.post("/pmobile/CreditOrganizationQuery.do", para, function(
					data) {
				if (_RejCode = "000000") {
					$targets("content", "#3");
					$scope.freshCode();
				}
			});
		}
		$scope.toresult = function() {
// 			if ($scope.l > 12) {
// 				if ($scope.alist.vouchStyle.substr(0, 1) == '4') {
// 					$scope.prdcode = '3303101'
// 				} else if ($scope.alist.vouchStyle.substr(0, 1) == '3') {
// 					$scope.prdcode = '3303102'
// 				} else if ($scope.alist.vouchStyle.substr(0, 1) == '1') {
// 					$scope.prdcode = '3303103'
// 				} else {
// 					$scope.prdcode = '3303104';
// 				}
// 			}
// 			;
// 			if ($scope.l <= 12) {
// 				if ($scope.alist.vouchStyle.substr(0, 1) == '4') {
// 					$scope.prdcode = '3301101'
// 				} else if ($scope.alist.vouchStyle.substr(0, 1) == '3') {
// 					$scope.prdcode = '3301102'
// 				} else if ($scope.alist.vouchStyle.substr(0, 1) == '1') {
// 					$scope.prdcode = '3301103'
// 				} else {
// 					$scope.prdcode = '3301104';
// 				}
// 			}
// 			;
			$scope.vtokenName = $scope.imgcode;
			if ($scope.alist.rateChgType == '2') {
				$scope.flo = (parseFloat($scope.zheng) - parseFloat($scope.loan.lnsRate)) * 100;
			}
			if ($scope.alist.rateChgType == '1') {
				$scope.flo = $scope.alist.floatRate;
			}
			var paras = {
				"CtrNo" : $scope.num.CtrNo,
				"IntAcrlMth" :"M",
				"LoanAmt" : $scope.amount,
				"ValDt" : $scope.betime,
				"LoanPpsDsc":$scope.yongtu,
				"ExpDt" : $scope.time,
				"CcyCd" : $scope.num.CcyCd,
				"ExecIntRate" : $scope.loan.ExecIntRate,
				"DsbrAcctNo" : $scope.num.CrTfrDepCardNo,
				"RepymtMd" : $scope.payf1,
				"_vTokenName" : $scope.vtokenName
			}
			$remote.post("/pmobile/OfferLoans.do", paras, function(data) {
				$scope.ll = data;
				var p={
						"accountNo" : $scope.ll.LoanAcctNo,
						"currentIndex" : "1",
						"pageSize" : "20",
						"branchId" : $scope.ll.SbjInstId
				}
				$targets("content", "#4");
				$remote.post("/pmobile/LoansRepaymentPlanQuery.do",p, function(data) {
					$scope.plan = data.List;
				});
			});
		}
		$scope.freshCode = function(id) {
			$remote.post("/pmobile/GenTokenImg.do?r" + Math.random(), {},
					function(data) {
						$scope.TokenImg = data.imgKey;
					});
		}
		$scope.gotoplan = function() {
			$targets("content", "#5");
		}
		$scope.toXieYiPage=function(){
			$remote.post("/pmobile/TreatyContent.do",{"TreatyType":"13"},function(data){
				document.getElementById("LYBFileId").innerHTML=data.Content;
				$targets("content","#6");
			});
		}
		$scope.backInputPage=function(){
			$scope.agree=true;
			$targets("content","#2");
		}
	}
</script>