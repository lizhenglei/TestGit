<div v-view-setup="PMyPrd2Ctrl" v-init="init()">
	<!-- 我的理财 -->
	<div  class="bg_box" v-page v-transition="native" title="我的理财">
		<div class="box_cont">
			<div class="zz_cont">
					<ul>
						<li>
							<em style="width:25%">卡号：</em>
							<i>
								<select  v-change="getAllList()" v-model="payCard" name="payCard" v-options="ac.AcNo1 for ac in acList" >
								</select>
							</i>
						</li>
					</ul>
			</div>
			<div  style="font-size:15px;text-align:center;padding-top:20px;" v-show="(cancleList&&cancleList.length==0)&&(noCancleCyList&&noCancleCyList.length==0)&&(atoneList&&atoneList.length==0)&&(applyCancleList&&applyCancleList.length==0)"><img src="images/caimi.png" style="width:60px;padding-right:10px;">很抱歉，未查询到信息</div>
			<div class="box_cont" style="font-size:14px;padding-top:5px;" v-show="(cancleList&&cancleList.length)||(noCancleCyList&&noCancleCyList.length)||(noCancleWtList&&noCancleWtList.length)>0">粒金理财</div>
			<!-- 当前持有不可撤销的粒金理财 -->
			<div class="zz_cont bor_1" v-repeat="ncl in noCancleCyList">
					<ul>
						<li>
							<em style="width: 40%;">产品名称：</em>
							<i style="width: 50%;">
								{{ncl.PrdctNm}}
							</i>
						</li>
						<li>
							<em style="width: 40%;">产品天数：</em>
							<i style="width: 50%;">
								{{ncl.CPTSDate}}天
							</i>
						</li>
						<li>
							<em style="width: 40%;">持有金额：</em>
							<i style="width: 50%;">
								{{ncl.FndPrdctLot|number:2}}
							</i>
						</li>
						<li style="border:none">
							<div class="jindu">
								<div class="jindu_top">
									<div class="w25" style="width:35%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div class="w25" style="width:30%">到期日<br/>{{ncl.ExpDt|formatDate}}</div><div class="w25">&nbsp;</div>
								</div>
								<div class="jindu_center">
									<div class="w25 c4242ff" style="width:35%"><img class="sjyuan" src="images/a1.png" /></div>
									<div class="w25 cccccc" style="width:30%"><img class="sjyuan" src="images/b2.png" /></div>
									<div class="w25 cccccc" style="width:35%"><img class="sjyuan" src="images/b3.png" /></div>
								</div>
								<div class="jindu_bottom">
									<div class="w25" style="width:35%">{{ncl.ValDt|formatDate}}<br/>产品成立日</div><div class="w25" style="width:30%">&nbsp;</div><div class="w25" style="width:35%">{{ncl.ZCDFDate|formatDate}}<br/>最迟兑付日</div>
								</div>
							</div>
						</li>
					</ul>
					<div >
						<input type="text" style="height:0px;width:98.6%;border:white" v-disabled="true">
					</div>
			</div>
			<!-- 可撤销的粒金理财 -->
			<div class="zz_cont bor_1" v-repeat="cl in cancleList">
					<ul style="position:relative">
						<li>
							<em style="width: 40%;">产品名称：</em>
							<i style="width: 50%;">
								{{cl.PrdctNm}}
							</i>
						</li>
						<li>
							<em style="width: 40%;">产品天数：</em>
							<i style="width: 50%;">
								{{cl.CPTSDate}}天
							</i>
						</li>
						<li>
							<em style="width: 40%;">持有金额：</em>
							<i style="width: 50%;">
								{{cl.OrigAplyAmt|number:2}}
							</i>
						</li>
						<li>
							<em style="width: 40%;">交易状态：</em>
							<i style="width: 50%;">
								{{cl.TxnStNm}}
							</i>
						</li>
						<li style="border:none">
							<div class="jindu">
								<div class="jindu_top">
									<div class="w25">购买日<br/>{{cl.OrigTxnDt|formatDate}}</div><div class="w25">&nbsp;</div><div class="w25">到期日<br/>{{cl.PrdctExpDt|formatDate}}</div><div class="w25">&nbsp;</div>
								</div>
								<div class="jindu_center">
									<div class="w25 c4242ff"><img class="sjyuan" src="images/a1.png" /></div>
									<div class="w25 cccccc"><img class="sjyuan" src="images/b2.png" /></div>
									<div class="w25 cccccc"><img class="sjyuan" src="images/b3.png" /></div>
									<div class="w25 cccccc"><img class="sjyuan" src="images/b4.png" /></div>
								</div>
								<div class="jindu_bottom">
									<div class="w25">&nbsp;</div><div class="w25">{{cl.FndPrdctDt|formatDate}}<br/>产品成立日</div><div class="w25">&nbsp;</div><div class="w25">{{cl.ZCDFDate|formatDate}}<br/>最迟兑付日</div>
								</div>
							</div>
						</li>
					</ul>
					<div >
						<div class="button_pd" v-show="cl.TxnSt=='0'||cl.TxnSt=='1'||cl.TxnSt=='E'||cl.TxnSt=='C'||cl.TxnSt=='P'" v-click="cancleLJ(cl)" ><img class="cancel" src="images/chexiao.png"></div>
					</div>
					<div>
						<input type="text" style="height:0px;width:98.6%;border:white" v-disabled="true">
					</div>
			</div>
			<div class="box_cont" style="font-size:14px;padding-top:5px;" v-show="(atoneList&&atoneList.length>0)||(applyCancleList&&applyCancleList.length>0)||(atoneCancleList&&atoneCancleList.length>0)">天天利</div>
			<!-- 天天利可赎回 -->
			<div class="zz_cont bor_1" v-repeat="al in atoneList">
					<ul>
						<li>
							<em style="width: 36%;">产品名称：</em>
							<i style="width: 54%;">
								{{al.PrdctNm}}
							</i>
						</li>
						<li>
							<em style="width: 36%;">持有金额：</em>
							<i style="width: 54%;">
								{{al.FndPrdctLot|number:2}}
							</i>
						</li>
					</ul>
					<div>
						<div class="button_pd" v-click="atoneTTL(al)"><img class="buyback" src="images/shuhui.png"></div>
						<div class="button_pd" style="margin-top: 52px;" v-click="profitTTL(al)"><input type="submit"  class="button_1" name="Submit" value="收益明细" ></div>
					</div>
					<div >
						<input type="text" style="margin:0px;padding:0px;height:0px;width:98.6%;border:white" v-disabled="true">
					</div>
			</div>
			
			<!-- 天天利申购撤销 -->
			<div class="zz_cont bor_1" v-repeat="apcl in applyCancleList">
					<ul>
						<li>
							<em style="width: 36%;">产品名称：</em>
							<i style="width: 54%;">
								{{apcl.PrdctNm}}
							</i>
						</li>
						<li>
							<em style="width: 36%;">交易金额：</em>
							<i style="width: 54%;">
								{{apcl.OrigAplyAmt|number:2}}
							</i>
						</li>
						<li>
							<em style="width: 36%;">交易状态：</em>
							<i style="width: 50%;">
								{{apcl.TxnStNm}}
							</i>
						</li>
						<li>
							<em style="width: 36%;">交易日期：</em>
							<i style="width: 50%;">
								{{apcl.TxnPhysTm|formatDate}}
							</i>
						</li>
					</ul>
					<div>
						<div class="button_pd" v-show="apcl.TxnSt=='0'||apcl.TxnSt=='1' ||apcl.TxnSt=='C'||apcl.TxnSt=='P'" v-click="cancleTTL(apcl,0)"><img class="cancel" src="images/chexiao.png"></div>
					</div>
					<div >
						<input type="text" style="height:0px;width:98.6%;border:white" v-disabled="true">
					</div>
			</div>
			<div class="box_cont" style="font-size:14px;padding-top:5px;" v-show="(jingzhiList&&jingzhiList.length>0)||(jingzhiCancleList&&jingzhiCancleList.length>0)">净值理财</div>
			<!-- 净值理财可赎回 -->
			<div class="zz_cont bor_1" v-repeat="jzcy in jingzhiList">
					<ul>
						<li>
							<em style="width: 36%;">产品名称：</em>
							<i style="width: 54%;">
								{{jzcy.PrdctNm}}
							</i>
						</li>
						<li>
							<em style="width: 36%;">购买金额：</em>
							<i style="width: 54%;">
								{{jzcy.FndPrdctLot|number:2}}
							</i>
						</li>
						<li>
							<em style="width: 36%;">可赎回金额：</em>
							<i style="width: 54%;">
								{{jzcy.FndPrdctLot|number:2}}
							</i>
						</li>
						<li style="border:none">
							<div class="jindu">
								<div class="jindu_top">
									<div class="w25" style="width:35%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div class="w25" style="width:30%">到期日<br/>{{jzcy.ExpDt|formatDate}}</div><div class="w25">&nbsp;</div>
								</div>
								<div class="jindu_center">
									<div class="w25 c4242ff" style="width:35%"><img class="sjyuan" src="images/a1.png" /></div>
									<div class="w25 cccccc" style="width:30%"><img class="sjyuan" src="images/b2.png" /></div>
									<div class="w25 cccccc" style="width:35%"><img class="sjyuan" src="images/b3.png" /></div>
								</div>
								<div class="jindu_bottom">
									<div class="w25" style="width:35%">{{jzcy.ValDt|formatDate}}<br/>产品成立日</div><div class="w25" style="width:30%">&nbsp;</div><div class="w25" style="width:35%">{{jzcy.ZCDFDate|formatDate}}<br/>最迟兑付日</div>
								</div>
							</div>
						</li>
					</ul>
					<div>
						<div class="button_pd" v-click="atoneJzlc(jzcy)"><img class="buyback" src="images/shuhui.png"></div>
						<div class="button_pd"  v-click="lsJingzhi(jzcx)" style="width: 35px;background-color: #f18903;font-size: 15px;color: white;margin-top: 77px;text-align: center;margin-right: 1px;">历史净值</div>
					</div>
					<div >
						<input type="text" style="margin:0px;padding:0px;height:0px;width:98.6%;border:white" v-disabled="true">
					</div>
			</div>
			
			<!-- 净值理财申购撤销 -->
			<div class="zz_cont bor_1" v-repeat="jzcx in jingzhiCancleList">
					<ul>
						<li>
							<em style="width: 36%;">产品名称：</em>
							<i style="width: 54%;">
								{{jzcx.PrdctNm}}
							</i>
						</li>
						<li>
							<em style="width: 36%;">购买金额：</em>
							<i style="width: 54%;">
								{{jzcx.OrigAplyAmt}}
							</i>
						</li>
						<li>
							<em style="width: 36%;">交易状态：</em>
							<i style="width: 50%;">
								{{jzcx.TxnStNm}}
							</i>
						</li>
						<li style="border:none">
							<div class="jindu">
								<div class="jindu_top">
									<div class="w25" style="width:35%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div class="w25" style="width:30%">到期日<br/>{{jzcx.PrdctExpDt|formatDate}}</div><div class="w25">&nbsp;</div>
								</div>
								<div class="jindu_center">
									<div class="w25 c4242ff" style="width:35%"><img class="sjyuan" src="images/a1.png" /></div>
									<div class="w25 cccccc" style="width:30%"><img class="sjyuan" src="images/b2.png" /></div>
									<div class="w25 cccccc" style="width:35%"><img class="sjyuan" src="images/b3.png" /></div>
								</div>
								<div class="jindu_bottom">
									<div class="w25" style="width:35%">{{jzcx.FndPrdctDt|formatDate}}<br/>产品成立日</div><div class="w25" style="width:30%">&nbsp;</div><div class="w25" style="width:35%">{{jzcx.ZCDFDate|formatDate}}<br/>最迟兑付日</div>
								</div>
							</div>
						</li>
					</ul>
					<div>
						<div class="button_pd"  v-show="jzcx.TxnSt=='0'||jzcx.TxnSt=='1'||jzcx.TxnSt=='E'||jzcx.TxnSt=='C'||jzcx.TxnSt=='P'" v-click="cancleJZLC(jzcx,0)"><img class="cancel" src="images/chexiao.png"></div>
						<div class="button_pd"  v-click="lsJingzhi(jzcx)" style="width: 35px;background-color: #f18903;font-size: 15px;color: white;margin-top: 77px;text-align: center;margin-right: 1px;">历史净值</div>
					</div>
					<div >
						<input type="text" style="height:0px;width:98.6%;border:white" v-disabled="true">
					</div>
			</div>
		</div>
		<div class="zz_cont"><img class="hint" src="images/ts.png" />
		    <font class="tishi">
				温馨提示</br>
			</font>
				&nbsp;&nbsp;您可以查询您持有的所有理财产品。 </br>
			<div style="font-size:12px; line-height:16px; color:#929292;"> </div>
	   </div>
	</div>
	<div style="width:100%;height:40px;"></div>
</div>
<script>
PMyPrd2Ctrl.$inject = ["$scope","$remote","$targets","$context","$filter"];
function PMyPrd2Ctrl($scope,$remote,$targets,$context,$filter){
	$scope.init=function(){
		//查询借记卡
		$remote.post("/pmobile/ActListQry.do",{},function(data){
			$scope.acList=data.AcList;
			var filterFn=$filter("filter");
			$scope.acList=filterFn($scope.acList,function(obj,text){
				if(obj.AcNo != undefined){
					obj.AcNo1=obj.AcNo.substring(0,4)+"****"+ obj.AcNo.substring(obj.AcNo.length-4);
					obj.AcNo2=obj.AcNo1;
					if(obj.AcAlias.length>4){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias.substring(0,4)+"...";
					}else if(obj.AcAlias.length<=4&&obj.AcAlias.length>0){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias;
					}else{
						obj.AcNo1=obj.AcNo1;
					}
					return true;
				}
			});
			$scope.payCard=$scope.acList[0];
			//获取当前购买的我的理财（粒金和天天利）
			$scope.getAllList();
		});
	}
	//我的理财数据（包括粒金理财不可撤销和可撤销、天天利理财可赎回和申购撤销列表）
	$scope.getAllList=function(){
		var params={
				"CstId":$scope.payCard.AcNo,
				"PrdctTplCd":'1102'
		}
		$remote.post("/pmobile/MyPrd.do",params,function(data){
			//当前委托粒金可以撤销的列表			
			$scope.cancleList=data.List2;
			//当前持有不可撤销列表
			$scope.noCancleCyList=data.List1;
		},function(data){
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			//清空数据
			$scope.noCancleCyList=[];
			$scope.noCancleWtList=[];
			$scope.cancleList=[];
			return data.jsonError;
		});
		//将参数设置为查询天天利的信息
		var params={
				"CstId":$scope.payCard.AcNo,
				"PrdctTplCd":'1200'
		}
		//查询天天利的信息
		$remote.post("/pmobile/MyPrd.do",params,function(data){
			$scope.atoneList=data.List1;//天天利可赎回列表
			$scope.applyCancleList=data.List2;//天天利申购撤销列表,其中dealFlag为1代表可撤销
		},function(data){
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			//清空数据
			$scope.atoneList=[];
			$scope.applyCancleList=[];
			return data.jsonError;
		});
		//将参数设置为查询净值理财的信息
		var params={
				"CstId":$scope.payCard.AcNo,
				"PrdctTplCd":'1300'
		}
		//查询净值理财的信息
		$remote.post("/pmobile/MyPrd.do",params,function(data){
			$scope.jingzhiList=data.List1;//净值理财可赎回列表
			$scope.jingzhiCancleList=data.List2;//净值理财申购撤销列表
		},function(data){
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			//清空数据
			$scope.jingzhiList=[];
			$scope.jingzhiCancleList=[];
			return data.jsonError;
		});
		if($scope.noCancleCyList==""&&$scope.cancleList==""&&$scope.atoneList==""&&$scope.applyCancleList==""){
			$scope.ShowIt = true;
		}
	}
	
	//撤销粒金理财
	$scope.cancleLJ=function(obj){
		$scope.confirm("您将撤销此产品！",function(){
			//获取完成交易token防重复码
			$remote.post("/pmobile/getNewTokenName.do",{},function(data){
				if(data._RejCode=="000000"){
					var pars={
							"AcNo":$scope.payCard.AcNo,
							"prdCode":obj.PrdctCd,
							"tranAmount":obj.OrigAplyAmt,
							"serialNo":obj.OrigTxnSeqNo,
							"_tokenName":data._tokenName
						};
					//查询当前粒金理财委托信息（可撤销）
					$remote.post("/pmobile/TestLJLCCancelInfo.do",pars,function(data){
						var temp=$scope.cancleList;
						vx.forEach(temp,function(item,index){
							if(item.OrigTxnSeqNo==obj.OrigTxnSeqNo){
								$scope.cancleList.splice(index,1);
							}
						})
						$scope.alert("撤销成功！");
						$scope.getAllList();
					});
				}
			});
		},null);
	}
	
	//撤销天天利
	$scope.cancleTTL=function(obj,flag){
		$scope.confirm("您将撤销此产品！",function(){
			//获取完成交易token防重复码
			$remote.post("/pmobile/getNewTokenName.do",{},function(data){
				if(data._RejCode=="000000"){
					var pars={
							"AcNo":$scope.payCard.AcNo,
							"prdCode":obj.PrdctCd,
							"tranAmount":obj.OrigAplyAmt,
							"serialNo":obj.OrigTxnSeqNo,
							"_tokenName":data._tokenName
						};
					//天天利撤销
					$remote.post("/pmobile/TestLJLCCancelInfo.do",pars,function(data){
						var temp=$scope.applyCancleList;
						vx.forEach(temp,function(item,index){
							if(item.OrigTxnSeqNo==obj.OrigTxnSeqNo){
								$scope.applyCancleList.splice(index,1);
								
							}
						})
						$scope.alert("撤销成功！");
						$scope.getAllList();
					});
				}
			});
		},null);
	}
	//撤销净值理财
	$scope.cancleJZLC=function(obj,flag){
		$scope.confirm("您将撤销此产品！",function(){
			//获取完成交易token防重复码
			$remote.post("/pmobile/getNewTokenName.do",{},function(data){
				if(data._RejCode=="000000"){
					var pars={
							"AcNo":$scope.payCard.AcNo,
							"prdCode":obj.PrdctCd,
							"tranAmount":obj.OrigAplyAmt,
							"serialNo":obj.OrigTxnSeqNo,
							"_tokenName":data._tokenName
						};
					//净值理财撤销
					$remote.post("/pmobile/TestLJLCCancelInfo.do",pars,function(data){
						var temp=$scope.jingzhiCancleList;
						vx.forEach(temp,function(item,index){
							if(item.OrigTxnSeqNo==obj.OrigTxnSeqNo){
								$scope.jingzhiCancleList.splice(index,1);
							}
						})
						$scope.alert("撤销成功！");
						$scope.getAllList();
					});
				}
			});
		},null);
	}
	
	//跳往天天利赎回页面
	$scope.atoneTTL=function(obj){
		obj.AcNo=$scope.payCard.AcNo1;
		$context.setJson({"selectedTTL":obj});
		$scope.goto("PMyPrd","TianTianLiRansom");
	}
	//跳往天天收益查询界面
	$scope.profitTTL=function(obj){
		obj.AcNo=$scope.payCard.AcNo1;
		$context.setJson({"selectedTTL":obj});
		$scope.goto("PMyPrd","TtlProfitQry");
	}
	
	//跳往净值理财赎回页面
	$scope.atoneJzlc=function(obj){
		obj.AcNo=$scope.payCard.AcNo1;
		$context.setJson({"selectedTTL":obj});
		$scope.goto("PMyPrd","JingZhiLiCaiRansom");
	}
	//跳往历史净值页面
	$scope.lsJingzhi=function(obj){
		obj.AcNo=$scope.payCard.AcNo1;
		$context.setJson({"selectedTTL":obj});
		$scope.goto("PMyPrd","");
	}
}
</script>