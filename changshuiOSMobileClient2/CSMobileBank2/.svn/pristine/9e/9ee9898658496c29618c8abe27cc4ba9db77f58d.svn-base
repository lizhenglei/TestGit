<div v-view-setup="PChangePointCtrl" v-init="init()">
	<!-- 积分兑换录入页面 -->
	<div v-page v-transition="native" title="积分兑换">
		<form name="orderInput" class="bg_box">
			<div class="box_cont">
				<div class="selected">
					<span> <img class="jindu" src="images/u1.png" />
					</span> <span> <img class="jindu" src="images/u2_1.png" />
					</span> <span> <img class="jindu" src="images/u3_1.png" />
					</span>
				</div>
				<div class="zz_cont">
				<ul id="detailInfo">
						<li><em>我的粒金币：</em><i>{{MyLiJinCoin}}</i></li>
						<li><em>手机号：</em><i><input type="text" id="MobileNo" name="MobileNo" v-model="MobileNo" class="y_srk" placeholder="请输入粒金商城手机号" v-focus="showInput()" ui-num='{"maxlength":11,"hasDot":false,"tip":"手机号"}'/></i></li>
						<li v-show="IsShow"><em>手机动态码：</em> <i>
								<input type="text" id="SmsCode" name="SmsCode" v-model="SmsCode"
								v-focus="windowScroll()" maxlength=6 class="y_srk_50"
								placeholder="请输入动态码" />
								<button class="inp_butt" v-sms="getDYcode()">获取动态码</button>
						</i></li>
						<li><em>兑换数量：</em><i><input type="text" id="ConvertNum" name="ConvertNum" v-model="ConvertNum" class="y_srk" placeholder="请输入兑换数量" ui-num='{"maxlength":10,"hasDot":true,"tip":"兑换数量"}'/></i></li>
				  </ul>
			</div>
			 <div class="zz_cont">
		     		<input type="submit"  class="button_1" name="Submit" v-disabled="!MobileNo || !ConvertNum" value="下一步" v-click="toConfirm()">
		    </div>
			</div>
		</form>
		
		<div id="LiJinDiv">
			<img src="images/u30.png"/><a href="#" style="color: blue" v-click="toLiJinShop()">什么是粒金商城？</a>
		</div>
	</div>

	<!-- 积分兑换确认页面 -->
	<div v-page v-transition="native" title="积分兑换">
		<form name="orderConfirm" class="bg_box">
			<div class="box_cont">
				<div class="selected">
					<span><img class="jindu" src="images/u1.png" /></span> <span><img
						class="jindu" src="images/u2.png" /></span> <span><img class="jindu" src="images/u3_1.png" /></span>
				</div>
				<div class="zz_cont">
					<ul>
							<li><em>手机号：</em><i>{{MobileNo}}</i></li>
							<li><em>兑换数量：</em><i>{{ConvertNum}}</i></li>
							<li><em>验证码：</em><i><input
								type="text" id="imgcode" name="imgcode" maxlength=4
								v-model="imgcode" class="y_srk"
								placeholder="请输入验证码" style="width: 50%" /></i> 
								<img id="img"
								name="img" v-model="img" src="data:image/png;base64,{{TokenImg}}"
								data-ke-src="data:image/png;base64,{{TokenImg}}"
								style="position:relative;left:40%;margin-top:3%" v-click="freshCode('img')"> 
<!-- 								<img id="img" name="img" v-model="img" src="/pmobile/GenTokenImg.do"  style="position:relative;left:40%;margin-top: 2%" v-click="freshCode('img')"> -->
							</li>
					</ul>
				</div>
				<div class="zz_cont">
		     		<input type="submit"  class="button_1" name="Submit" v-disabled="!imgcode" value="确认" v-click="toResult()">
		    	</div>
			</div>
		</form>
	</div>


	<!-- 积分兑换结果页面 -->
	<div v-page v-transition="native" data-back="false" title="积分兑换">
		<div class="bg_box">
			<div class="box_cont">
				<div class="selected">
					<span><img class="jindu" src="images/u1.png" /></span> <span><img
						class="jindu" src="images/u2.png" /></span> <span><img class="jindu" src="images/u3.png" /></span>
				</div>
				<div class="zz_cont">
					<div class="maind" style="margin:0px">
						<div class="d1" style="float:left;padding-left:45px;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:100%;height:100%"/></div>
						<div class="d2" style="float:left;width:50%;height:70px;  padding-top:9%;">
							 <div style="text-align: center;font-size:x-large;color:#0069c9">兑换成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{ConvertDate}}</div>
						</div>
					</div>
					<div class="resultForm">
						<ul>
							<li><em>可用粒金币：</em><i>{{LiJinCoin}}</i></li>
							<li><em>手机号：</em><i>{{MobileNo}}</i></li>
							<li><em>兑换数量：</em><i>{{ConvertNum}}</i></li>
						</ul>
					</div>
				</div>

			</div>
		</div>
		
		<div class="zz_cont">
			<div style="font-size: 12px; line-height: 16px; color: #929292;">
			</div>
		</div>
		
	</div>
	<!-- 粒金商城介绍 -->
	<div v-page v-transition="native">
		<div>
			<img id="LiJinId" src="images/lijin.jpg" height="100%" width="100%">
		</div>
	</div>	
	
</div>

	<!-- <div class="zz_cont"><img src="images/ts.png" />
	<font class="tishi">
				温馨提示</br>
	</font>
	<img style="background-color:#008de4;width:16px;margin-left:4px" src="images/feiyan.png" />，进入我的设置，可查询手机银行转账限额</br>
	</div> -->
<div style="width:100%;height:40px"></div>

<script>
PChangePointCtrl.$inject = ["$scope","$remote","$targets","$filter","$context","$timeout","$window"];
function PChangePointCtrl($scope,$remote,$targets,$filter,$context,$timeout,$window){
	$scope.init=function(){
		//获取粒金币
		$remote.post("/pmobile/LiJinCoinQry.do",{},function(data){
			if(data._RejCode="000000"){
				$scope.MyLiJinCoin = data.PointAvaile;
			}
		});
		
// 		$scope.MobileNo = "13467581201";
		$scope.getClientState(function(response){
			var resJson=vx.fromJson(response);
			$scope.MobileNo = resJson.Userinfo.MobileNo;
		});
		
	}
	//获取手机动态码
	$scope.getDYcode=function(){
		$scope.businessName="积分兑换";
		var params={
				"BusinessName":$scope.businessName,
				"MobileNo":$scope.MobileNo,
				"ServiceCode":"JFM000002"
		}
		
		$remote.post("/pmobile/GenTokenName.do",params,function(data){
			$scope.msmNo=data.SerialNo;
		});
	}
	
	$scope.toLiJinShop=function(){
		$targets("content","#4");
// 		$("#LiJinDiv").css("display","none");
	}
	
	$scope.showInput=function(){
		$scope.IsShow=true;
	}
	//刷新验证码
	$scope.freshCode=function(id){
		$remote.post("/pmobile/GenTokenImg.do?r"+Math.random(),{},function(data){
			$scope.TokenImg=data.imgKey;
		});
	}
	//跳转到确认页面
	$scope.toConfirm=function(){
		if(parseInt($scope.ConvertNum)>parseInt($scope.MyLiJinCoin)){
			$scope.alert("兑换数量应小于我的粒金币！");
			return false;
		}else{
			$scope.getClientState(function(response){
				var resJson=vx.fromJson(response);
				$scope.HostCustNo = resJson.Userinfo.HexinKehuhao;
				$scope.UserName = resJson.Userinfo.CifName;
			});
			var params={
					"HostCustNo":$scope.HostCustNo,
					"MobilePhone":$scope.MobileNo,
					"CustName":$scope.UserName,
					"PointTrans":$scope.ConvertNum,
					"Type":"1",
					"_vTokenName":$scope.imgcode
			};
			$remote.post("/pmobile/LiJinCoinChangeConfirm.do",params,function(data){
				console.log(data);
				$scope.freshCode("img");
// 				$("#LiJinDiv").css("display","none");
				$targets("content","#2");
			},function(data){ 
				if(data.jsonError){
					$scope.alert(data.jsonError);
				}	
			});
		}	
	}
	
	//跳转到结果页
	$scope.toResult=function(id){
		$scope.getClientState(function(response){
			var resJson=vx.fromJson(response);
			$scope.HostCustNo = resJson.Userinfo.HexinKehuhao;
			$scope.UserName = resJson.Userinfo.CifName;
		});
		var params={
				"HostCustNo":$scope.HostCustNo,
				"MobilePhone":$scope.MobileNo,
				"CustName":$scope.UserName,
				"PointTrans":$scope.ConvertNum,
				"Type":"1",
				"_vTokenName":$scope.imgcode
		};
		$remote.post("/pmobile/LiJinCoinChange.do",params,function(data){
			console.log(data);
			if(data._RejCode=="000000"){
				$scope.LiJinCoin = parseInt($scope.MyLiJinCoin)-parseInt($scope.ConvertNum);
				$scope.ConvertDate=data.TransDate;
// 				$("#LiJinDiv").css("display","none");
				$targets("content","#3");
			}
		},function(data){ 
			if(data.jsonError){
				if(data.jsonError=="要查询的记录不存在"){
					$scope.alert("该用户不是手机银行用户!");
				}
// 				$scope.alert(data.jsonError);
			}	
		});
	}
	
}
</script>