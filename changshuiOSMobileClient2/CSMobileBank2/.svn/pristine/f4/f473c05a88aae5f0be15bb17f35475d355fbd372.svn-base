<div v-view-setup="PINeedCashCtrl" v-init="init()">
	<!-- 我要现金录入页面 -->
	<div v-page v-transition="native" title="我要现金">
		<form  name="transInput" class="bg_box">
			<div class="box_cont">
	
				<div class="selected">
					<span><img class="jindu" src="images/u1.png" /></span> <span><img
						class="jindu" src="images/u2_1.png" /></span> <span><img class="jindu" src="images/u3_1.png" /></span>
				</div>
	 
				<div class="zz_cont">
					<ul>
						<li>
							<em>信用卡：</em>
							<i>
								<select  v-change="getCardInfo()" v-model="creditCard" name="creditCard" v-options="cc.creditCardNo for cc in ccardList" >
								</select>
							</i>
						</li>
						<li>
							<em>预借现金额度：</em>
							<i class="colff6">{{caseUseLimit}}</i>
						</li>
						<li>
							<em>借记卡：</em>
							<i>
								<select  v-model="debitCard" name="debitCard" v-options="dc.AcNo for dc in dcardList" >
								</select>
							</i>
						</li>
						<li>
							<em>我要现金：</em>
							<i class="colff6">
								<input type="text" placeholder="请输入金额" name="amount" v-change="amountChange()" v-model="amount"  ui-num='{"maxlength":11,"hasDot":true,"tip":"我要现金"}' class="y_srk" required>
							</i>
						</li>
						<li>
							<em>手续费：</em>
							<i style="color:red">
								0元
							</i>
						</li>
					</ul>
				</div>
				<div class="zz_cont">
					<input type="button" class="button_1" name="button" value="确认" id="conbtn" disabled="conbtn" v-click="toConfirm()">
				</div>
				<div class="zz_cont"><img src="images/ts.png" />
				    <font class="tishi">
						温馨提示</br>
					</font>
						&nbsp;&nbsp;1、我要现金目前只支持转入同名借记卡，尚不支持转入他行卡。</br>
						&nbsp;&nbsp;2、您可通过跨行转账将提取的现金转入他行卡。 </br>
					<div style="font-size:12px; line-height:16px; color:#929292;"> </div>
		    	</div>
			</div>
		</form>
	</div>
	
	<!-- 我要现金确认页面 -->
	<div v-page v-transition="native" title="我要现金">
		 <form name="transConfirm" class="bg_box">
		    <div class="box_cont">
		      <div class="selected">
		        <span><img class="jindu" src="images/u1.png" /></span>
		         <span><img class="jindu" src="images/u2.png" /></span>
		          <span><img class="jindu" src="images/u3_1.png" /></span>
		      </div>
		      <div class="zz_cont">
			      <ul>
						<li><em>信用卡：</em><i>{{creditCard.creditCardNo|accountNo}}</i></li>
						<li><em>借记卡：</em><i>{{debitCard.AcNo|accountNo}}</i></li>
						<li><em>我要现金：</em><i>{{amount|number:2}}</i></li>
			            <li><em>手续费：</em><i style="color:red">0元</i></li>
				  </ul>
		       </div>
		       <div class="zz_cont">
		       		<ul>
		       			<li><em>交易密码：</em>
							<i><input  id="cardpassword" type="password" name="cardpassword" class="y_srk" placeholder="请输入信用卡交易密码" v-click="getPW()" readonly/></i>
						</li>
		       		</ul>
		       </div>
		     	<div>
		     		<input type="submit"  class="button_1" name="Submit" id="subbtn" disabled="buttonDis" value="确认" v-click="toResult()">
		     	</div>
		 </div>
		 </form>
	</div>
	
	
	<!-- 我要现金结果页面 -->
	<div v-page v-transition="native" data-back="false" title="我要现金">
		<div class="bg_box">
		    <div class="box_cont">
			      <div class="selected">
			        <span><img class="jindu" src="images/u1.png" /></span>
			        <span><img class="jindu" src="images/u2.png" /></span>
			        <span><img class="jindu" src="images/u3.png" /></span>
			      </div>
				  <div class="zz_cont">
				    <div v-show="IsReward=='true'" class="maind" style="margin:0px">
						<div class="d1" style="float:left;padding-left:5px;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:left;width:50%;height:70px;  padding-top:9%;">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 交易成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{transDate|formatDate}}&nbsp;{{transTime|formatTime}}</div>
						</div>
						<div class="d3"  style="padding-top: 25px;float:left;width:20%;margin-left:-3%"><img  v-click="gotoRewardPage()" src="images/img_reward.gif" style="width:100px;height:60px;"/></div>
					</div>
					<div v-hide="IsReward=='true'">
						<div class="d1" style="float:left;padding-left:50px;;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:right;width:50%;height:70px;  padding-top:9%;padding-right:30px">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 交易成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{transDate|formatDate}}&nbsp;{{transTime|formatTime}}</div>
						</div>
					</div>
				     <div class="resultForm">
						<ul>
							<li><em>信用卡号：</em><i>{{creditCard.creditCardNo|accountNo}}</i></li>
							<li><em>借记卡号：</em><i>{{debitCard.AcNo|accountNo}}</i></li>
							<li><em>我要现金：</em><i style="color:red">{{amount|number:2}}元</i></li>
							<li><em>手续费：</em><i style="color:red">0元</i></li>
				  		</ul>
				     </div>
				  </div>
		 	</div>
 		</div>
	</div>
</div>
<script>
PINeedCashCtrl.$inject = ["$scope","$remote","$targets","$filter","$context"];
function PINeedCashCtrl($scope,$remote,$targets,$filter,$context){
	$scope.init=function(){
		$remote.post("/pmobile/ActListQry.do",{},function(data){
			$scope.aList=data.List;
			$scope.buttonDis= true;
			$scope.conbtn= true;
			//获取借记卡账号
			$scope.dcardList=data.AcList;
			//获取户名
			$scope.cifName=data.CifName;
			//获取信用卡账号列表
			$scope.ccardList=data.CreditList;
			if($scope.ccardList.length==0){
				$scope.alert("无信用卡加挂信息或卡片未激活");
				NativeCall.goBack();
			}else{
				$scope.creditCard=$scope.ccardList[0];
				$scope.getCardInfo();
				$scope.debitCard=$scope.dcardList[0];
			}
		});
		
	}
	$scope.amountChange = function(){
		if(!$scope.amount){
			NativeCall.toast("金额为空");
			$scope.conbtn = true;
			$("#conbtn").attr("disabled",$scope.conbtn);
			return;
		}
		if($scope.amount){
			var pos=$scope.amount.toString().indexOf(".");
		}else{
			var pos=$scope.amount
		}
		if(pos>-1&&$scope.amount.length-pos>3){
			NativeCall.toast("金额格式有误，小数点后只能有两位小数");
			$scope.conbtn = true;
			$("#conbtn").attr("disabled",$scope.conbtn);
			
		}else if(!$scope.creditCard){
			NativeCall.toast("无信用卡");
			$scope.conbtn = true;
			$("#conbtn").attr("disabled",$scope.conbtn);
		}else{
			$scope.conbtn = false;
			$("#conbtn").attr("disabled",$scope.conbtn);
		}
	}
	//调用密码控件
	$scope.getPW=function(){
		$("#cardpassword").val("");
		$scope.buttonDis=true;
		$("#subbtn").attr("disabled",$scope.buttonDis);
		var scrollHeight=$scope.getPWPosition($("#cardpassword").get(0));//定位当前密码输入栏位在文档中的位置
		$scope.getPassword(function(pwResponse){
			var resJson=vx.fromJson(pwResponse);
			if(resJson.Flag==0){
				$("#cardpassword").val(resJson.passWord);
			}else if(resJson.Flag==1){
				$scope.miwen=resJson.passWord;
				$scope.buttonDis1 = resJson.buttonDis;
				if($scope.buttonDis1=="true"){
					$scope.buttonDis = false;
					$("#subbtn").attr("disabled",$scope.buttonDis);
				}
			}
		},scrollHeight);
	}
	//获取信用卡基本信息
	$scope.getCardInfo=function(){
		$remote.post("/pmobile/CreditcardBasicInfo.do",{"CreditNo":$scope.creditCard.creditCardNo},function(data){
			//获取我要现金可用额度
			$scope.caseUseLimit=data.caUseLimit;
		});
	}
	//跳转到抽奖页面
	$scope.gotoRewardPage=function(){
		$context.clear();
		$scope.TransName="预借现金";
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":$scope.TransName},function(data){
			if(data.GAMETYPE=="0"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("LotteryDraw");
			}else if(data.GAMETYPE=="2"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("GuaGuaLe");
			}else if(data.GAMETYPE=="3"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("YaoYiYao");
			}
		});
	}
	//跳转到确认页面
	$scope.toConfirm=function(){
		if(!$scope.creditCard||!vx.isDefined($scope.creditCard)){
			NativeCall.toast("无加挂信用卡号!");
			return;
		}
		if(!$scope.debitCard||!vx.isDefined($scope.debitCard)){
			NativeCall.toast("无加挂借记卡号！");
			return;
		}
		if(parseFloat($scope.amount)>parseFloat($scope.caseUseLimit)){
			NativeCall.toast("输入金额超过我要现金额度");
			$scope.amount="";
		}else{
			//获取完成交易token防重复码
			$remote.post("/pmobile/getNewTokenName.do",{},function(data){
				if(data._RejCode=="000000"){
					$scope._tokenName=data._tokenName;
					$targets("content","#2");
				}
			});
		}
	}
	//跳转到结果页面
	$scope.toResult=function(id){
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":"预借现金"},function(data){
			$scope.IsReward=data.ISREWARD;
		});
		var params={
				"AcNo":$scope.debitCard.AcNo,
				"tranAmount":$scope.amount,
				"CreditNo":$scope.creditCard.creditCardNo,
				"accountName":$scope.cifName,
				"CashTrsPassword":$scope.miwen,
				"_tokenName":$scope._tokenName
		};
		$remote.post("/pmobile/CreditcardRemarkAmount.do",params,function(data){
			if(data._RejCode=="000000"){
				$scope.transDate=data.TransDate;
				$scope.transTime=data.TransTime;
				$targets("content","#3"); 
			}
		},function(data){
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			$("#cardpassword").val("");
			$scope.miwen="";
			$scope.getToken();
			return data.jsonError;
		});
	}
	
}
</script>