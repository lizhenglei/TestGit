<div v-view-setup="PhonePayCtrl" v-init="init()">
	<!--1 手机充值录入-->
	<div v-page v-transition="native" title="手机充值">
		<div class="bg_box">
			<div class="box_cont">
				<div class="zz_cont">
					<ul>
						<li>
							<em>手机号：</em>
							<i>
								<input v-model="PhonePayNo" id="PhonePayNo"  name="PhonePayNo" v-change="PhonePayNoChange()" maxlength="11" placeholder="请输入手机号码" class="y_srk" required >
								</input>
								<span v-click="queryiPhone()"><img src="images/skr_icon.png" /></span>
							</i>
							<span v-show="PhoneInfo.flag==0" style="color:red;margin-bottom:0px;">暂不支持该用户充值</span>
							<span v-show="PhoneInfo.flag==1" style="color:red;margin-bottom:0px;">该手机用户为移动用户</span>
							<span v-show="PhoneInfo.flag==2" style="color:red;margin-bottom:0px;">该手机用户为联通用户</span>
							<span v-show="PhoneInfo.flag==3" style="color:red;margin-bottom:0px;">该手机用户为电信用户</span>
						</li>
						<li v-show = "VShow">
							<em>付款账号：</em>
							<i>
								<select v-model="AcNo" name="AcNo" v-change="getCardInfo()" v-options="tl.AcNo1 for tl in AcNoList" >
								</select>
							</i>
						</li>
						<li v-show = "VShow">
							<em>可用余额：</em>
							<i class="colff6" ui-money='{"amounts":"balance"}'></i>
						</li>
						<li v-show = "VShow">
							<em>充值金额：</em>
							<i>
								<select v-model="PayAmount" name="PayAmount"
								 v-options="tl.Name for tl in PayAmountList" >
								</select>
							</i>
						</li>
					</ul>
					<div>
			     		<input  type="submit"  class="button_1" name="Submit" value="确认" v-disabled="PhoneInfo.flag==0" v-click="toConfirm()"/>
			     	</div>
			    </div>
			</div>
		</div>
	</div>
	<!--手机充值确认-->
	<div v-page v-transition="native">
		<div class="bg_box">
			<div class="box_cont">
				<div class="zz_cont">
					<ul>
						<li>
							<em>手机号：</em>
							<i>
								{{PhonePayNo}}
							</i>
						</li>
						<li>
							<em>付款账号：</em>
							<i>
								{{AcNo.AcNo1}}
							</i>
						</li>
						<li> 
							<em>充值金额：</em>
							<i>
								{{PayAmount.Name}}
							</i>
						</li>
					</ul>
					
					
			    </div>
			    <div class="zz_cont">
			   	 	<ul>
						<li><em>手机动态码：</em> <i>
								<input type="tel" id="dycode" name="dycode" v-model="dycode"
								v-focus="windowScroll()" maxlength="6" class="y_srk_50"
								placeholder="请输入动态码" />
								<button id="anniu" class="inp_butt" v-sms="getDYcode()">获取动态码</button>
						</i></li>
				  	</ul>
		     	</div>
		     	<div>
			     	<input  type="submit"  class="button_1" name="Submit" value="充值" v-disabled="!dycode" v-click="doIt()"/>
			     </div>
			</div>
		</div>
	</div>
	<!--5手机充值结果 -->
	<div v-page v-transition="native" data-back="false">
 		<div class="bg_box">
			<div class="box_cont">
				<div class="selected">
					<span><img class="jindu" src="images/u1.png" /></span> <span><img
						class="jindu" src="images/u2.png" /></span> <span><img class="jindu" src="images/u3.png" /></span>
				</div>
				<div class="zz_cont">
					<div v-show="IsReward=='true'" class="maind" style="margin:0px">
						<div class="d1" style="float:left;padding-left:5px;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:left;width:50%;height:70px;  padding-top:9%;">
							<div style="  text-align: center;font-size:x-large;color:#0069c9"> 交易成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{Result.TransDate}}</div>
						</div>
<!-- 					<div class="d3"  style="padding-top: 25px;float:left;width:20%;margin-left:-3%"><img  v-click="gotoRewardPage()" src="images/img_reward.gif" style="width:100px;height:60px;"/></div> -->
					</div>
					<div v-hide="IsReward=='true'">
						<div class="d1" style="float:left;padding-left:50px;;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:right;width:50%;height:70px;  padding-top:9%;padding-right:30px">
							<div style="  text-align: center;font-size:x-large;color:#0069c9"> 交易成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{Result.TransDate}}</div>
						</div>
					</div>
					<div class="resultForm">
						<ul>
							<li><em>付款账号：</em><i>{{AcNo.AcNo1}}</i></li>
							<li><em>手机号：</em><i>{{PhonePayNo}}</i></li>
 						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
PhonePayCtrl.$inject = ["$scope","$remote","$targets","$context","$filter"];
function PhonePayCtrl($scope,$remote,$targets,$context,$filter){
	$scope.init=function(){
		$scope.VShow = false;
		$scope.PayAmountList=[{
			"Name":"50元",
			"Code":"50" 
		},{
			"Name":"100元",
			"Code":"100" 
		},{
			"Name":"300元",
			"Code":"300" 
		},{
			"Name":"500元",
			"Code":"500"
		}];
		$remote.post("/pmobile/ActListQry.do",{},function(data){
			var temp=[];
			vx.forEach(data.AcList,function(item){
				if(item.AcType=="1"){
					temp.push(item);
				}
			});
			$scope.AcNoList=temp;
			var filterFn=$filter("filter");
			$scope.AcNoList=filterFn($scope.AcNoList,function(obj,text){
				if(obj.AcNo != undefined){
					obj.AcNo1=obj.AcNo.substring(0,4)+"****"+ obj.AcNo.substring(obj.AcNo.length-4)
					if(obj.AcAlias.length>4){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias.substring(0,4)+"...";
					}else if(obj.AcAlias.length<=4&&obj.AcAlias.length>0){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias;
					}else{
						obj.AcNo1=obj.AcNo1;
					}
					return true;
				}
			});
			$scope.mobileNo=data.MobilePhone;
			$scope.AcNo = $scope.AcNoList[0];
			$scope.getCardInfo();
		});
	}
	$scope.PhonePayNoChange = function(){
		console.log($scope.PhonePayNo.length);
		if($scope.PhonePayNo.length==11){
			$scope.queryPhoneInfo();
			$scope.VShow = true;
		}else{
			$scope.VShow = false;
		}
	}
	//查询通讯录
	$scope.queryiPhone=function(){
		$scope.getPhoneNumber(function(data){
			var resJson=vx.fromJson(data);
			$("#PhonePayNo").val(resJson.PhoneNumber);
			$scope.PhonePayNo=resJson.PhoneNumber;
			$scope.PhonePayNoChange();
		});
	}
	//查询手机号信息
	$scope.queryPhoneInfo = function(){
		var param={
				"mobileNo":$scope.PhonePayNo
		}
		$remote.post("/pmobile/queryPhoneInfo.do",param,function(data){
			$scope.PhoneInfo = data;
			if($scope.PhoneInfo.flag==1){
				$scope.PayAmountList=[
// 				                      {
// 					"Name":"10元",
// 					"Code":"10" 
// 				},{
// 					"Name":"20元",
// 					"Code":"20" 
// 				},{
// 					"Name":"30元",
// 					"Code":"30" 
// 				},
				{
					"Name":"50元",
					"Code":"50" 
				},{
					"Name":"100元",
					"Code":"100" 
				},{
					"Name":"300元",
					"Code":"300" 
				},{
					"Name":"500元",
					"Code":"500"
				}];
			}else{
				$scope.PayAmountList=[{
					"Name":"50元",
					"Code":"50" 
				},{
					"Name":"100元",
					"Code":"100" 
				},{
					"Name":"300元",
					"Code":"300" 
				},{
					"Name":"500元",
					"Code":"500"
				}];
			}
			$scope.PayAmount=$scope.PayAmountList[0];
		});
	}
	//倒计时的回调函数
	$scope.getDYcode=function(){
		$scope.businessName="手机充值";
		var params={
				"BusinessName":$scope.businessName,
				"MobileNo":$scope.mobileNo,
				"ServiceCode":"PFA007001"
		}
		//获取手机动态码
		$remote.post("/pmobile/GenTokenName.do",params,function(data){
			$scope.msmNo=data.SerialNo;
			$scope.getMessageCode();//启动监听手机动态码
		});
	}
	//获取手机动态码
	$scope.getMessageCode=function(){
		$scope.getMseCode(function(pwResponse){
			$("#dycode").val(pwResponse);
			$scope.dycode=pwResponse;
		});
	}
	//详细页面跳转
	$scope.toConfirm = function(){
		$scope.dycode="";
		$("#anniu").text("获取动态码");
		$("#anniu").css("background-color","#0084ff");
		if($scope.PhoneInfo.flag==1){
			$scope.BussinessCode="755060304";
		}else if($scope.PhoneInfo.flag==2){
			$scope.BussinessCode="755060303";
		}else if($scope.PhoneInfo.flag==3){
			$scope.BussinessCode="755060302";
		}
		if(parseFloat($scope.PayAmount.Code)>parseFloat($scope.balance)){
			NativeCall.toast("卡内余额不足！");
			return;
		}
		var param={
				"businessType":$scope.BussinessCode,
// 				"businessType":"755060303",
				"recordNo":$scope.PhonePayNo,
				"PayPhoneNo":$scope.PayPhoneNo,
				"accountNo":$scope.AcNo.AcNo,
				"payAmount":$scope.PayAmount.Code,
				"tranAmount":$scope.PayAmount.Code
		}
		$remote.post("/pmobile/PhonePayConfirm.do",{},function(data){
			$scope.PayConfirm = data;
			$targets("content","#2");
			$scope.freshCode('img');
		});
		
	}
	
	$scope.getCardInfo=function(){
		var cardNo=$scope.AcNo.AcNo;
		//查询余额
		$remote.post("/pmobile/ActBalQry.do",{"AcNo":cardNo},function(data){
			$scope.cardInfo=data;
			$scope.balance=data.AvailBal;
		});
	}
	//缴费结果
	$scope.doIt = function(){
		var params={
				"SmsCode":$scope.dycode,
				"SerialNo":$scope.msmNo
		}
		$remote.post("/pmobile/SmsCodeValidate.do",params,function(data){
			$scope.PhonePay();
		});
		
	}
	$scope.PhonePay = function(){
		var param={
				"businessType":$scope.BussinessCode,
// 				"businessType":"755060303",
				"recordNo":$scope.PhonePayNo,
				"PayPhoneNo":$scope.PayPhoneNo,
				"accountNo":$scope.AcNo.AcNo,
				"payAmount":$scope.PayAmount.Code,
				"tranAmount":$scope.PayAmount.Code,
				"_tokenName":$scope.PayConfirm._tokenName
		}
		$remote.post("/pmobile/PhonePay.do",param,function(data){
			$scope.Result = data;
			$targets("content","#3");
		});
	}
// 	$scope.freshCode=function(id){
// 		$scope.img = "";
// 		$remote.post("/pmobile/GenTokenImg.do?r"+Math.random(),{},function(data){
// 			$scope.TokenImg=data.imgKey;
// 		});
// 	}
}
</script>