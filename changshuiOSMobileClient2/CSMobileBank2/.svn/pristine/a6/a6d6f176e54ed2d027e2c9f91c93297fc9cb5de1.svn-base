<div v-view-setup="PSavToTimCtrl" v-init="init()">
	<!-- 活期转定期录入页面 -->
	<div v-page v-transition="native" title="活期转定期">
		<form  name="transInput" class="bg_box">
			<div class="box_cont">
	
				<div class="selected">
					<span><img class="jindu" src="images/u1.png" /></span> <span><img
						class="jindu" src="images/u2_1.png" /></span> <span><img class="jindu" src="images/u3_1.png" /></span>
				</div>
	 			<div v-show="flg1!='1'" v-model="no" name="no" class="mingce">
					<ul>
						<li class="center">对不起，您的账户没有借记卡</li>
					</ul>
				</div>
				<div v-show="flg1=='1'" class="zz_cont">
					<ul>
						<li>
							<em>付款账号：</em>
							<i>
								<select  v-change="getCardInfo()" v-model="payCard" name="payCard" v-options="ac.AcNo1 for ac in acList" >
								</select>
							</i>
						</li>
						<li>
							<em>可用余额：</em>
							<i class="colff6" ui-money='{"amounts":"balance"}'></i>
						</li>
<!-- 						<li> -->
<!-- 							<em>币种：</em> -->
<!-- 							<i>{{cardInfo.CurrencyName}}</i> -->
<!-- 						</li> -->
						<li>
							<em>转存金额：</em>
							<i class="colff6">
								<input type="text"  id="transfer"  placeholder="请输入转存金额" name="amount" v-model="amount"  ui-num='{"maxlength":11,"hasDot":true,"tip":"转存金额"}'  class="y_srk" required>
							</i>
						</li>
						<li>
							<em>存期：</em>
							<i>
								<select v-model="stage" v-change="getRate()" id="stage" name="stage" v-options="sl.name for sl in stageList" >
								</select>
							</i>
						</li>
						<li style="border-bottom: none;">
							<em>年利率：</em>
							<i>{{rate}}</i>
						</li>
					</ul>
				</div>
				<div v-show="flg1=='1'" class="zz_cont">
					<input type="button" class="button_1" name="button" id="subbtn" value="确认"  v-click="toConfirm()">
				</div>
			</div>
		</form>
	</div>
	
	<!-- 活期转定期确认页面 -->
	<div v-page v-transition="native" title="活期转定期">
		 <form name="transConfirm" class="bg_box">
		    <div class="box_cont">
		      <div class="selected">
		        <span><img class="jindu" src="images/u1.png" /></span>
		         <span><img class="jindu" src="images/u2.png" /></span>
		          <span><img class="jindu" src="images/u3_1.png" /></span>
		      </div>
		      <div class="zz_cont">
			      <ul>
						<li><em>账号：</em><i>{{payCard.AcNo1}}</i></li>
<!-- 						<li><em>币种：</em><i>{{cardInfo.CurrencyName}}</i></li> -->
			            <li><em>转存金额：</em><i style="color:#ff6000">{{amount|number:2}}元</i></li>
						<li><em>存期：</em><i>{{stage.name}}</i></li>
						<li><em>年利率：</em><i>{{rate}}</i></li>
				  </ul>
		       </div>
		       <div class="zz_cont">
			      <ul>
						<li>
							<em>验证码：</em>
							<i><input type="tel" name="imgcode" v-model="imgcode" class="y_srk" maxlength=4 placeholder="请输入验证码" style="width:50%"/></i>
							<img id="img" name="img" v-model="img" src="data:image/png;base64,{{TokenImg}}" data-ke-src="data:image/png;base64,{{TokenImg}}"  style="position:relative;left:40%;margin-top:3%" v-click="freshCode()">
<!-- 							<img id="img" name="img" v-model="img" src="/pmobile/GenTokenImg.do"  style="position:relative;left:40%;margin-top: 2%" v-click="freshCode('img')"> -->
						</li>
				  </ul>
		     	</div>
		     	<div>
		     		<input type="submit"  class="button_1" name="Submit" v-disabled="!imgcode"  value="确认" v-click="toResult()">
		     	</div>
		 </div>
		 </form>
	</div>
	
	
	<!-- 活期转定期结果页面 -->
	<div v-page v-transition="native" data-back="false" title="活期转定期">
		<div class="bg_box">
		    <div class="box_cont">
			      <div class="selected">
			        <span><img class="jindu" src="images/u1.png" /></span>
			        <span><img class="jindu" src="images/u2.png" /></span>
			        <span><img class="jindu" src="images/u3.png" /></span>
			      </div>
				  <div class="zz_cont" >
				    <div v-show="IsReward=='true'" class="maind" style="margin:0px">
						<div class="d1" style="float:left;padding-left:5px;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:left;width:50%;height:70px;  padding-top:9%;">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 交易成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{resultData.TrsTime}}</div>
						</div>
						<div class="d3"  style="padding-top: 25px;float:left;width:20%;margin-left:-3%"><img  v-click="gotoRewardPage()" src="images/img_reward.gif" style="width:100px;height:60px;"/></div>
					</div>
					<div v-hide="IsReward=='true'">
						<div class="d1" style="float:left;padding-left:50px;;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:right;width:50%;height:70px;  padding-top:9%;padding-right:30px">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 交易成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{resultData.TrsTime}}</div>
						</div>
					</div>
				     <div class="resultForm">
						<ul>
							<li><em>账号：</em><i>{{payCard.AcNo2}}</i></li>
<!-- 							<li><em>币种：</em><i>{{cardInfo.CurrencyName}}</i></li> -->
							<li><em>转存金额：</em><i>{{amount|number:2}}元</i></li>
							<li><em>存期：</em><i>{{stage.name}}</i></li>
							<li><em>年利率：</em><i>{{rate}}</i></li>
				  		</ul>
				     </div>
				  </div>
		 	</div>
 		</div>
	</div>
	<div style="width:100%;height:40px;"></div>
</div>
<script>
PSavToTimCtrl.$inject = ["$scope","$remote","$targets","$filter","$context"];
function PSavToTimCtrl($scope,$remote,$targets,$filter,$context){
	$scope.init=function(){
		//获取分期信息
		$remote.get("data/FixToAlive/FixToAlive.json", {}, function(data) {
			$scope.stageList=data;
			$scope.stage=$scope.stageList[0];
			var params={
					"Amount":50,
					"Term":$scope.stage.value
			}
			$remote.post("/pmobile/RateQry.do",params,function(data){
				if(data._RejCode=="000000"){
					$scope.rate=data.Rate+"%";
				}
			});
		});
		$remote.post("/pmobile/ActListQry.do",{},function(data){
// 			vx.forEach(data.AcList,function(item){
				
// 			});
// 			$scope.acList = data.AcList;
			var temp=[];
// 			var filterFn=$filter("filter");
			//从借记卡和存折的列表中筛选出借记卡
			vx.forEach(data.AcList,function(obj){
				if(obj.AcType=="1"){
					if(obj.AcNo != undefined){
						$scope.flg1=obj.AcType;
						obj.AcNo1=obj.AcNo.substring(0,4)+"****"+ obj.AcNo.substring(obj.AcNo.length-4)
						obj.AcNo2=obj.AcNo1;
						if(obj.AcAlias.length>4){
							obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias.substring(0,4)+"...";
						}else if(obj.AcAlias.length<=4&&obj.AcAlias.length>0){
							obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias;
						}else{
							obj.AcNo1=obj.AcNo1;
						}
					}
					temp.push(obj);
				}
			});
			$scope.acList=temp;
			$scope.mobileNo=data.MobilePhone;
			$scope.payCard=$scope.acList[0];
			$scope.getCardInfo();
		});
	}
	//获取利率
	$scope.getRate=function(){
		var params={
				"Amount":$scope.amount>50?$scope.amount:50,
				"Term":$scope.stage.value
		}
		$remote.post("/pmobile/RateQry.do",params,function(data){
			$scope.ButtonDis = false;
			if(data._RejCode=="000000"){
				$scope.rate=data.Rate+"%";
			}
		});
	
		$scope.imgcode="";
		if(!$scope.amount||!vx.isDefined($scope.amount)){
			NativeCall.toast("请输入转存金额");
			var params={
					"Amount":$scope.amount>50?$scope.amount:50,
					"Term":$scope.stage.value
			}
			return false;
		}
		if($scope.amount){
			var pos=$scope.amount.toString().indexOf(".");
		}else{
			var pos=$scope.amount
		}
		if(parseFloat($scope.amount)<50){
			NativeCall.toast("转存金额不得小于50元！");
			return false;
		}else if(pos>-1&&$scope.amount.length-pos>3){
			NativeCall.toast("金额格式有误，小数点后只能有两位小数");
			return false;
		}
	}
	//跳转到抽奖页面
	$scope.gotoRewardPage=function(){
		$context.clear();
		$scope.TransName="PSavToTim";
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":$scope.TransName},function(data){
			if(data.GAMETYPE=="0"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("LotteryDraw");
			}else if(data.GAMETYPE=="2"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("GuaGuaLe");
			}else if(data.GAMETYPE=="3"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("YaoYiYao");
			}
		});
	}
	//获取支付卡信息
	$scope.getCardInfo=function(){
		var cardNo=$scope.payCard.AcNo;
		//查询可用余额
		$remote.post("/pmobile/ActBalQry.do",{"AcNo":cardNo},function(data){
			$scope.cardInfo=data;
			$scope.balance=data.AvailBal;
		});
	}
	//刷新验证码
	$scope.freshCode=function(){
		$remote.post("/pmobile/GenTokenImg.do?r"+Math.random(),{},function(data){
			$scope.TokenImg=data.imgKey;
		});
	}
	//跳转到确认页面
	$scope.toConfirm=function(){
		if(parseFloat($scope.amount)>parseFloat($scope.balance)){
			NativeCall.toast("卡内余额不足！");
			return;
		}
		$scope.imgcode="";
		if(!$scope.amount||!vx.isDefined($scope.amount)){
			NativeCall.toast("请输入转存金额");
			return;
		}else if(parseFloat($scope.amount)<50){
			NativeCall.toast("转存金额不得小于50元！");
			return;
		}
		if($scope.amount){
			var pos=$scope.amount.toString().indexOf(".");
		}else{
			var pos=$scope.amount
		}
		if(pos>-1&&$scope.amount.length-pos>3){
			NativeCall.toast("金额格式有误，小数点后只能有两位小数");
			return false;
		}
		$scope.params={
				"PayerAcNo":$scope.payCard.AcNo,
				"Amount":$scope.amount,
				"Term":$scope.stage.value
		}
		$remote.post("/pmobile/SavToTimConfirm.do",$scope.params,function(data){
			if(data._RejCode=="000000"){
				$targets("content","#2");
				$scope.freshCode();
			}
		});
		var params={
				"Amount":$scope.amount,
				"Term":$scope.stage.value
		}
		$remote.post("/pmobile/RateQry.do",params,function(data){
			$scope.ButtonDis = false;
			if(data._RejCode=="000000"){
				$scope.rate=data.Rate+"%";
			}
		});
	}
	//跳转到结果页面
	$scope.toResult=function(){
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":"PSavToTim"},function(data){
			$scope.IsReward=data.ISREWARD;
		});
		$scope.params._vTokenName=$scope.imgcode;
		$remote.post("/pmobile/SavToTim.do",$scope.params,function(data){
			$scope.resultData=data;
			$targets("content","#3");
		},function(data){ 
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			$scope.imgcode="";
			$scope.freshCode();
			return data.jsonError;
		});
	}
	
}
</script>