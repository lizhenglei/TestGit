<div v-view-setup="TianTianLiBuyCtrl" v-init="init()">
	<!-- 天天利购买申请录入页面 -->
	<div v-page v-transition="native" title="理财产品购买">
		<form  name="transInput" class="bg_box">
			<div class="box_cont">
	
				<div class="selected">
					<span><img class="jindu" src="images/u1.png" /></span> <span><img
						class="jindu" src="images/u2_1.png" /></span> <span><img class="jindu" src="images/u3_1.png" /></span>
				</div>
				<div class="zz_cont">
					<ul>
						<li>
							<em>账号：</em>
							<i>
								<select  v-change="getCardInfo()" v-model="payCard" name="payCard" v-options="ac.AcNo1 for ac in acList" >
								</select>
							</i>
						</li>
						<li>
							<em>可用余额：</em>
							<i class="colff6" ui-money='{"amounts":"balance"}' style="height:35px;line-height:35px"></i>
						</li>
						<li>
							<em>产品名称：</em>
							<i>
								{{TTInfo.prdName}}
							</i>
						</li>
						<li>
							<em>预期收益率：</em>
							<i>
								{{TTInfo.rtnRate}}%
							</i>
						</li>
						<li>
							<em>金额：</em>
							<i class="colff6">
								<input type="text" placeholder="请输入金额" name="amount" v-model="amount" class="y_srk" required>
							</i>
						</li>
						<li>
							<em>推荐经理号：</em>
							<i class="colff6">
								<input type="text" placeholder="选填" name="custMngNo" v-model="custMngNo"  ui-num='{"maxlength":11,"hasDot":false,"tip":"推荐经理号"}' class="y_srk" required>
							</i>
						</li>
					</ul>
				</div>
				<div class="zz_cont">
					<input type="button" class="button_1" name="button" value="确认" v-disabled="!amount" v-click="toConfirm(TTInfo)">
				</div>
			</div>
		</form>
		<div class="zz_cont"><img src="images/ts.png" />
		    <font class="tishi">
				温馨提示</br>
			</font>
				&nbsp;&nbsp;购买金额最低{{TTInfo.firstBuyAmt|number:2}}元,累加金额为{{TTInfo.buyAddAmt|number:2}}的整数倍,单笔最高金额为{{TTInfo.singleBuyLimit|number:2}}元。</br>
			<div style="font-size:12px; line-height:16px; color:#929292;"> </div>
	   </div>
	</div>
	
	<!-- 天天利购买申请确认页面 -->
	<div v-page v-transition="native" title="理财产品购买">
		 <form name="transConfirm" class="bg_box">
		    <div class="box_cont">
		      <div class="selected">
		        <span><img class="jindu" src="images/u1.png" /></span>
		         <span><img class="jindu" src="images/u2.png" /></span>
		          <span><img class="jindu" src="images/u3_1.png" /></span>
		      </div>
		     <div class="zz_cont">
					<ul>
						<li>
							<em>账号：</em>
							<i>
								{{payCard.AcNo1}}
							</i>
						</li>
						<li>
							<em>产品名称：</em>
							<i>
								{{TTInfo.prdName}}
							</i>
						</li>
						<li>
							<em>预期收益率：</em>
							<i>
								{{TTInfo.rtnRate}}%
							</i>
						</li>
						<li>
							<em>金额：</em>
							<i class="colff6">
								{{amount|number:2}}
							</i>
						</li>
						<li>
							<em>推荐经理号：</em>
							<i class="colff6">
								{{custMngNo}}
							</i>
						</li>
					</ul>
				</div>
		       <div class="zz_cont">
			      <ul>
						<li>
							<em>验证码：</em>
							<i><input type="tel" name="imgcode" v-model="imgcode" class="y_srk" maxlength=4 placeholder="请输入验证码" style="width:50%"/></i>
							<img id="img" name="img" v-model="img" src="data:image/png;base64,{{TokenImg}}" data-ke-src="data:image/png;base64,{{TokenImg}}" style="position:relative;left:40%;margin-top:3%" v-click="freshCode('img')">
<!-- 								<img id="img" name="img" v-model="img" src="/pmobile/GenTokenImg.do"  style="position:relative;left:40%;margin-top: 2%" v-click="freshCode('img')"> -->
						</li>
				  </ul>
		     	</div>
		     	<div>
		     		<input type="submit"  class="button_1" name="Submit" value="确认" v-disabled="!imgcode" v-click="toResult('img')">
		     	</div>
		 </div>
		 </form>
		 <div class="zz_cont"><img src="images/ts.png" />
		    <font class="tishi">
				温馨提示</br>
			</font>
				&nbsp;&nbsp;客户点击“确认”提交本页面后，若因通讯等问题未能正常跳转至交易成功页面，客户应通过【我的理财】查看委托是否成功。</br>
			<div style="font-size:12px; line-height:16px; color:#929292;"> </div>
	   </div>
	</div>
	
	
	<!-- 天天利购买申请结果页面 -->
	<div v-page v-transition="native" data-back="false" title="理财产品购买">
		<div class="bg_box">
		    <div class="box_cont">
			      <div class="selected">
			        <span><img class="jindu" src="images/u1.png" /></span>
			        <span><img class="jindu" src="images/u2.png" /></span>
			        <span><img class="jindu" src="images/u3.png" /></span>
			      </div>
				  <div class="zz_cont">
				     <div v-show="IsReward=='true'" class="maind" style="margin:0px">
						<div class="d1" style="float:left;padding-left:5px;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:left;width:50%;height:70px;  padding-top:9%;">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 交易成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{resultData.TransDate}}</div>
						</div>
						<div class="d3"  style="padding-top: 25px;float:left;width:20%;margin-left:-3%"><img  v-click="gotoRewardPage()" src="images/img_reward.gif" style="width:100px;height:60px;"/></div>
					</div>
					<div v-hide="IsReward=='true'">
						<div class="d1" style="float:left;padding-left:50px;;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:right;width:50%;height:70px;  padding-top:9%;padding-right:30px">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 交易成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{resultData.TransDate}}</div>
						</div>
					</div>
				     <div class="resultForm">
						<ul>
							<li><em>账号：</em><i>{{payCard.AcNo2}}</i></li>
							<li><em>金额：</em><i>{{amount|number:2}}元</i></li>
				  		</ul>
				     </div>
				     <div>
		     			<input type="button" class="button_6" name="button" value="理财超市"  v-click="toMarket()">&nbsp;<input type="button"" class="button_6 fright" name="button" value="我的理财"  v-click="toMyPrd()">
		    	 	 </div>
				  </div>
		 	</div>
 		</div>
	</div>
	<div style="width:100%;height:40px"></div>
</div>
<script>
TianTianLiBuyCtrl.$inject = ["$scope","$remote","$targets","$filter","$context"];
function TianTianLiBuyCtrl($scope,$remote,$targets,$filter,$context){
	$scope.init=function(){
		$scope.TTInfo=$context.getJson().TTproduct;
		//获取服务器当前时间
		$remote.post("/pmobile/GenTimeStamp.do",{},function(data){
			var serviceTime=data._sysDate;
			$scope.nowdate=$scope.formartDate(serviceTime,0);
		});
		//查询账户列表
		$remote.post("/pmobile/ActListQry.do",{},function(data){
			$scope.acList=data.AcList;
			var filterFn=$filter("filter");
			$scope.acList=filterFn($scope.acList,function(obj,text){
				if(obj.AcNo != undefined){
					obj.AcNo1=obj.AcNo.substring(0,4)+"****"+ obj.AcNo.substring(obj.AcNo.length-4)
					obj.AcNo2=obj.AcNo1;
					if(obj.AcAlias.length>4){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias.substring(0,4)+"...";
					}else if(obj.AcAlias.length<=4&&obj.AcAlias.length>0){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias;
					}else{
						obj.AcNo1=obj.AcNo1;
					}
					return true;
				}
			});
			$scope.mobileNo=data.MobilePhone;
			$scope.payCard=$scope.acList[0];
			$scope.getCardInfo();
		});
	}
	$scope.gotoRewardPage=function(){
		$context.clear();
		$scope.TransName="PPrdMarket";
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":$scope.TransName},function(data){
			if(data.GAMETYPE=="0"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("LotteryDraw");
			}else if(data.GAMETYPE=="2"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("GuaGuaLe");
			}else if(data.GAMETYPE=="3"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("YaoYiYao");
			}
		});
	}
	//改变支付卡
	$scope.getCardInfo=function(){
		var cardNo=$scope.payCard.AcNo;
		//查询余额
		$remote.post("/pmobile/ActBalQry.do",{"AcNo":cardNo},function(data){
			$scope.cardInfo=data;
			$scope.balance=data.AvailBal;
		});
		var params={
				"AcNo":$scope.payCard.AcNo,
				"prdCode":$scope.TTInfo.prdCode,
				"state":0,
				"pageSize":50,
				"currentIndex":1
		}
		//查询理财账号
		$remote.post("/pmobile/QueryTTLAcNoInfo.do",params,function(data){
			$scope.financAc=data.List[0].contractNo;
		},function(data){
			return data.jsonError;
		});
	}
	//跳转至理财超市
	$scope.toMarket=function(){
		$scope.goto("PPrdMarket");
	}
	//跳转至我的理财
	$scope.toMyPrd=function(){
		$scope.goto("PMyPrd");
	}
	/**
	*跳转到确认页面
	*1.若客户未在柜面签约，则在客户点击“认购”时提示客户先至柜面签约
	*2.若客户风险评估已过期或风险评估等级小于所要购买的理财产品时，提示客户需重新进行风险评估或弹出提示“您的风险等级低于产品风险等级”
	*/
	$scope.toConfirm=function(TTLPrd){
		//初始化确认页数据
		$scope.imgcode="";
		$scope.freshCode();//验证码图片
		
		if(vx.isEmpty($scope.financAc)){
			if(TTLPrd.firstBuyAmt && parseFloat($scope.amount)<parseFloat(TTLPrd.firstBuyAmt)){
				NativeCall.toast("购买金额不能低于"+TTLPrd.firstBuyAmt+"元");
				return false;
			}else{
				var amountbwt=parseFloat($scope.amount)-parseFloat(TTLPrd.firstBuyAmt)
				if(TTLPrd.buyAddAmt && amountbwt%parseFloat(TTLPrd.buyAddAmt)!=0){
					NativeCall.toast("累加金额应为"+TTLPrd.buyAddAmt+"的整数倍");
					return false;
				}
			}
		}else{
			if(TTLPrd.buyAddAmt && parseFloat($scope.amount)%parseFloat(TTLPrd.buyAddAmt)!=0){
				NativeCall.toast("累加金额应为"+TTLPrd.buyAddAmt+"的整数倍");
				return false;
			}
		}
		
		if(TTLPrd.singleBuyLimit && parseFloat($scope.amount)>parseFloat(TTLPrd.singleBuyLimit)){
			NativeCall.toast("购买金额不能超过"+TTLPrd.singleBuyLimit+"元");
			return false;
		}
		
		if(parseFloat($scope.amount)>parseFloat($scope.balance)){
			NativeCall.toast("账户余额不足");
		}
		if(!vx.isEmpty($scope.custMngNo)){
			$scope.custMngNoQry($scope.custMngNo);
		}
		//查询客户是否签约，以及风险等级
		$remote.post("/pmobile/QueryLJLCFxpgInfo.do",{"AcNo":$scope.payCard.AcNo},function(data){
			if(data.flag==1){
				if(data.expiryDate<$scope.nowdate){
					$scope.confirm("您的风险评估已过期,暂时不能购买本产品，是否重新评估风险等级？",function(){
						$context.setJson({"comefrom":"TianTianLiBuy","riskCard":$scope.payCard});
						$scope.loadPage("htmls/TianTianLiBuy/TianTianLiBuy.html","htmls/PRiskAssess/PRiskAssess.html");
					},function(){
						NativeCall.goBack();
					});
				}else{
						$targets("content","#2");
				}
			}else{
				$scope.alert("您的账户尚未签约，请至柜台签约");
			}
		});
	}
	//查询客户经理所属机构
	$scope.custMngNoQry = function(custMngNo){
		$remote.post("/pmobile/CustMngNoQry.do",{"tellerId":custMngNo},function(data){
			$scope.subBrcNo = data.subBrcNo;
		},function(data){ 
			if(data.jsonError&&data.jsonError[0]){
				$scope.alert("客户经理号输入不存在！");
				return;
			}
		});
	}
	//刷新验证码
	$scope.freshCode=function(id){
		$remote.post("/pmobile/GenTokenImg.do?r"+Math.random(),{},function(data){
			$scope.TokenImg=data.imgKey;
		});
	}
	//跳转到结果页
	$scope.toResult=function(id){
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":"PPrdMarket"},function(data){
			$scope.IsReward=data.ISREWARD;
		});
		var params={
				"AcNo":$scope.payCard.AcNo,
				"prdCode":$scope.TTInfo.prdCode,
				"tranAmount":$scope.amount,
				"mobileNo":$scope.mobileNo,
				"contractNo":$scope.financAc,
				"custMngNo":$scope.custMngNo,
				"subBrcNo":$scope.subBrcNo,
				"_vTokenName":$scope.imgcode
		}
		$remote.post("/pmobile/QueryTTLBuyInfo.do",params,function(data){
			$scope.resultData=data;
			$targets("content","#3");
		},function(data){ 
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			$scope.freshCode(id);
			return data.jsonError;
		});
	}
}
</script>