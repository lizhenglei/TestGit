<div v-view-setup="PDuanXinTongCtrl" v-init="init()">
	<div v-page v-transition="native">
		<div class="bg_box">
			<div class="box_cont">
				<div class="zz_cont">
				      <ul>
				      		<li>
								<em>账号：</em>
								<i>
									<select  v-change="getSignInfo(rCard)"  v-model="rCard" name="rCard" v-options="ac.AcNo for ac in AcList" ></select></i>
								</i>
							</li>
							<li>
								<em>手机号：</em>
								<i>{{MobilePhone}}</i>
							</li>
							<li v-show="Flag == 'Y'">
								<em>通知下限金额：</em>
								<i>{{Amount|number:2}}元</i>
							</li>
							<li v-show="Flag == 'Y'">
								<em>短信通知类型：</em>
								<i>{{BusinessKind|BusinessType}}</i>
							</li>
							<li>
								<em>签约状态：</em>
								<i>{{Flag|SMSSignFlag}}</i>
							</li>
					 </ul>
			    </div>
			    <div v-show="Flag == 'Y'">
					<input type="button" class="button_6" name="button" value="解约"  v-click="toCancel()">&nbsp;<input type="button"" class="button_6 fright" name="button" value="修改"  v-click="toModifyPre()">
				</div>
				
				<div v-show="Flag == 'N'">
					<input type="button" class="button_1" name="button" value="签约"  v-click="toSignPre()">
				</div>			    
			</div>
		</div>
	</div>
	<!--短信通签约录入2-->
	<div v-page v-transition="native">
		 <form name="transConfirm" class="bg_box">
		    <div class="box_cont">
		      <div class="selected">
		        <span><img class="jindu" src="images/u1.png" /></span>
		         <span><img class="jindu" src="images/u2_1.png" /></span>
		          <span><img class="jindu" src="images/u3_1.png" /></span>
		      </div>
		      <div class="zz_cont">
			      <ul>
						<li><em>签约账号：</em><i>{{AcNo|accountNo}}</i></li>
						<li><em>手机号码：</em><i>{{MobilePhone}}</i></li>
						<li><em>短信通知类型：</em>
							<i>
							<select    v-model="BusinessKindMap" name="BusinessKindMap" v-options="bk.Name for bk in BusinessKindList" ></select></i>						    
						</li>							
						<li><em>通知下限金额：</em>
						<i>
							<input type="text" placeholder="请输入通知下限金额" name="Amount" v-model="Amount"  ui-num='{"maxlength":11,"hasDot":true,"tip":"通知下限金额"}' class="y_srk" required>
						</i></li>
						<li><em>大写金额：</em><i>{{Amount|amount}}</i></li>					
				  </ul>
		       </div>
		       <div class="zz_cont">
				<input type="checkbox" name="agree" v-model="agree"/>
				我已阅读并同意<a style="color:blue" v-click="toXieYiPage()">《短信通签约协议》</a>
			</div>
		     	<div>
		     		<input type="submit"  class="button_1" name="Submit"  v-disabled=""  value="确认" v-click="toSignConfirm()">
		     	</div>
		 </div>
		 </form>
	</div>
	
	<!-- 短信通签约确认3-->
	<div v-page v-transition="native">
		 <form name="transConfirm" class="bg_box">
		    <div class="box_cont">
		      <div class="selected">
		        <span><img class="jindu" src="images/u1.png" /></span>
		         <span><img class="jindu" src="images/u2.png" /></span>
		          <span><img class="jindu" src="images/u3_1.png" /></span>
		      </div>
		      <div class="zz_cont">
			      <ul>
						<li><em>签约账号：</em><i>{{AcNo|accountNo}}</i></li>
						<li><em>手机号码：</em><i>{{MobilePhone}}</i></li>
						<li><em>短信通知类型：</em><i>{{BusinessKindMap.Value|BusinessType}}</i></li>
			            <li><em>通知下限金额：</em><i>{{Amount|number:2}}元</i></li>
			            <li>
							<em>音频Key密码：</em>
							<i><input type="password" name="keypassword" v-model="keypassword" class="y_srk" placeholder="请输入音频Key密码"/></i>
						</li>
				  </ul>
		       </div>
		     	<div>
		     		<input type="submit"  class="button_1" name="Submit"  v-disabled="!keypassword"  value="提交" v-click="toSignResult()">
		     	</div>
		 </div>
		 </form>
	</div>
	<!-- 4短信通签约结果-->
	<div v-page v-transition="native" data-back="false">
		<div class="bg_box">
		    <div class="box_cont">
			      <div class="selected">
			        <span><img class="jindu" src="images/u1.png" /></span>
			        <span><img class="jindu" src="images/u2.png" /></span>
			        <span><img class="jindu" src="images/u3.png" /></span>
			      </div>
				  <div class="zz_cont">
<!-- 				     <div class="cc_img" ><img src="images/cg_img.png" style="width:120px;height:120px" /><br/>签约成功</div> -->
<!-- 				     <div class="transtime">{{TransDate}}</div> -->
					 <div v-show="IsReward=='true'" class="maind" style="margin:0px">
						<div class="d1" style="float:left;padding-left:5px;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:left;width:50%;height:70px;  padding-top:9%;">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 签约成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{TransDate}}</div>
						</div>
						<div class="d3"  style="padding-top: 25px;float:left;width:20%;margin-left:-3%"><img  v-click="gotoRewardPage()" src="images/img_reward.gif" style="width:100px;height:60px;"/></div>
					</div>
					<div v-hide="IsReward=='true'">
						<div class="d1" style="float:left;padding-left:50px;;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:right;width:50%;height:70px;  padding-top:9%;padding-right:30px">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 签约成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{TransDate}}</div>
						</div>
					</div>
				     <div class="resultForm">
						<ul>
							<li><em>签约账号：</em><i>{{AcNo|accountNo}}</i></li>
							<li><em>手机号码：</em><i>{{MobilePhone}}</i></li>
							<li><em>短信通知类型：</em><i>{{BusinessKindMap.Value|BusinessType}}</i></li>
							<li><em>通知下限金额：</em><i>{{Amount|number:2}}元</i></li>
				  		</ul>
				     </div>				     
				  </div>
		 	</div>
 		</div>
	</div>
	<!-- 短信通解约录入5-->
	<div v-page v-transition="native">
		 <form name="transConfirm" class="bg_box">
		    <div class="box_cont">
		      <div class="selected">
		        <span><img class="jindu" src="images/u1.png" /></span>
		         <span><img class="jindu" src="images/u2_1.png" /></span>
		          <span><img class="jindu" src="images/u3_1.png" /></span>
		      </div>
		      <div class="zz_cont">
			      <ul>
						<li><em>签约账号：</em><i>{{AcNo|accountNo}}</i></li>
						<li><em>手机号码：</em>
						<i>
							{{MobilePhone}}
						</i></li>
						<li><em>短信通知类型：</em>
							<i>
							{{BusinessKind|BusinessType}}
							</i>						    
						</li>												
						<li><em>通知下限金额：</em>
						<i>
							{{Amount|number:2}}元
						</i></li>
				  </ul>
		       </div>
		     	<div>
		     		<input type="submit"  class="button_1" name="Submit"  v-disabled=""  value="确认" v-click="toCancelConfirm()">
		     	</div>
		 </div>
		 </form>
	</div>
	<!-- 短信通解约确认6-->
	<div v-page v-transition="native">
		 <form name="transConfirm" class="bg_box">
		    <div class="box_cont">
		      <div class="selected">
		        <span><img class="jindu" src="images/u1.png" /></span>
		         <span><img class="jindu" src="images/u2.png" /></span>
		          <span><img class="jindu" src="images/u3_1.png" /></span>
		      </div>
		      <div class="zz_cont">
			      <ul>
						<li><em>签约账号：</em><i>{{AcNo|accountNo}}</i></li>
						<li><em>手机号码：</em><i>{{MobilePhone}}</i></li>
						<li><em>短信通知类型：</em><i>{{BusinessKind|BusinessType}}</i></li>
			            <li><em>通知下限金额：</em><i style="color:red">{{Amount|number:2}}元</i></li>
			            <li>
							<em>音频Key密码：</em>
							<i><input type="password" name="keypassword" v-model="keypassword" class="y_srk" placeholder="请输入音频Key密码"/></i>
						</li>
				  </ul>
		       </div>
		     	<div>
		     		<input type="submit"  class="button_1" name="Submit"  v-disabled="!keypassword"  value="提交" v-click="toCancelResult()">
		     	</div>
		 </div>
		 </form>
	</div>
	<!-- 短信通解约结果7 -->
	<div v-page v-transition="native" data-back="false">
		<div class="bg_box">
		    <div class="box_cont">
			      <div class="selected">
			        <span><img class="jindu" src="images/u1.png" /></span>
			        <span><img class="jindu" src="images/u2.png" /></span>
			        <span><img class="jindu" src="images/u3.png" /></span>
			      </div>
				  <div class="zz_cont">
				   <div v-show="IsReward=='true'" class="maind" style="margin:0px">
						<div class="d1" style="float:left;padding-left:5px;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:left;width:50%;height:70px;  padding-top:9%;">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 解约成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{TransDate}}</div>
						</div>
						<div class="d3"  style="padding-top: 25px;float:left;width:20%;margin-left:-3%"><img  v-click="gotoRewardPage()" src="images/img_reward.gif" style="width:100px;height:60px;"/></div>
					</div>
					<div v-hide="IsReward=='true'">
						<div class="d1" style="float:left;padding-left:50px;;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:right;width:50%;height:70px;  padding-top:9%;padding-right:30px">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 解约成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{TransDate}}</div>
						</div>
					</div>
<!-- 				     <div class="cc_img" ><img src="images/cg_img.png" style="width:120px;height:120px" /><br/>解约成功</div> -->
<!-- 				     <div class="transtime">{{TransDate}}</div>			      -->
				  </div>
		 	</div>
 		</div>
	</div>
	<!-- 短信通修改信息录入8 -->
	<div v-page v-transition="native">
		 <form name="transConfirm" class="bg_box">
		    <div class="box_cont">
		      <div class="selected">
		        <span><img class="jindu" src="images/u1.png" /></span>
		         <span><img class="jindu" src="images/u2_1.png" /></span>
		          <span><img class="jindu" src="images/u3_1.png" /></span>
		      </div>
		      <div class="zz_cont">
			      <ul>
						<li><em>签约账号：</em><i>{{AcNo|accountNo}}</i></li>
						<li><em>手机号码：</em>
						<i>
							<input type="text" placeholder="请输入手机号码" name="NewMobilePhone" v-model="NewMobilePhone"  ui-num='{"length":11,"hasDot":false,"tip":"手机号码"}' class="y_srk" required>
						</i></li>
						<li v-show="MobilePhone!=NewMobilePhone">
							<em>手机动态码：</em>
							<i>
								<input type="text" id="dycode" name="dycode" v-model="dycode" maxlength=6 class="y_srk_50" placeholder="请输入动态码"/>
								<button id="anniu" class="inp_butt" v-sms="getDYcode()">获取动态码</button>
							</i>
						</li>
						<li><em>短信通知类型：</em>
							<i>
							<select    v-model="BusinessKindMap" name="BusinessKindMap" v-options="bk.Name for bk in BusinessKindList" ></select></i>						    
						</li>												
						<li><em>通知下限金额：</em>
						<i>
							<input type="text" placeholder="请输入通知下限金额" name="NewAmount" v-model="NewAmount"  ui-num='{"maxlength":11,"hasDot":true,"tip":"通知下限金额"}' class="y_srk" required>
						</i></li>
						<li><em>大写金额：</em><i>{{NewAmount|amount}}</i></li>
				  </ul>
		       </div>
		     	<div v-show="MobilePhone==NewMobilePhone">
		     		<input type="submit"  class="button_1" name="Submit"  v-disabled="!NewMobilePhone||!NewAmount"  value="确认" v-click="toModifyConfirm()">
		     	</div>
		     	<div v-show="MobilePhone!=NewMobilePhone">
		     		<input type="submit"  class="button_1" name="Submit"  v-disabled="!dycode||!NewMobilePhone||!NewAmount"  value="确认" v-click="toModifyConfirm()">
		     	</div>
		 </div>
		 </form>
	</div>
	<!-- 短信通修改信息确认9-->
	<div v-page v-transition="native">
		 <form name="transConfirm" class="bg_box">
		    <div class="box_cont">
		      <div class="selected">
		        <span><img class="jindu" src="images/u1.png" /></span>
		         <span><img class="jindu" src="images/u2.png" /></span>
		          <span><img class="jindu" src="images/u3_1.png" /></span>
		      </div>
		      <div class="zz_cont">
			      <ul>
						<li><em>签约账号：</em><i>{{AcNo|accountNo}}</i></li>
						<li><em>手机号码：</em><i>{{NewMobilePhone}}</i></li>
						<li><em>短信通知类型：</em><i>{{BusinessKindMap.Value|BusinessType}}</i></li>
			            <li><em>通知下限金额：</em><i style="color:red">{{NewAmount|number:2}}元</i></li>
			            <li>
							<em>音频Key密码：</em>
							<i><input type="password" name="keypassword" v-model="keypassword" class="y_srk" placeholder="请输入音频Key密码"/></i>
						</li>
				  </ul>
		       </div>
		     	<div>
		     		<input type="submit"  class="button_1" name="Submit"  v-disabled="!keypassword"  value="提交" v-click="toModifyResult()">
		     	</div>
		 </div>
		 </form>
	</div>
	<!-- 短信通修改信息结果10-->
	<div v-page v-transition="native" data-back="false">
		<div class="bg_box">
		    <div class="box_cont">
			      <div class="selected">
			        <span><img class="jindu" src="images/u1.png" /></span>
			        <span><img class="jindu" src="images/u2.png" /></span>
			        <span><img class="jindu" src="images/u3.png" /></span>
			      </div>
				  <div class="zz_cont">
				   <div v-show="IsReward=='true'" class="maind" style="margin:0px">
						<div class="d1" style="float:left;padding-left:5px;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:left;width:50%;height:70px;  padding-top:9%;">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 修改成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{TransDate}}</div>
						</div>
						<div class="d3"  style="padding-top: 25px;float:left;width:20%;margin-left:-3%"><img  v-click="gotoRewardPage()" src="images/img_reward.gif" style="width:100px;height:60px;"/></div>
					</div>
					<div v-hide="IsReward=='true'">
						<div class="d1" style="float:left;padding-left:50px;;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:right;width:50%;height:70px;  padding-top:9%;padding-right:30px">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 修改成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{TransDate}}</div>
						</div>
					</div>
<!-- 				     <div class="cc_img" ><img src="images/cg_img.png" style="width:120px;height:120px" /><br/>修改成功</div> -->
<!-- 				     <div class="transtime">{{TransDate}}</div> -->
				  </div>
		 	</div>
 		</div>
	</div>	
		<!-- 11-->
	<div v-page v-transition="native">
		<div style="width:100%;height:20px"></div>
		<div  id="prdFileId"></div>
		<div style="width:100%;height:40px"></div>
	</div>							
</div>
<script>
PDuanXinTongCtrl.$inject = ["$scope","$remote","$targets","$timeout","$context"];
function PDuanXinTongCtrl($scope,$remote,$targets,$timeout,$context){
	
	$scope.init=function(){
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":"短信通签约"},function(data){
			$scope.IsReward=data.ISREWARD;
		});
		$remote.post("/pmobile/ActListQry.do",{},function(data){
			//从借记卡和存折的列表中筛选出借记卡
			var temp=[];
			vx.forEach(data.AcList,function(item){
				if(item.AcType=="1"){
					temp.push(item);
				}
			});
			$scope.AcList=temp;
			if($scope.AcList.length==0){
				$scope.alert("当前仅支持借记卡签约管理");
				$timeout(function(){
					NativeCall.goBack();//返回上一个页面
				},100);
				return;
			}
			$scope.rCard=$scope.AcList[0];
			$scope.AcNo = $scope.rCard.AcNo;
			$scope.LocalMobilePhone=data.MobilePhone;
			$scope.CifName = data.CifName;
			$scope.IdNo = data.IdNo;
			$scope.getSignInfo($scope.rCard);
		});
		
		$scope.BusinessKindList =
			[
			 {
				 "Name":"余额变动(无余额)",
				 "Value":"8000"
			 },
			 {
				 "Name":"余额变动(带余额)",
				 "Value":"8001"
			 }
			];
		
	}
	
	$scope.gotoRewardPage=function(){
		$context.clear();
		$scope.TransName="短信通签约";
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":$scope.TransName},function(data){
			if(data.GAMETYPE=="0"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("LotteryDraw");
			}else if(data.GAMETYPE=="2"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("GuaGuaLe");
			}else if(data.GAMETYPE=="3"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("YaoYiYao");
			}
		});
	}
	//获取签约信息
	$scope.getSignInfo=function(data){
		$scope.AcNo = data.AcNo;
		$remote.post("/pmobile/SmsNoticeQry.do",{"AcNo":data.AcNo},function(data){
			$scope.MobilePhone=data.MobilePhone;
			$scope.BusinessKind=data.BusinessKind;
			$scope.Amount=data.Amount?data.Amount:"";
			$scope.Flag=data.Flag;
			if($scope.Flag == "N"){
				$scope.MobilePhone=$scope.LocalMobilePhone;
			}
		}); 
	}
	
	$scope.getDYcode=function(){
		var businessName="短信通知修改";
		var params={
				"BusinessName":businessName,
				"MobileNo":$scope.NewMobilePhone,
				"ServiceCode":"CUM000004"
		}
		//获取手机动态码
		$remote.post("/pmobile/GenTokenName.do",params,function(data){
			$scope.msmNo=data.SerialNo;
			$scope.savPhone=$scope.NewMobilePhone;//保存发送动态码的手机号
		});
	}
	
	$scope.toSignPre=function(){
		$scope.MobilePhone=$scope.LocalMobilePhone;
		$scope.BusinessKindMap = $scope.BusinessKindList[0];
		$targets("content", "#2");
	}
	//获取协议
	$scope.toXieYiPage=function(data){
		$remote.post("/pmobile/TreatyContent.do",{"TreatyType":"04"},function(data){
			document.getElementById("prdFileId").innerHTML=data.Content;
			$targets("content","#11");
		});
	}
	$scope.toSignConfirm=function(){
		//初始化签约确认页面
		$scope.keypassword="";
		
		if($scope.Amount == undefined||$scope.Amount==null || $scope.Amount==""){
			NativeCall.toast("请输入通知下限金额");
			return;
		}
		if(parseFloat($scope.Amount)<0.01){
			NativeCall.toast("通知下限金额不能少于0.01");
			return;
		}
		if($scope.agree != true){
			NativeCall.toast("请认真阅读并同意《短信通知签约协议》");
			return;
		}		
		$scope.getNewToken();
		$targets("content", "#3");
	} 		
	//获取防重复提交码
	$scope.getNewToken=function(){
		$remote.post("/pmobile/getNewTokenName.do",{},function(data){
			$scope._tokenName=data._tokenName;
		});
	}
	$scope.toSignResult=function(){
		//音频PKY制签名需要的数据
			var inputData={"cardNo":$scope.AcNo,"showTemp":"签约","flag":"1"};
			var sourceField = "签约账号#"+inputData.cardNo+"|操作类型#"+inputData.showTemp;
			//调用音频KEY字段转换xml格式的方法
			var sinData = $scope.getSignSourceValue(sourceField,"操作类型#"+inputData.flag);
			var subData={"sinData":sinData,"YPKPassword":$scope.keypassword};
			//通过原生调用音频key
			$scope.getSignData(function(outputdata){
				var signData=outputdata;
				if(!signData){
					$scope.keypassword="";
					return false;
				}
				var formData = {
						"AcNo" : $scope.AcNo,
						"MobilePhone":$scope.MobilePhone,
						"Type":"1",
						"BusinessKind" : $scope.BusinessKindMap.Value,
						"Amount":$scope.Amount,
						"ShowTemp":"签约",//该字段传“签约”、“解约”、“修改”三种情况，对应参数Type的1、2、3
						"SignData":signData,
						"_tokenName":$scope._tokenName
				};
				$remote.post("/pmobile/SmsNoticeAdd.do",formData,function(data){
					if(data._RejCode=="000000"){
						$scope.TransDate=data.TransDate;
						$targets("content","#4");
					}
				},function(data){
					if(data.jsonError){
						$scope.alert(data.jsonError);
					}
					$scope.keypassword="";
					$scope.getToken();
					return data.jsonError;
				});
			},vx.toJson(subData));			
	}
	
	$scope.toCancel=function(){		
		$scope.LocalMobilePhone = $scope.MobilePhone;
		$targets("content", "#5");
	}
	
	$scope.toCancelResult=function(){
		
		//音频PKY制签名需要的数据
			var inputData={"cardNo":$scope.AcNo,"showTemp":"解约","flag":"2"};
			var sourceField = "签约账号#"+inputData.cardNo+"|操作类型#"+inputData.showTemp;
			//调用音频KEY字段转换xml格式的方法
			var sinData = $scope.getSignSourceValue(sourceField,"操作类型#"+inputData.flag);
			var subData={"sinData":sinData,"YPKPassword":$scope.keypassword};
			//通过原生调用音频key
			$scope.getSignData(function(outputdata){
				var signData=outputdata;
				if(!signData){
					$scope.keypassword="";
					return false;
				}
				var formData = {
						"AcNo" : $scope.AcNo,
						"MobilePhone":$scope.MobilePhone,
						"Type":"2",
						"ShowTemp":"解约",//该字段传“签约”、“解约”、“修改”三种情况，对应参数Type的1、2、3
						"SignData":signData,
						"_tokenName":$scope._tokenName
				};

				$remote.post("/pmobile/SmsNoticeAdd.do",formData,function(data){
					if(data._RejCode=="000000"){
						$scope.TransDate=data.TransDate;
						$targets("content","#7");
					}
				},function(data){
					if(data.jsonError){
						$scope.alert(data.jsonError);
					}
					$scope.keypassword="";
					$scope.getToken();
					return data.jsonError;
				});
			},vx.toJson(subData));
					
	}
	
	$scope.toModifyPre=function(){
		$("#anniu").text("获取动态码");
		$("#anniu").css("background-color","#0084ff");
		$scope.NewMobilePhone = $scope.MobilePhone;
		$scope.NewAmount=$scope.Amount;
    	for(var i=0;i<$scope.BusinessKindList.length;i++){
    		obj = $scope.BusinessKindList[i];
    		if(obj.Value == $scope.BusinessKind ){
    			$scope.BusinessKindMap = obj;
    			break;
    		}
    	}
		$targets("content", "#8");
	}		
	$scope.toCancelConfirm=function(){
		//初始化确认页面
		$scope.keypassword="";
		$scope.getNewToken();
		$targets("content", "#6");
		
	}
	$scope.toModifyConfirm=function(){
		//初始化确认页面
		$scope.keypassword="";

		if($scope.NewMobilePhone == undefined||$scope.NewMobilePhone==null || $scope.NewMobilePhone==""){
			NativeCall.toast("请输入手机号码");
			return;
		}
		var reg=new RegExp(/^\d{11}$/);//u4e00-u9fa5---只包含数字、字母、汉字
		if(!reg.test($scope.NewMobilePhone)){
			NativeCall.toast("手机号格式有误");
			return;
		}
		if(($scope.NewMobilePhone!=$scope.savPhone)&&($scope.MobilePhone!=$scope.NewMobilePhone)){//二次修改手机号
			$scope.msmNo="";
			NativeCall.toast("请获取手机动态码");
			return;
		}
		if($scope.NewAmount == undefined||$scope.NewAmount==null || $scope.NewAmount==""){
			NativeCall.toast("请输入通知下限金额");
			return;
		}
		
		//校验被修改的手机号码
		if($scope.MobilePhone!=$scope.NewMobilePhone){
			var params={
					"SmsCode":$scope.dycode,
					"SerialNo":$scope.msmNo
			}
			$remote.post("/pmobile/SmsCodeValidate.do",params,function(data){
				$targets("content", "#9");
			});
		}else{
			$targets("content", "#9");
		}
		//获取防重复提交码
		$scope.getNewToken();
		
	}
	
	
	$scope.toModifyResult=function(){
			//音频PKY制签名需要的数据
			var inputData={"cardNo":$scope.AcNo,"showTemp":"修改","flag":"3"};
			var sourceField = "签约账号#"+inputData.cardNo+"|操作类型#"+inputData.showTemp;
			//调用音频KEY字段转换xml格式的方法
			var sinData = $scope.getSignSourceValue(sourceField,"操作类型#"+inputData.flag);
			var subData={"sinData":sinData,"YPKPassword":$scope.keypassword};
			//通过原生调用音频key
			$scope.getSignData(function(outputdata){
				var signData=outputdata;
				if(!signData){
					$scope.keypassword="";
					return false;
				}
				var formData = {
						"AcNo" : $scope.AcNo,
						"MobilePhone":$scope.NewMobilePhone,
						"Type":"3",
						"BusinessKind" : $scope.BusinessKindMap.Value,
						"Amount":$scope.NewAmount,
						"ShowTemp":"修改",//该字段传“签约”、“解约”、“修改”三种情况，对应参数Type的1、2、3
						"SignData":signData,
						"SmsCode":$scope.dycode,
						"SerialNo":$scope.msmNo,
						"_tokenName":$scope._tokenName
				};

				$remote.post("/pmobile/SmsNoticeModify.do",formData,function(data){
					if(data._RejCode=="000000"){
						$scope.TransDate=data.TransDate;
						$targets("content","#10");
					}
				},function(data){
					if(data.jsonError){
						$scope.alert(data.jsonError);
					}
					$scope.keypassword="";
					$scope.getToken();
					return data.jsonError;
				});
			},vx.toJson(subData));
	}	



}
</script>