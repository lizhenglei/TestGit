<div v-view-setup="PChangeGiveCtrl" v-init="init()">
	<!-- 积分转赠录入页面 -->
	<div v-page v-transition="native" title="积分转赠">
		<form name="orderInput" class="bg_box">
			<div class="box_cont">
				<div class="selected">
					<span> <img class="jindu" src="images/u1.png" />
					</span> <span> <img class="jindu" src="images/u2_1.png" />
					</span> <span> <img class="jindu" src="images/u3_1.png" />
					</span>
				</div>
				<div class="zz_cont">
				<ul id="detailInfo">
						<li><em>我的粒金币：</em><i>{{MyLiJinCoin}}</i></li>
						<li><em>对方姓名：</em> <i class="colff6">
								<input type="text" id="UserName" placeholder="请输入姓名"
								name="UserName" v-model="UserName" class="y_srk" required /> <span
								v-click="queryiPhone()"><img src="images/skr_icon.png" /></span>
						</i></li>
						<li><em>对方手机号：</em><i><input type="text" id="MobileNo" name="MobileNo" v-model="MobileNo" class="y_srk" placeholder="请输入粒金商城手机号" ui-num='{"maxlength":11,"hasDot":false,"tip":"手机号"}'/></i></li>
						<li><em>转赠数量：</em><i><input type="text" id="ConvertNum" name="ConvertNum" v-model="ConvertNum" class="y_srk" placeholder="请输入转赠数量" ui-num='{"maxlength":10,"hasDot":true,"tip":"转赠数量"}'/></i></li>
				  </ul>
			</div>
			 <div class="zz_cont">
		     		<input type="submit"  class="button_1" name="Submit" v-disabled="(!UserName) || (!MobileNo) || (!ConvertNum)" value="下一步" v-click="toConfirm()">
		    </div>
			</div>
		</form>
	</div>

	<!-- 积分转赠确认页面 -->
	<div v-page v-transition="native" title="积分转赠">
		<form name="orderConfirm" class="bg_box">
			<div class="box_cont">
				<div class="selected">
					<span><img class="jindu" src="images/u1.png" /></span> <span><img
						class="jindu" src="images/u2.png" /></span> <span><img class="jindu" src="images/u3_1.png" /></span>
				</div>
				<div class="zz_cont">
					<ul>
							<li><em>对方姓名：</em><i>{{UserName}}</i></li>
							<li><em>对方手机号：</em><i>{{MobileNo}}</i></li>
							<li><em>转赠数量：</em><i>{{ConvertNum}}</i></li>
							<li><em>验证码：</em><i><input
								type="text" id="imgcode" name="imgcode" maxlength=4
								v-model="imgcode" class="y_srk"
								placeholder="请输入验证码" style="width: 50%" /></i> 
								<img id="img"
								name="img" v-model="img" src="data:image/png;base64,{{TokenImg}}"
								data-ke-src="data:image/png;base64,{{TokenImg}}"
								style="position:relative;left:40%;margin-top:3%" v-click="freshCode('img')">
<!-- 								<img id="img" name="img" v-model="img" src="/pmobile/GenTokenImg.do"  style="position:relative;left:40%;margin-top: 2%" v-click="freshCode('img')"> -->
							</li>
					</ul>
				</div>
				<div class="zz_cont">
		     		<input type="submit"  class="button_1" name="Submit" v-disabled="!imgcode" value="确认" v-click="toResult()">
		    	</div>
			</div>
		</form>
	</div>


	<!-- 积分转赠结果页面 -->
	<div v-page v-transition="native" data-back="false" title="积分转赠">
		<div class="bg_box">
			<div class="box_cont">
				<div class="selected">
					<span><img class="jindu" src="images/u1.png" /></span> <span><img
						class="jindu" src="images/u2.png" /></span> <span><img class="jindu" src="images/u3.png" /></span>
				</div>
				<div class="zz_cont">
					<div class="maind" style="margin:0px">
						<div class="d1" style="float:left;padding-left:45px;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:100%;height:100%"/></div>
						<div class="d2" style="float:left;width:50%;height:70px;  padding-top:9%;">
							 <div style="text-align: center;font-size:x-large;color:#0069c9">转赠成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{ConvertDate}}</div>
						</div>
					</div>
					<div class="resultForm">
						<ul>
							<li><em>可用粒金币：</em><i>{{LiJinCoin}}</i></li>
							<li><em>对方姓名：</em><i>{{UserName}}</i></li>
							<li><em>对方手机号：</em><i>{{MobileNo}}</i></li>
							<li><em>转赠数量：</em><i>{{ConvertNum}}</i></li>
						</ul>
					</div>
				</div>

			</div>
		</div>
		
		<div class="zz_cont">
			<div style="font-size: 12px; line-height: 16px; color: #929292;">
			</div>
		</div>
		
	</div>

</div>
	<!-- <div class="zz_cont"><img src="images/ts.png" />
	<font class="tishi">
				温馨提示</br>
	</font>
	<img style="background-color:#008de4;width:16px;margin-left:4px" src="images/feiyan.png" />，进入我的设置，可查询手机银行转账限额</br>
	</div> -->
<div style="width:100%;height:40px"></div>

<script>
PChangeGiveCtrl.$inject = ["$scope","$remote","$targets","$filter","$context","$timeout","$window"];
function PChangeGiveCtrl($scope,$remote,$targets,$filter,$context,$timeout,$window){
	$scope.init=function(){
		//获取粒金币
		$remote.post("/pmobile/LiJinCoinQry.do",{},function(data){
			if(data._RejCode="000000"){
				$scope.MyLiJinCoin = data.PointAvaile;
			}
		});
		
	}
	//查询通讯录
	$scope.queryiPhone=function(){
		$scope.getPhoneNumber(function(data){
			var resJson=vx.fromJson(data);
			$("#UserName").val(resJson.PhoneName);
			$("#MobileNo").val(resJson.PhoneNumber);
			$scope.UserName=resJson.PhoneName;
			$scope.MobileNo=resJson.PhoneNumber;
		});
	}
	//刷新验证码
	$scope.freshCode=function(id){
		$remote.post("/pmobile/GenTokenImg.do?r"+Math.random(),{},function(data){
			$scope.TokenImg=data.imgKey;
		});
	}
	//跳转到确认页面
	$scope.toConfirm=function(){
		var reg1=new RegExp(/^[\u4E00-\u9FA5A-Za-z ]+$/);//姓名只能是中文字符或者英文字符
		if(!reg1.test($scope.UserName)){
			NativeCall.toast("姓名只能为汉字或字母");
			return false;
		}else if(parseInt($scope.ConvertNum)>parseInt($scope.MyLiJinCoin)){
			$scope.alert("转赠数量应小于我的粒金币！");
			return false;
		}else{
			//验证手机号码
			$remote.post("/pmobile/MobilePhoneAuthorityQry.do",{"MobilePhone":$scope.MobileNo,"PayeeAcName":$scope.UserName},function(data){
				console.log(data);
				if(data.Flag==1){
					$targets("content","#2");
					$scope.freshCode("img");
				}else if(data.Flag==0){
					$scope.alert("该用户手机号未签约");
					return false;
				}else if(data.Flag==2){
					$scope.alert("户名不符");
					return false;
				}
			});
		
		}
	}
	
	//跳转到结果页
	$scope.toResult=function(id){
		$scope.getClientState(function(response){
			var resJson=vx.fromJson(response);
			$scope.HostCustNo = resJson.Userinfo.HexinKehuhao;
			$scope.CifName = resJson.Userinfo.CifName;
			$scope.MobilePhone = resJson.Userinfo.MobileNo;
		});
		var params={
				"HostCustNo":$scope.HostCustNo,
				"MobilePhone":$scope.MobilePhone,
				"CustName":$scope.CifName,
				"ToMobile":$scope.MobileNo,
				"ToCstName":$scope.UserName,
				"PointTrans":$scope.ConvertNum,
				"_vTokenName":$scope.imgcode
		};
		$remote.post("/pmobile/LiJinCoinTransfer.do",params,function(data){
			console.log(data);
			if(data._RejCode=="000000"){
				$scope.ConvertDate=data.TransDate;
				$scope.LiJinCoin=parseInt($scope.MyLiJinCoin)-parseInt($scope.ConvertNum);
				$targets("content","#3");
			}
		},function(data){ 
			if(data.jsonError){
				if(data.jsonError=="要查询的记录不存在"){
					$scope.alert("该用户不是手机银行用户!");
				}
			}	
		});
	}
	
}
</script>