<div v-view-setup="InnerTransferCtrl" v-init="init()">
	<!-- 转账录入页面 -->
	<div v-page v-transition="native" title="转给本行">
		<form name="transInput" class="bg_box">
			<div class="box_cont">

				<div class="selected">
					<span> <img class="jindu" src="images/u1.png" />
					</span> <span> <img class="jindu" src="images/u2_1.png" />
					</span> <span> <img class="jindu" src="images/u3_1.png" />
					</span>
				</div>
				<div class="zz_cont">
					<ul>
						<li><em>付款账号：</em> <i>
								<select v-change="getCardInfo()"
								v-model="payCard" name="payCard"
								v-options="ac.AcNo1 for ac in acList">
							</select> </i></li>
						<li><em>可用余额：</em> <i class="colff6"
							ui-money='{"amounts":"balance"}'></i></li>
<!-- 						<li><em>币种：</em> <i>{{cardInfo.CurrencyName}}</i></li> -->
					</ul>
				</div>
				<div><img class="img12" style="  width: 50px;height: 22px;margin-top: -30px;margin-bottom: -26px;margin-left: 74%;" src="images/hot-01.png" /></div>
				<div class="radio_cont" style="  margin-top: -8px;">
					<span class="radio"><input type="radio" class="radio"
						v-model="transType" name="transType" value="1"
						v-click="selected(15)" />转给他人</span> <span class="radio"><input
						type="radio" class="radio" v-model="transType" name="transType"
						value="2" v-click="selected(45)" />转给本人</span> <span class="radio"><input
						type="radio" class="radio11" v-model="transType" name="transType"
						value="3" v-click="selected(80)" />手机号</span>
				</div>
				<div class="tx_cont">
					<div class="prompt_arr">
						<img src="images/prompt_arr.png" />
					</div>
					<span v-show="transType==1">转账给本行他人账户。</span> <span
						v-show="transType==2">转账给本人账户。</span> <span v-show="transType==3">转给本行已开通手机银行的他人手机号。</span>
				</div>
				<div class="zz_cont">
					<ul>
						<li v-show="transType=='1'" id="lastShowLi"><em>收款人账号：</em> <i>
								<input type="text" v-focus="showLastTrans()"
								v-blur="hideLastTrans()" v-change="isHide()"
								placeholder="请输入收款人账号" name="rCard" v-model="rCard"
								ui-num='{"maxlength":22,"hasDot":false,"tip":"收款卡号"}'
								class="y_srk" required /> <span v-click="queryReciver()"><img
									src="images/skr_icon.png" /></span>
<!-- 								<div id="lasttrans" class="payeeList" style="display: none"> -->
<!-- 									<div class="tips" v-repeat=" l3 in last3List" -->
<!-- 										v-click="selectedInput(l3)">{{l3.PayeeAcNo}}&nbsp;{{l3.PayeeAcName}}</div> -->
<!-- 								</div> -->
						</i></li>
						<li v-show="ShowOrHide">
							<em>&nbsp;</em>
							<i  style="width:60%">
								<div v-repeat=" l3 in last3List" style="border: 1px solid #ccc;border-top: none;">
									<input type="text" class="tips" v-focus="selectedInput(l3)" value="{{l3.PayeeAcName}}" style="border:none;line-height:25px;height:25px;text-align:left"/>
									<input type="text" class="tips" v-focus="selectedInput(l3)" value="{{l3.PayeeAcNo}}" style="border:none;line-height:25px;height:25px;text-align:left"/>
								</div>
							</i>
						</li>
						<li v-show="transType=='1'"><em>收款人姓名：</em> <i class="colff6">
								<input type="text" placeholder="请输入收款人姓名" name="rName"
								v-model="rName" class="y_srk" required />
						</i></li>
						<li v-show="transType=='1'"><em>保存收款人：</em> <i class="colff6">
								<input type="checkbox" name="saveThis" v-model="saveThis"
								class="checkbox">
						</i></li>
						<li v-show="transType=='2'"><em>收款人账号：</em> <i><select
								v-model="selfRCard" name="selfRCard"
								v-options="ac.AcNo1 for ac in rAcList">
							</select> </i></li>
						<li v-show="transType=='2'" ><em>收款人姓名：</em>
							<i>{{selfRCard?cardInfo.AcName:""}}</i></li>
						<li v-show="transType=='3'"><em>收款手机号：</em> <i class="colff6">
								<input type="text" id="rPhone" placeholder="请输入收款人手机号"
								ui-num='{"maxlength":11,"hasDot":false,"tip":"收款手机号"}'
								name="rPhone" v-model="rPhone" class="y_srk" required /> <span
								v-click="queryiPhone()"><img src="images/skr_icon.png" /></span>
						</i></li>
						<li v-show="transType=='3'"><em>收款人姓名：</em> <i class="colff6">
								<input type="text" placeholder="请输入收款人姓名" id="rName" name="rName"
								v-model="rName" class="y_srk" required />
						</i></li>
						<li><em>转账金额：</em> <i class="colff6"> <input type="text"
								placeholder="请输入转账金额" name="amount" v-model="amount"
								ui-num='{"maxlength":11,"hasDot":true,"tip":"转账金额"}'
								class="y_srk">
						</i></li>
						<li style="border-bottom: none;"><em>转账用途：</em> <i
							class="colff6"> <input type="text" placeholder="转账"
								name="yongtu" v-model="yongtu" class="y_srk" >
						</i></li>
					</ul>
				</div>
				<div class="zz_cont" style="height:0px">
					<input style="height:0px" type="button" class="button_1" name="button" value="下一步11111111111"
						v-disabled="transInput.rCard.$invalid||transInput.rName.$invalid||transInput.amount.$invalid"
						v-click="toConfirm()">
				</div>
				<div class="zz_cont" v-show="transType!='2' && transType!='3'">
					<input type="button" class="button_1" name="button" value="下一步"
						v-disabled="transInput.rCard.$invalid||transInput.rName.$invalid||transInput.amount.$invalid"
						v-click="toConfirm()">
				</div>
				<div class="zz_cont" v-show="transType=='2'">
					<input type="button" class="button_1" name="button" value="下一步"
						v-disabled="transInput.selfRCard.$invalid||transInput.amount.$invalid"
						v-click="toConfirm()">
				</div>
				<div class="zz_cont" v-show="transType=='3'">
					<input type="button" class="button_1" name="button" value="下一步"
						v-disabled="transInput.rPhone.$invalid||transInput.rPhoneName.$invalid||transInput.amount.$invalid"
						v-click="toConfirm()">
				</div>

			</div>
		</form>
		<div class="zz_cont"><img src="images/ts.png" />
	<font class="tishi">
				温馨提示</br>
	</font>
	&nbsp;&nbsp;点击右上角<img style="background-color:#008de4;width:16px;margin-left:4px" src="images/feiyan.png" />，进入我的设置，可查询手机银行转账限额。</br>
	</div>
	</div>

	<!-- 转账确认页面 -->
	<div v-page v-transition="native" title="转给本行">
		<form name="transConfirm" class="bg_box">
			<div class="box_cont">
				<div class="selected">
					<span><img class="jindu" src="images/u1.png" /></span> <span><img
						class="jindu" src="images/u2.png" /></span> <span><img class="jindu" src="images/u3_1.png" /></span>
				</div>
				<div class="zz_cont">
					<ul>
						<li><em>付款账号：</em><i>{{payCard.AcNo1}}</i></li>
						<li><em>转账方式：</em><i>{{transTypeCN}}</i></li>
						<li v-show="transType==1"><em>收款人账号：</em><i>{{rCard|accountNo}}</i></li>
						<li v-show="transType==2"><em>收款人账号：</em><i>{{selfRCard.AcNo|accountNo}}</i></li>
						<li v-show="transType==3"><em>收款手机号：</em><i>{{rPhone}}</i></li>
						<li v-show="transType==2"><em>收款人姓名：</em><i>{{cardInfo.AcName}}</i></li>
						<li v-hide="transType==2"><em>收款人姓名：</em><i>{{rName}}</i></li>
						<li><em>转账金额：</em><i style="color: #ff6000;">{{amount|number:2}}元</i></li>
						<li><em>金额大写：</em><i>{{amount|amount}}</i></li>
						<li><em>转账用途：</em><i style="color: #ff6000;">{{yongtu}}</i></li>

					</ul>
				</div>
				<div class="zz_cont">
					<ul>
						<li v-show="authType==2&&transType!=2"><em>手机动态码：</em> <i>
								<input type="tel" id="dycode" name="dycode" v-model="dycode"
								v-focus="windowScroll()" maxlength=6 class="y_srk_50"
								placeholder="请输入动态码" />
								<button id="anniu" class="inp_butt" v-sms="getDYcode()">获取动态码</button>
						</i></li>
						<li v-show="authType==0&&Security=='07'&&transType!=2"><em>卡密码：</em>
							<i><input id="cardpassword" type="password"
								name="cardpassword" v-model="cardpassword" class="y_srk"
								placeholder="请输入密码" v-focus="windowScroll()" v-click="getPW()" readonly /></i></li>
						<li v-show="authType==0&&Security=='07'&&transType!=2"><em>手机动态码：</em>
							<i> <input type="tel" id="dycode" name="dycode"
								v-model="dycode" v-focus="windowScroll()" maxlength=6
								class="y_srk_50" placeholder="请输入动态码" />
								<button id="anniu" class="inp_butt" v-sms="getDYcode()">获取动态码</button>
						</i></li>
						<li v-show="transType==2||authType==null"><em>验证码：</em> <i><input
								type="tel" id="imgcode" name="imgcode" maxlength=4
								v-model="imgcode" v-focus="windowScroll()" class="y_srk"
								placeholder="请输入验证码" style="width: 50%" /></i> 
								<img id="img"
							name="img" v-model="img" src="data:image/png;base64,{{TokenImg}}"
							data-ke-src="data:image/png;base64,{{TokenImg}}"
							style="position:relative;left:40%;margin-top:3%" v-click="freshCode('img')">
<!-- 							<img id="img" name="img" v-model="img" src="/pmobile/GenTokenImg.do"  style="position:relative;left:40%;margin-top: 2%" v-click="freshCode('img')"> -->
						</li>
						
						<li v-show="authType==0&&Security=='05'"><em>音频Key密码：</em> <i><input
								id="keypassword" type="password" name="keypassword"
								v-model="keypassword" v-focus="windowScroll()" class="y_srk"
								placeholder="请输入音频Key密码" /></i></li>
					</ul>
				</div>
				<div v-show="transType==2||authType==null">
					<input type="submit" class="button_1" name="Submit"
						v-disabled='!imgcode' value="确认" v-click="toResult('img')">
				</div>
				<div v-show="authType==2&&transType!=2">
					<input type="submit" class="button_1" name="Submit"
						v-disabled='!dycode' value="确认" v-click="toResult('img')">
				</div>
				<div v-show="authType==0&&Security=='07'&&transType!=2">
					<input type="submit" class="button_1" name="Submit"
						v-disabled="(buttonDis=='false')||!dycode" value="确认"
						v-click="toResult('img')">
				</div>
				<div v-show="authType==0&&Security=='05'&&transType!=2">
					<input type="submit" class="button_1" name="Submit"
						v-disabled='!keypassword' value="确认" v-click="toResult('img')">
				</div>
			</div>
		</form>
		<div class="zz_cont"><img src="images/ts.png" />
	<font class="tishi">
				温馨提示</br>
	</font>
	&nbsp;&nbsp;点击右上角<img style="background-color:#008de4;width:16px;margin-left:4px" src="images/feiyan.png" />，进入我的设置，可查询手机银行转账限额。</br>
	</div>
	</div>


	<!-- 转账结果页面 -->
	<div v-page v-transition="native" data-back="false" title="转给本行">
		<div class="bg_box">
			<div class="box_cont">
				<div class="selected">
					<span><img class="jindu" src="images/u1.png" /></span> <span><img
						class="jindu" src="images/u2.png" /></span> <span><img class="jindu" src="images/u3.png" /></span>
				</div>
				<div class="zz_cont">
					<div v-show="IsReward=='true'" class="maind" style="margin:0px">
						<div class="d1" style="float:left;padding-left:5px;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:left;width:50%;height:70px;  padding-top:10%;">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 交易成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{InnerResult.TransDate}}</div>
						</div>
						<div class="d3"  style="padding-top: 25px;float:left;width:20%;margin-left:-3%"><img  v-click="gotoRewardPage()" src="images/img_reward.gif" style="width:100px;height:60px;"/></div>
					</div>
					<div v-hide="IsReward=='true'">
						<div class="d1" style="float:left;padding-left:50px;;width:20%;padding-top:20px"><img src="images/cg_img.png" style="width:60px;height:60px"/></div>
						<div class="d2" style="float:right;width:50%;height:70px;  padding-top:10%;padding-right:30px">
							 <div style="  text-align: center;font-size:x-large;color:#0069c9"> 交易成功</div>
							<div class="transtime" style="padding-bottom:0px;padding-top:10px;font-size:inherit;">{{InnerResult.TransDate}}</div>
						</div>
					</div>
					<div class="resultForm">
						<ul>
							<li><em>付款人账号：</em><i>{{payCard.AcNo2}}</i></li>
							<li v-show="transType==1"><em>收款人账号：</em><i>{{rCard}}</i></li>
							<li v-show="transType==2"><em>收款人账号：</em><i>{{selfRCard.AcNo}}</i></li>
							<li v-show="transType==3"><em>收款手机号：</em><i>{{rPhone}}</i></li>
							<li v-show="transType==2"><em>收款人姓名：</em><i>{{cardInfo.AcName}}</i></li>
							<li v-hide="transType==2"><em>收款人姓名：</em><i>{{rName}}</i></li>
							<li><em>交易金额：</em><i>{{amount|number:2}}元</i></li>
							<li><em>转账用途：</em><i>{{yongtu}}</i></li>
							<li><em>电子回单号：</em><i>{{InnerResult.ECIPSerNo}}</i></li>
						</ul>
					</div>
					<div>
						<div class="content4_left content4_button"
							v-click="continueTrans()">继续转账</div>
						<div class="content4_right content4_button"
							v-click="toQueryTransInfo()">交易明细</div>
					</div>
				</div>

			</div>
		</div>
		
		<div class="zz_cont">
			<div style="font-size: 12px; line-height: 16px; color: #929292;">
			</div>
		</div>
	</div>
</div>
<div style="width:100%;height:40px"></div>

<script>
InnerTransferCtrl.$inject = ["$scope","$remote","$targets","$filter","$context","$timeout","$window"];
function InnerTransferCtrl($scope,$remote,$targets,$filter,$context,$timeout,$window){
	$scope.init=function(){
		$scope.dd=0;
		$scope.getClientState(function(response){
						var resJson=vx.fromJson(response);
						$scope.dd=resJson.Userinfo.ukeyType;
		});
		$scope.yongtu=="";
		$scope.payee=$context.getJson().selectedPayee;
		$scope.innerParam=$context.getJson().innerParam;
		$scope.buttonDis="false";
		//判断是否选定收款人
		if($scope.payee){
			$scope.rCard=$scope.payee.PayeeAcNo;
			$scope.rName=$scope.payee.PayeeAcName;
		}else{
			$scope.rCard=$scope.innerParam?$scope.innerParam.rCard:"";
			$scope.rName=$scope.innerParam?$scope.innerParam.rName:"";
		}
		
		//初始化表单数据
		$scope.transType=$scope.innerParam?$scope.innerParam.transType:"1";
		$scope.saveThis=$scope.innerParam?$scope.innerParam.saveThis:true;
		$scope.amount=$scope.innerParam?$scope.innerParam.amount:"";
		//查询借记卡
		$remote.post("/pmobile/ActListQry.do",{},function(data){
			//过滤器json添加一个acno1的字段，这里写麻烦了 可以用循环写
			$scope.acList=data.PayerList;
			console.log($scope.acList);
			var filterFn=$filter("filter");
			$scope.acList=filterFn($scope.acList,function(obj,text){
				if(obj.AcNo != undefined){
					obj.AcNo1=obj.AcNo.substring(0,4)+"****"+ obj.AcNo.substring(obj.AcNo.length-4);
					obj.AcNo2=obj.AcNo1;
					if(obj.AcAlias.length>4){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias.substring(0,4)+"...";
					}else if(obj.AcAlias.length<=4&&obj.AcAlias.length>0){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias;
					}else{
						obj.AcNo1=obj.AcNo1;
					}
					if($scope.innerParam){
						if($scope.innerParam.payCardAcNo==obj.AcNo){
							$scope.payCard=obj;
						}
					}else{
						var f=$context.getJson().toselectAcNo;//传送过来点击中的信用卡的卡号
						if(f){
							//在打开页面显示点击的信用卡卡号
							if(f==obj.AcNo){
								$scope.payCard=obj;
							}
						}
					}
					return true;
				}
			});
			$scope.mobileNo=data.MobilePhone;
			if(vx.isEmpty($scope.payCard)){
				$scope.payCard=$scope.acList[0];
			}
// 				if($scope.innerParam){
// 					vx.forEach($scope.acList,function(item){
// 						if($scope.innerParam.payCardAcNo==item.AcNo){
// 							$scope.payCard=item;
// 						}
// 					});
// 				}else{
// 					var f=$context.getJson().toselectAcNo;//传送过来点击中的信用卡的卡号
// 					if(f){
// 						//在打开页面显示点击的信用卡卡号
// 						vx.forEach($scope.acList,function(item){
// 							if(f==item.AcNo){
// 								$scope.payCard=item;
// 							}
// 						});
// 					}else{
// 						$scope.payCard=$scope.acList[0];
// 					}
				
// 				}
			//$scope.selfRCard=$scope.payCard;
			//$scope.payCard.AcNo=$filter("accountNo")($scope.payCard.AcNo);
			$scope.getCardInfo();
			//获取最后三笔转账
			$remote.post("/pmobile/ReceiptRollQry.do",{"TransType":0},function(data){
				$scope.last3List=data.List;
			});
		});
		
	}
	//监听滚动条滚动的高度
// 	$window.onscroll=function(){
// 		$scope.moveHeight=$(document).scrollTop();
// 	}
	//调用密码控件
	$scope.getPW=function(){
		$("#cardpassword").val("");
		$scope.buttonDis="false";
		var scrollHeight=$scope.getPWPosition($("#cardpassword").get(0));//定位当前密码输入栏位在文档中的位置
		if(vx.isDefined($scope.moveHeight)){
			scrollHeight=scrollHeight-$scope.moveHeight;//减去滚动条滚动的高度
		}
		$scope.getPassword(function(pwResponse){
			var resJson=vx.fromJson(pwResponse);
			if(resJson.Flag==0){
				$("#cardpassword").val(resJson.passWord);
			}else if(resJson.Flag==1){
				$scope.miwen=resJson.passWord;
				$scope.buttonDis = resJson.buttonDis;
			}
		},scrollHeight);
	}
	//跳转到交易明细
	$scope.toQueryTransInfo=function(){
		console.log($scope.payCard.AcNo);
		$context.setJson({"selectedAc":$scope.payCard.AcNo});
		$scope.goto("InnerTransfer","PTransInfoQry");
	}
	//跳转到抽奖页面
	$scope.gotoRewardPage=function(){
		$context.clear();
		if($scope.transType=="1"){
			$scope.TransName="cccccc";
		}else if($scope.transType=="2"){
			$scope.TransName="dddddd";
		}else if($scope.transType=="3"){
			$scope.TransName="eeeeee";
		}
		
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":$scope.TransName},function(data){
			if(data.GAMETYPE=="0"){
				var param={
						
						"ReWardCount":data.REWARDCOUNT,
						"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("LotteryDraw");
			}else if(data.GAMETYPE=="2"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("GuaGuaLe");
			}else if(data.GAMETYPE=="3"){
				var param={
						"ReWardCount":data.REWARDCOUNT,"TransName":data.TRANSNAME,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("YaoYiYao");
			}
		});
	}
	//刷新验证码
	$scope.freshCode=function(id){
		$remote.post("/pmobile/GenTokenImg.do?r"+Math.random(),{},function(data){
			$scope.TokenImg=data.imgKey;
		});
	}
	//获取手机动态码
	$scope.getMessageCode=function(){
		$scope.getMseCode(function(pwResponse){
			$("#dycode").val(pwResponse);
			$scope.dycode=pwResponse;
		});
	}
	//选择转账类型
	$scope.selected=function(value){
		$scope.amount="";
		var leftPx=value+"%";
		$(".prompt_arr").css("left",leftPx);
		if(value==45){
			if($scope.rAcList==""){
				NativeCall.toast("本人名下只有一张借记卡，不能进行同名转账");
			}
		}
	}
	//从最近三笔转账选定收款人
	$scope.selectedInput=function(obj){
		$scope.selectL3Payee=obj;
		$scope.rCard=obj.PayeeAcNo;
		$scope.rName=obj.PayeeAcName;
	}
	//显示最近三位联系人
	$scope.showLastTrans=function(){
		if(!$scope.rCard&&$scope.last3List!=""){
			$scope.ShowOrHide = true;
			$("#lastShowLi").addClass("noBottom");//去掉账号那一栏的底部border
// 			var item=$scope.last3List.length;
// 			if(item){
// 				$("#lastShowLi").css("height",35+30*item+"px");
// 			}
// 			$("#lasttrans").css("display","block");
		}
	}
	//隐藏最近三位联系人
	$scope.hideLastTrans=function(){
		$timeout(function(){
			$scope.ShowOrHide = false;
			$("#lastShowLi").removeClass("noBottom");
// 			$("#lastShowLi").css("height","auto");
// 			$("#lasttrans").css("display","none");
		},100);
	}
	//监听input框变化
	$scope.isHide=function(){
		if($scope.rCard){
			$scope.hideLastTrans();
		}else{
			$scope.showLastTrans();
		}
	}
	//改变支付卡
	$scope.getCardInfo=function(){
		var cardNo=$scope.payCard.AcNo;
		//查询余额
		$remote.post("/pmobile/ActBalQry.do",{"AcNo":cardNo},function(data){
			$scope.cardInfo=data;
			$scope.balance=data.AvailBal;
		});
		//转给本人时，过滤掉当前选中的付款账号
		if($scope.acList){
			var temp=[];
			vx.forEach($scope.acList,function(item){
				if($scope.payCard.AcNo!=item.AcNo){
					temp.push(item);
				}
			});
			$scope.rAcList=temp;
			if($scope.rAcList){
				$scope.selfRCard=$scope.rAcList[0];
			}
		}
	}
	//倒计时的回调函数
	$scope.getDYcode=function(){
		//行内他人、行内本人、手机号
		$scope.businessName="行内转账";
		var params={
				"BusinessName":$scope.businessName,
				"MobileNo":$scope.mobileNo,
				"ServiceCode":"DCA000001"
		}
		//获取手机动态码
		$remote.post("/pmobile/GenTokenName.do",params,function(data){
			$scope.msmNo=data.SerialNo;
		});
	}
	//查询收款人
	$scope.queryReciver=function(){
		//保存当前表单信息，从其他碎片页返回时使用，如查询收款人名册
		var param={
				"payCardAcNo":$scope.payCard.AcNo,
				"transType":$scope.transType,
				"saveThis":$scope.saveThis,
				"yongtu":$scope.yongtu,
				"rCard":$scope.rCard,
				"rName":$scope.rName,
				"amount":$scope.amount
		}
		$context.setJson({"innerParam":param});
		$context.setJson({"whoPBM":"inner"});
		$scope.goto("InnerTransfer","PayeeBook");
	}
	//查询通讯录
	$scope.queryiPhone=function(){
		$scope.getPhoneNumber(function(data){
			var resJson=vx.fromJson(data);
			$("#rName").val(resJson.PhoneName);
			$("#rPhone").val(resJson.PhoneNumber);
			$scope.rPhone=resJson.PhoneNumber;
			$scope.rName=resJson.PhoneName;
		});
	}
	
	//继续转账
	$scope.continueTrans=function(){
		$context.clear();
		$targets("content","#0");
	}
	//跳转到确认页面
	$scope.toConfirm=function(){
// 		var paramss={
// 				"PayeeAcNo":"1"
// 		};
// 		$scope.blueTooth(function(pwResponse){},vx.toJson(paramss));
		//初始化确认页面数据
		$scope.dycode="";
		$scope.cardpassword="";
		$scope.miwen="";
		$("#cardpassword").val("");
		$scope.imgcode="";
		$scope.keypassword="";
		$("#anniu").text("获取动态码");
		$("#anniu").css("background-color","#0084ff");
		if($scope.yongtu==null||$scope.yongtu==""){
			$scope.yongtu="转账"
		}
		if(parseFloat($scope.amount)>parseFloat($scope.balance)){
			NativeCall.toast("卡内余额不足！");
			return;
		}
		if(!$scope.transType=="2"){
			var reg1=new RegExp(/^[\u4E00-\u9FA5A-Za-z ]+$/);//姓名只能是中文字符或者英文字符
			if(!reg1.test($scope.rName)){
				NativeCall.toast("姓名只能为汉字或字母");
				return false;
			}
		}
		if($scope.amount){
			var pos=$scope.amount.toString().indexOf(".");
		}else{
			var pos=$scope.amount
		}
		if(pos>-1&&$scope.amount.length-pos>3){
			NativeCall.toast("金额格式有误，小数点后只能有两位小数");
			return false;
		}
		if(parseFloat($scope.amount)==0){
			NativeCall.toast("转账金额不能为0");
			return false;
		}
		var reg=new RegExp(/^[\u4E00-\u9FA5A-Za-z0-9]+$/);//u4e00-u9fa5---数字字母开头（包含汉字）
		if(!reg.test($scope.yongtu)){
			//alert("用途格式只能为汉字、数字或字母");
			NativeCall.toast("用途格式只能为汉字、数字或字母");
			return false;
		}
		$scope.params={
				"PayerAcNo":$scope.payCard.AcNo,
				"Amount":$scope.amount,
				"PayeeAcName":$scope.rName,
				"Currency":$scope.cardInfo.Currency,
				"Remark":$scope.yongtu,
				"Balance":$scope.cardInfo.Balance,
				"accountNo":$scope.rCard, //检验卡号
				"custName":$scope.rName   //检验用户名
		};
		if($scope.transType=="1"){
			$scope.transTypeCN="行内";
			$scope.rCard=$scope.rCard+"";
			//信用卡区分老卡和新卡。老卡包括：贷记卡、准贷记卡和公务卡，分别以'622462'、'625101'和'628272'开头，新卡包括'625165'开头
			if($scope.rCard.substring(0,6)=="622462"||$scope.rCard.substring(0,6)=="625101"||$scope.rCard.substring(0,6)=="628272"){
				$scope.flag=0;//0-老卡，1-新卡
			}else if($scope.rCard.substring(0,6)=="625165"){
				$scope.flag=1;//0-老卡，1-新卡
			}
			if($scope.flag==0||$scope.flag==1){//行内信用卡还款
				var params={
						"PayerAcNo":$scope.payCard.AcNo,
						"Amount":$scope.amount,
						"PayeeAcNo":$scope.rCard,
						"PayeeAcName":$scope.rName,
						"TranType":"F",//F-还本行他人信用卡,G-自助还款
						"accountNo":$scope.rCard, //检验卡号
						"custName":$scope.rName   //检验用户名
				};
				$scope.InnerCredTransConfirm(params);//还他人信用卡确认交易
				
			}else{//给本行他人转账，非信用卡
				$scope.params.PayeeAcNo=$scope.rCard;
				$scope.params.IsSave=$scope.saveThis?1:0;
				
				$scope.InnerTransConfirm($scope.params);//行内非他人信用卡确认交易
			}
		}else if($scope.transType=="2"){
			$scope.transTypeCN="同名";
			$scope.params.PayeeAcNo=$scope.selfRCard.AcNo;
			$scope.params.PayeeAcName=$scope.cardInfo.AcName;
			$remote.post("/pmobile/BankSameNameTransferConfirm.do",$scope.params,function(data){
				if($scope.yongtu==null||$scope.yongtu==""){
					$scope.yongtu="转账"
				}
				$targets("content","#2");
				$remote.post("/pmobile/GenTokenImg.do",{},function(data){
					$scope.TokenImg=data.imgKey;
				});
			});	
		}else{
			$scope.transTypeCN="手机号";
			$scope.params.MobilePhone=$scope.rPhone;
			$scope.params.IsSave=$scope.saveThis?1:0,
			//验证手机号码
			$remote.post("/pmobile/MobilePhoneAuthorityQry.do",{"MobilePhone":$scope.rPhone,"PayeeAcName":$scope.rName},function(data){
				console.log(data);
				if(data.Flag==1){
					$scope.PhoneTransConfirm($scope.params);//行内手机号转账确认交易
				}else if(data.Flag==0){
					$scope.alert("收款人手机号未签约");
					//toast改手机号未签约
				}else if(data.Flag==2){
					$scope.alert("户名不符");
				}
			});
		}
	}
	//行内转他人(非他人信用卡)确认
	$scope.InnerTransConfirm=function(params){
		$remote.post("/pmobile/BankInnerTransferConfirm.do",params,function(data){
			$scope.authType=data.Flag;
			$scope.Security=data.Security;
			$scope._tokenName=data._tokenName;
			if($scope.authType==2||($scope.authType==0&&$scope.Security=="07")){
				$scope.getMessageCode();//启动监听手机动态码
			}
			if(data._RejCode=="ECIP0023"||data._RejCode=="ECIP0024"){
				$scope.confirm("超过当前认证方式限额，是否切换认证方式为音频KEY？",function(){
					$remote.post("/pmobile/ChannelAuthTypeUpd.do",{"security":"05"},function(data){
						if(data._RejCode=="000000"){
							if($scope.dd==2){
								$scope.blueTooth(function(){
							 	},{});
							}
							$scope.changeClientInfo(vx.toJson({"Security":"05"}));//修改登录信息
							$scope.InnerTransConfirm(params);
						}
					});
				},null);
			}else{
				if($scope.yongtu==null||$scope.yongtu==""){
					$scope.yongtu="转账"
				}
				if($scope.authType==0&&$scope.Security=='05'){
					if($scope.dd==2){
						$scope.blueTooth(function(){
					 	},{});
					}
				}
				$targets("content","#2");
			}
			$remote.post("/pmobile/GenTokenImg.do",{},function(data){
				$scope.TokenImg=data.imgKey;
			});
		});
	}
	//行内转他人（信用卡）确认
	$scope.InnerCredTransConfirm=function(params){
		$remote.post("/pmobile/PayforOtherCreditConfirm.do",params,function(data){
				if(data._RejCode=="ECIP0023"||data._RejCode=="ECIP0024"){
					$scope.confirm("超过当前认证方式限额，是否切换认证方式为音频KEY？",function(){
						$remote.post("/pmobile/ChannelAuthTypeUpd.do",{"security":"05"},function(data){
							if(data._RejCode=="000000"){
								if($scope.dd==2){
									$scope.blueTooth(function(){
								 	},{});
								}
								$scope.changeClientInfo(vx.toJson({"Security":"05"}));//修改登录信息
								$scope.InnerCredTransConfirm(params);
							}
						});
					},null);
				}else{
					$scope._tokenName=data._tokenName;
					$scope.Security=data.Security;
					$scope.authType=data.Flag;//0:当前认证方式；1：小额免密；2：手机动态密码 空：不需要认证方式
					if($scope.yongtu==null||$scope.yongtu==""){
						$scope.yongtu="转账"
					}
					if($scope.authType==0&&$scope.Security=='05'){
						if($scope.dd==2){
							$scope.blueTooth(function(){
						 	},{});
						}
					}
					$targets("content","#2");
				}
		});
	}
	//行内手机号转账
	$scope.PhoneTransConfirm=function(params){
		$remote.post("/pmobile/MobilePhoneTransferConfirm.do",params,function(data){
			$scope.authType=data.Flag;
			$scope.Security=data.Security;
			$scope._tokenName=data._tokenName;
			if($scope.authType==2||($scope.authType==0&&$scope.Security=="07")){
				$scope.getMessageCode();//启动监听手机动态码
			}
			if(data._RejCode=="ECIP0023"||data._RejCode=="ECIP0024"){
				$scope.confirm("超过当前认证方式限额，是否切换认证方式为音频KEY？",function(){
					$remote.post("/pmobile/ChannelAuthTypeUpd.do",{"security":"05"},function(data){
						if(data._RejCode=="000000"){
							if($scope.dd==2){
								$scope.blueTooth(function(){
							 	},{});
							}
							$scope.changeClientInfo(vx.toJson({"Security":"05"}));//修改登录信息
							$scope.PhoneTransConfirm(params);
						}
					});
				},null);
			}else{
				if($scope.yongtu==null||$scope.yongtu==""){
					$scope.yongtu="转账"
				}
				if($scope.authType==0&&$scope.Security=='05'){
					if($scope.dd==2){
						$scope.blueTooth(function(){
					 	},{});
					}
				}
				$targets("content","#2");
			}
			$remote.post("/pmobile/GenTokenImg.do",{},function(data){
				$scope.TokenImg=data.imgKey;
			});
		});	
	}
	
	//跳转到结果页
	$scope.toResult=function(id){//---id参数用来标示提交错误时刷新图片验证码
		if($scope.transType=="1"){
			$scope.TransName="cccccc";
		}else if($scope.transType=="2"){
			$scope.TransName="dddddd";
		}else if($scope.transType=="3"){
			$scope.TransName="eeeeee";
		}
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":$scope.TransName},function(data){
			$scope.IsReward=data.ISREWARD;
		});
			//确定认证方式
			if($scope.authType==0){//当前认证方式
				if($scope.Security=="05"){//音频key
					if($scope.transType==2){
						$scope.recAccountNo=$scope.selfRCard.AcNo;
						$scope.recAccountName=$scope.cardInfo.AcName;
					}else{
						$scope.recAccountNo=$scope.rCard;
						$scope.recAccountName=$scope.rName;
					}
				
					if($scope.transType=="1"){
						if($scope.flag==0||$scope.flag==1){//行内信用卡还款
							//音频PKY制签名需要的数据
							var inputData={"recAccountNo":$scope.rCard,"recAccountName":$scope.rName,"tranAmount":$scope.amount,
									"accountNo":$scope.payCard.AcNo,"currencyType":$scope.RMBChange($scope.cardInfo.CurrencyName)};
							var sourceField = "信用卡卡号#"+inputData.recAccountNo+"|信用卡户名#"+inputData.recAccountName+"|还款金额#"+inputData.tranAmount+"|付款人账号#"+inputData.accountNo;
							//调用音频KEY字段转换xml格式的方法
							var sinData = $scope.getSignSourceValue(sourceField,"币种#"+inputData.currencyType);
							var subData={"sinData":sinData,"YPKPassword":$scope.keypassword};
							//通过原生调用音频key
							$scope.getSignData(function(outputdata){
								var signData=outputdata;
								if(!signData){
									$scope.keypassword="";
									return false;
								}
								params={
										"PayerAcNo":$scope.payCard.AcNo,
										"Amount":$scope.amount,
										"PayeeAcNo":$scope.rCard,
										"PayeeAcName":$scope.rName,
										"TranType":"F",
										"_tokenName":$scope._tokenName,
										"TrsPassword":$scope.miwen,
										"SerialNo":$scope.msmNo,
										"SmsCode":$scope.dycode,
										"SignData":signData
								};
								$scope.PaySBCredit(params);
							},vx.toJson(subData));
						}else{
							//音频PKY制签名需要的数据
							var inputData={"recAccountNo":$scope.recAccountNo,"recAccountName":$scope.recAccountName,"tranAmount":$scope.amount,
									"accountNo":$scope.payCard.AcNo,"currencyType":$scope.RMBChange($scope.cardInfo.CurrencyName),"payUse":$scope.yongtu};
							var sourceField = "收款人账号#"+inputData.recAccountNo+"|收款人户名#"+inputData.recAccountName+"|转账金额#"+inputData.tranAmount+"|付款人账号#"+inputData.accountNo;
							//调用音频KEY字段转换xml格式的方法
							var sinData = $scope.getSignSourceValue(sourceField,"币种#"+inputData.currencyType+"|用途#"+inputData.payUse);
							var subData={"sinData":sinData,"YPKPassword":$scope.keypassword};
							//通过原生调用音频key
							$scope.getSignData(function(outputdata){
								$scope.signData=outputdata;
								$scope.InnerToOthers();
							},vx.toJson(subData));
						}
												
					}else if($scope.transType=="3"){
						//音频PKY制签名需要的数据
						var inputData={"rPhone":$scope.rPhone,"recAccountName":$scope.recAccountName,"tranAmount":$scope.amount,
								"accountNo":$scope.payCard.AcNo,"currencyType":$scope.RMBChange($scope.cardInfo.CurrencyName),"payUse":$scope.yongtu};
						var sourceField = "收款人手机号码#"+inputData.rPhone+"|收款人户名#"+inputData.recAccountName+"|转账金额#"+inputData.tranAmount+"|付款人账号#"+inputData.accountNo;
						//调用音频KEY字段转换xml格式的方法
						var sinData = $scope.getSignSourceValue(sourceField,"币种#"+inputData.currencyType+"|用途#"+inputData.payUse);
						var subData={"sinData":sinData,"YPKPassword":$scope.keypassword};
						//通过原生调用音频key
						$scope.getSignData(function(outputdata){
							$scope.signData=outputdata;
							$scope.InnerPhoneTrans();
						},vx.toJson(subData));
						
					}
					
				}else if($scope.Security=="07"){//手机动态码+卡密码
					$scope.params.TrsPassword=$scope.miwen;
					$scope.params.SmsCode=$scope.dycode;
					$scope.params.SerialNo=$scope.msmNo;
				}
			}else if($scope.authType==2){//手机动态码
				$scope.params.SmsCode=$scope.dycode;
				$scope.params.SerialNo=$scope.msmNo;
			}
	
	
	
			if($scope.transType=="1"){//行内转账
				if($scope.Security!="05"||$scope.authType!=0){
					$scope.InnerToOthers();
				}
			}else if($scope.transType=="2"){//同名转账
				$scope.params.IsSave=$scope.saveThis?1:0;
				$scope.params._vTokenName=$scope.imgcode;
				$remote.post("/pmobile/BankSameNameTransfer.do",$scope.params,function(data){
					console.log(data);
					if(data._RejCode=="000000"){
						$scope.InnerResult=data;
						$targets("content","#3");
						NativeCall.history = [];
						NativeCall.pages=[];
					}
				},function(data){ 
					if(data.jsonError&&data.jsonError[0]){
						$scope.alert(data.jsonError);
					}
					//初始化密码
					$scope.cardpassword="";
					$("#cardpassword").val("");
					$scope.miwen="";
					$scope.getToken();
					$scope.freshCode(id);
					return data.jsonError;
				});
			}else{//手机号转账
				if($scope.Security!="05"||$scope.authType!=0){
					$scope.InnerPhoneTrans();
				}
			}
	}
	//行内转他人
	$scope.InnerToOthers=function(){
		$scope.params._tokenName=$scope._tokenName;
		$scope.params.SignData=$scope.signData;
		//音频KEY使用原生交互实现，因此只有调用成功或者未使用音频KEY，才发送该交易
		if($scope.flag==0||$scope.flag==1){//行内信用卡还款
			var params={
					"PayerAcNo":$scope.payCard.AcNo,
					"Amount":$scope.amount,
					"PayeeAcNo":$scope.rCard,
					"PayeeAcName":$scope.rName,
					"TranType":"F",
					"_tokenName":$scope._tokenName,
					"TrsPassword":$scope.miwen,
					"SerialNo":$scope.msmNo,
					"SmsCode":$scope.dycode,
			};
			$scope.PaySBCredit(params);
		}else{
			$remote.post("/pmobile/BankInnerTransfer.do",$scope.params,function(data){
				console.log(data);
				if(data._RejCode=="000000"){
					$scope.InnerResult=data;
					$targets("content","#3");
					NativeCall.history = [];//清空历史，点击左上角返回时，可直接返回原生菜单
					NativeCall.pages=[];
				}
			},function(data){
				if(data.jsonError){
					$scope.alert(data.jsonError);
				}
				//初始化密码
				$scope.cardpassword="";
				$("#cardpassword").val("");
				$scope.miwen="";
				$scope.keypassword="";
				$scope.getToken();
				return data.jsonError;
			});
		}
		
	}
	//行内手机号转账
	$scope.InnerPhoneTrans=function(){
		$scope.params._tokenName=$scope._tokenName;
		$scope.params.SignData=$scope.signData;
		//$scope.params.TrsPassword=$scope.miwen;
		//$scope.params.SmsCode=$scope.dycode;
		//$scope.params.SerialNo=$scope.msmNo;
		$remote.post("/pmobile/MobilePhoneTransfer.do",$scope.params,function(data){
			if(data._RejCode=="000000"){
				$scope.InnerResult=data;
				$targets("content","#3");
				NativeCall.history = [];
				NativeCall.pages=[];
			}
		},function(data){
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			//初始化密码
			$scope.cardpassword="";
			$("#cardpassword").val("");
			$scope.miwen="";
			$scope.keypassword="";
			$scope.getToken();
			return data.jsonError;
		});
	}
	//还他人信用卡
	$scope.PaySBCredit=function(params){
		$remote.post("/pmobile/PayforOtherCredit.do",params,function(data){
			$scope.InnerResult=data;
			$targets("content","#3");
		},function(data){
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			$scope.keypassword="";
			$scope.dycode="";
			$("#cardpassword").val("");
			$scope.miwen="";
			$scope.getToken();
			return data.jsonError;
		});
	}
}
</script>