<div v-view-setup="PPayinfoCtrl" v-init="init()">
	<div v-page v-transition="native" title="缴费明细">
		<div class="bg_box">
			<div class="box_cont">
				<div class="zz_cont">
				      <ul>
							<li>
								<em>账号：</em>
								<i>
									<select v-model="queryAc" name="queryAc" v-options="ac.AcNo1 for ac in acList" >
									</select>
								</i>
							</li>
<!-- 							<li> -->
<!-- 								<em>用户号：</em> -->
<!-- 								<i> -->
<!-- 									<input v-model="pactno" name="pactno" placeholder="请输入缴费用户号" class="y_srk" required></input> -->
<!-- 								</i> -->
<!-- 							</li> -->
							<li>
								<em>开始日期：</em>
								<i style="padding-top:8px">
									<input type="date" name="beginDate" id="beginDate" placeholder="请选择开始日期" v-model="beginDate"  style="height:20px;margin-top:10px" class="y_srk" >
								</i>
							</li>
							<li>
								<em>结束日期：</em>
								<i style="padding-top:8px">
									<input type="date" name="endDate" id="beginDate" placeholder="请选择结束日期" v-model="endDate" style="height:20px;margin-top:10px" class="y_srk">
								</i>
							</li>
							<li>
								<em>缴费类型：</em>
								<i>
									<select   v-model="transType" name="transType" v-options="tt.name for tt in transTypeList" >
									</select>
								</i>
							</li>
					 </ul>
					<div>
			     		<input type="submit"  class="button_1" name="Submit" value="查询" v-click="toResult()">
			     		<input type="submit"  class="button_3" value="只查当日" v-click="toResult('today')">&nbsp;
			     		<input type="submit" class="button_3" value="最近一月" v-click="toResult('month')">
			     		<input type="submit" class="button_3 floatright" name="Submit" value="最近三月" v-click="toResult('threemonth')">
			     	</div>
			    </div>
			    <!-- <div class="zz_cont">
				      <ul>
							<li><em>交易摘要：</em><i></i></li>
							<li><em>金额：</em><i></i></li>
							<li><em>账户余额：</em><i style="color:#ff6000;"></i></li>
				            <li><em>交易时间：</em><i></i></li>
					  </ul>
			     </div> -->
			</div>
		</div>
		<div v-show="transInfoList.length>0" v-more-page="transInfo in transInfoList">
			     <div class="khh" v-click="toTransDetail(transInfo)">
			     <div class="xiangq_img1"  ><a href="#"><img src="images/more.png"/></a></div>
			      <ul>
<!-- 			      		<li><em style="width:30%">用户号：</em><i style="width:60%;float:right;margin-right:5%">{{transInfo.pactno}}</i></li> -->
						<li><em style="width:50%">{{transInfo.pactno}}&nbsp;&nbsp;</em>
						<i style="width:45%;float:right;margin-right:5%">{{transInfo.payAmount|number:2}}元</i>
<!-- 						<b v-class="{'col8080':transInfo.CDFlag=='D','colbf07':transInfo.CDFlag=='C'}">{{transInfo.payAmount|number:2}}元</b> -->
<!-- 							<i style="width:45%;float:right;margin-right:5%" v-show="transInfo.state=='30'">交易状态：失败</i> -->
<!-- 							<i style="width:45%;float:right;margin-right:5%" v-show="transInfo.state=='99'">交易状态：处理中</i> -->
<!-- 							<i style="width:45%;float:right;margin-right:5%" v-show="transInfo.state=='20'">交易状态：成功</i> -->
							</li>
						<li><em style="width:30%" v-show="transInfo.state=='30'">失败</em>
							<em style="width:30%" v-show="transInfo.state=='99'">处理中</em>
							<em style="width:30%" v-show="transInfo.state=='20'">成功</em>
						<i style="width:60%;float:right;margin-right:5%">{{transInfo.OrigTxnTm|formatDateTime}}</i></li>
				  </ul>
		    	</div>
		</div>
		<div  v-show="transInfoList.length<=0"  style="font-size:15px;text-align:center;padding-top:20px;">
				很抱歉，未查询到缴费记录！
		</div>
					<div >
			     		<input type="submit" id="nextButton"  class="button_1" name="Submit" value="查看更多" v-click="PAGE.moreNextPage()">
			     	</div>
<!-- 		<div v-click="queryMore()" style="text-align: center"> -->
<!-- 		    	<ul><li><a href="#"> -->
<!-- 		    	{{message}} -->
<!-- 		    	</a> -->
<!-- 		    	</li></ul> -->
<!-- 		    	</div> -->
			<div class="zz_cont"><img src="images/ts.png" />
		    <font class="tishi">
				温馨提示</br>
			</font>
				&nbsp;&nbsp;1、您可以查询已添加账户的交易明细信息，请输入正确的查询条件。</br>
				&nbsp;&nbsp;2、查询日期时间跨度最多为3个月。</br>
				&nbsp;&nbsp;3、点击右上角<img style="background-color:#008de4;width:16px;margin-left:4px" src="images/feiyan.png" />，进入我的设置，可查询手机银行转账限额。</br>
			<div style="font-size:12px; line-height:16px; color:#929292;"> </div>
	 	  </div> 
	</div>
	
	<!-- 交易明细详情页面 -->
	<div  v-page  v-transition="native">
			<div class="bg_box"   title="交易详情">
				 <div class="box_cont">
		     		 <div class="zz_cont">
			    	  <ul>
						<li><em>付款人账号：</em><i>{{trans.accountNo}}</i></li>
						<li><em>缴费用户号：</em><i>{{trans.pactno}}</i></li>
						<li><em>交易时间：</em><i>{{trans.OrigTxnTm|formatDateTime}}</i></li>
						<li><em>交易金额：</em><i style="color:red;">{{trans.payAmount|number:2}}元</i></li>
						<li><em>备注：</em><i>{{trans.remark}}</i></li>
<!-- 			            <li><em>交易备注：</em><i>{{trans.tranDescrition}}</i></li> -->
				 	 </ul>
		      		 </div>
		 		</div>
			</div>
	</div>
	<div style="width:100%;height:40px;"></div>
</div>
<script>
PPayinfoCtrl.$inject = ["$scope","$remote","$targets","$context","$filter"];
function PPayinfoCtrl($scope,$remote,$targets,$context,$filter){
	
	$scope.init=function(){
		$scope.message="";
		$scope.selectedAc=$context.getJson().selectedAc;
		$remote.post("/pmobile/ActListQry.do",{},function(data){
			$scope.acList=data.AcList;
			var filterFn=$filter("filter");
			$scope.acList=filterFn($scope.acList,function(obj,text){
				if(obj.AcNo != undefined){
					obj.AcNo1=obj.AcNo.substring(0,4)+"****"+ obj.AcNo.substring(obj.AcNo.length-4)
					if(obj.AcAlias.length>4){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias.substring(0,4)+"...";
					}else if(obj.AcAlias.length<=4&&obj.AcAlias.length>0){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias;
					}else{
						obj.AcNo1=obj.AcNo1;
					}
					return true;
				}
			});
			if($scope.selectedAc){
				vx.forEach($scope.acList,function(item){
					if($scope.selectedAc==item.AcNo){
						$scope.queryAc=item;
					}
				});
			}else{
				$scope.queryAc=data.AcList[0];
			}
		});
		
		$scope.transTypeList=[
						{
							"name":"水费",
							"tranType":"1"
						},{
							"name":"电费",
							"tranType":"2"
						},{
							"name":"固话",
							"tranType":"3"
						},{
							"name":"手机充值",
							"tranType":"4"
						}
				];
		$scope.transType=$scope.transTypeList[0];
		
		//获取服务器当前时间
		$remote.post("/pmobile/GenTimeStamp.do",{},function(data){
			var serviceTime=data._sysDate;
			$scope.beginDate=$scope.formartDate(serviceTime,-7,"-");
			$scope.endDate=$scope.formartDate(serviceTime,0,"-");
			$scope.currentDate=$scope.endDate;
		});
		/* $scope.$watch('beginDate',function(newValue,oldValue){
			$scope.endDate=$scope.getEndDate(newValue);
		}); */
		
	}
	//获取最大截止日期    --最大跨度三个月
	$scope.getEndDate=function(beginDate){
		if(!beginDate){
			return;
		}
		var temps=beginDate.split("-");
		var yyyy=parseInt(temps[0]);
		var mm=parseInt(temps[1])+3;
		var dd=temps[2];
		if(mm>12){
			mm=mm-12;
			yyyy=yyyy+1;
		}
		$scope.endDateKD=yyyy+"-"+mm+"-"+dd;
	}
	//校验日历控件输入起始日期和结束日期的正确性
	$scope.compareDate=function(){
	}
	$scope.aaaa =function(){
		alert("sdfsdfdf");
	}
    //查询
	$scope.toResult=function(id){
// 		$scope.message="";
		if(id=="today"){
			$scope.beginDate=$scope.currentDate;
		}else if(id=="month"){
			$scope.beginDate=$scope.formartDate($scope.currentDate,-30,"-");
		}else if(id=="threemonth"){
			$scope.beginDate=$scope.formartDate($scope.currentDate,-90,"-");
		}
		var params={
				"AcNo":$scope.queryAc.AcNo,
				"pactno":$scope.pactno,
				"tranType":$scope.transType.tranType,
				"BeginDate":$scope.formartDate($scope.beginDate,0),
				"EndDate":$scope.formartDate($scope.endDate,0),
				"currentIndex":1
			}
		//为查看更多整理数据
		$scope.finalcurrentIndex=1;
		$scope.finalAcNo=$scope.queryAc.AcNo;
		$scope.finalpactno=$scope.pactno;
		$scope.finalserviceCode=$scope.transType.tranType;
		$scope.finalBeginDate=$scope.formartDate($scope.beginDate,0);
		$scope.finalEndDate=$scope.formartDate($scope.endDate,0);
		$remote.post("/pmobile/PayinfoQry.do",params,function(data){
			if(data._RejCode="000000"){
				$scope.transInfoList=data.List;
				console.log($scope.transInfoList);
				$scope.totalnumber = data.totalNum;//总条数
				$scope.currentIndex = 1;
// 				if($scope.transInfoList.length==10)
// 					$scope.message="点击查看更多";
			}
		},function(data){
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			$scope.transInfoList=[];
		});
	}
	$scope.toTransDetail=function(transInfo){
		$targets("content","#2");
		$scope.trans=transInfo;
	}
// 	$scope.queryMore=function(){
// 		$scope.message="";
// 		$scope.finalcurrentIndex=$scope.finalcurrentIndex+1;
// 		var params={
// 				"AcNo":$scope.finalAcNo,
// 				"BeginDate":$scope.finalBeginDate,
// 				"EndDate":$scope.finalEndDate,
// 				"CDFlag":$scope.finalCDFlag,
// 				"currentIndex":$scope.finalcurrentIndex,
// 				"List":$scope.transInfoList
// 			}
// 		$remote.post("/pmobile/TransDetailQry.do",params,function(data){
// 			if(data._RejCode="000000"){
// 				$scope.transInfoList=data.List;
// 				console.log(data);
// 				if($scope.transInfoList.length==$scope.finalcurrentIndex*10)
// 					$scope.message="点击查看更多";
// 			}
// 		},function(data){
// 			if(data.jsonError){
// 				$scope.alert(data.jsonError);
// 			}
// 			$scope.transInfoList=[];
// 		});
// 	}
	$scope.morepage = function(qishi,zhongzhi,zengliang,list){
		$scope.start=1;//不是第一次进入
		var formData = {
				"pactno":$scope.finalAcNo,
				"tranType":$scope.finalserviceCode,
				"AcNo":$scope.finalAcNo,
				"BeginDate":$scope.finalBeginDate,
				"EndDate":$scope.finalEndDate,
				"currentIndex":$scope.currentIndex+1
		};
		$remote.post("/pmobile/PayinfoQry.do", formData, function(data) {
			$scope.transInfoList=data.List;
			$scope.currentIndex=$scope.currentIndex+1;
		});
	};
	
}
</script>