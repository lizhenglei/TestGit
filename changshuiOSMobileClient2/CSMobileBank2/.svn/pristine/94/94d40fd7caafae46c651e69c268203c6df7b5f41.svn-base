<div v-view-setup="EwmTransferCtrl" v-init="init()">
	<!-- 转账录入页面 -->
	<div v-page v-transition="native">
		<form name="transInput" class="bg_box">
			<div class="box_cont">

				<div class="selected">
					<span><img class="jindu" src="images/u1.png" /></span> <span><img
						class="jindu" src="images/u2_1.png" /></span> <span><img
						class="jindu" src="images/u3_1.png" /></span>
				</div>

				<div class="zz_cont">
					<!-- 					<div> -->
					<!-- 						<img src="images/tpa.jpg" -->
					<!-- 							style="width: 250px; height: 200px; padding-left: 20px; padding-bottom: 0px;"> -->
					<!-- 					</div> -->
					<ul>
						<li><em>付款账号：</em> <i> <select v-change="getCardInfo()"
								v-model="payCard" name="payCard"
								v-options="ac.AcNo1 for ac in acList">
							</select>
						</i></li>
						<li><em>可用余额：</em> <i class="colff6"
							ui-money='{"amounts":"balance"}'></i></li>
						<!--						<li> -->
						<!-- 							<em>币种：</em>  -->
						<!-- 							<i>{{cardInfo.CurrencyName}}</i>  -->
						<!--  						</li>  -->
						<li><em>收款人账号：</em> <i>{{rCard}}</i></li>
						<li><em>收款人姓名：</em> <i>{{rName}}</i></li>
						<!-- 						<li > -->
						<!-- 							<em>保存收款人：</em> -->
						<!-- 							<i class="colff6"> -->
						<!-- 								<input type="checkbox" name="saveThis" v-model="saveThis" class="checkbox"> -->
						<!-- 							</i> -->
						<!-- 						</li> -->

						<li><em>转账金额：</em> <i class="colff6"> <input
								type="text" placeholder="请输入转账金额" name="amount"
								v-model="amount"
								ui-num='{"maxlength":11,"hasDot":true,"tip":"转账金额"}'
								class="y_srk" required>
						</i></li>

						<li><em>转账用途：</em> <i class="colff6"> <input type="text"
								placeholder="转账" name="yongtu" v-model="yongtu" class="y_srk">
						</i></li>

					</ul>
				</div>

				<input type="button" class="button_1" name="button" value="转账"
					v-disabled="!amount" v-click="toConfirm()">

			</div>
		</form>
	</div>

	<!-- 转账确认页面 -->
	<div v-page v-transition="native">
		<form name="transConfirm" class="bg_box">
			<div class="box_cont">
				<div class="selected">
					<span><img class="jindu" src="images/u1.png" /></span> <span><img
						class="jindu" src="images/u2.png" /></span> <span><img
						class="jindu" src="images/u3_1.png" /></span>
				</div>
				<div class="zz_cont">
					<ul>
						<li><em>付款账号：</em><i>{{payCard.AcNo1|accountNo}}</i></li>
						<li><em>收款人账号：</em><i>{{rCard|accountNo}}</i></li>
						<li><em>收款人姓名：</em><i>{{rName}}</i></li>
						<li><em>转账金额：</em><i style="color: #ff6000;">{{amount|number:2}}元</i></li>
						<li><em>金额大写：</em><i>{{amount|amount}}</i></li>
						<li><em>转账用途：</em><i style="color: #ff6000;">{{yongtu}}</i></li>

					</ul>
				</div>
				<div class="zz_cont">
					<ul>
						<li v-show="authType==2"><em>手机动态码：</em> <i> <input
								type="tel" id="dycode" name="dycode" v-model="dycode"
								maxlength=6 class="y_srk_50" placeholder="请输入动态码" />
								<button id="anniu" class="inp_butt" v-sms="getDYcode()">获取动态码</button>
						</i></li>
						<li v-show="authType==0&&Security=='07'"><em>卡密码：</em> <i><input
								id="cardpassword" type="password" name="cardpassword"
								class="y_srk" placeholder="请输入密码" v-click="getPW()" readonly /></i>
						</li>
						<li v-show="authType==0&&Security=='07'"><em>手机动态码：</em> <i>
								<input type="tel" id="dycode" name="dycode" v-model="dycode"
								maxlength=6 class="y_srk_50" placeholder="请输入动态码" />
								<button id="anniu" class="inp_butt" v-sms="getDYcode()">获取动态码</button>
						</i></li>
						<li v-show="authType==''"><em>验证码：</em> <i><input
								type="tel" id="imgcode" name="imgcode" maxlength=4
								v-model="imgcode" class="y_srk" placeholder="请输入验证码"
								style="width: 50%;" /></i> <img id="img" name="img" v-model="img"
							src="data:image/png;base64,{{TokenImg}}"
							data-ke-src="data:image/png;base64,{{TokenImg}}"
							style="position: relative; left: 40%; margin-top: 3%"
							v-click="freshCode('img')"></li>
						<li v-show="authType==0&&Security=='05'"><em>音频Key密码：</em> <i><input
								id="keypassword" type="password" name="keypassword"
								v-model="keypassword" class="y_srk" placeholder="请输入音频Key密码" /></i>
						</li>
					</ul>
				</div>
				<div v-show="authType==null">
					<input type="submit" class="button_1" name="Submit"
						v-disabled='!imgcode' value="确认" v-click="toResult('img')">
				</div>
				<div v-show="authType==2">
					<input type="submit" class="button_1" name="Submit"
						v-disabled='!dycode' value="确认" v-click="toResult('img')">
				</div>
				<div v-show="authType==0&&Security=='07'">
					<input type="submit" class="button_1" name="Submit"
						v-disabled="!dycode||(buttonDis=='false')" value="确认"
						v-click="toResult('img')">
				</div>
				<div v-show="authType==0&&Security=='05'">
					<input type="submit" class="button_1" name="Submit"
						v-disabled='!keypassword' value="确认" v-click="toResult('img')">
				</div>
			</div>
		</form>
	</div>

	<!-- 转账结果页面 -->
	<div v-page v-transition="native" data-back="false">
		<div class="bg_box">
			<div class="box_cont">
				<div class="selected">
					<span><img class="jindu" src="images/u1.png" /></span> <span><img
						class="jindu" src="images/u2.png" /></span> <span><img
						class="jindu" src="images/u3.png" /></span>
				</div>
				<div class="zz_cont">
					<div v-show="IsReward=='true'" class="maind" style="margin: 0px">
						<div class="d1"
							style="float: left; padding-left: 5px; width: 20%; padding-top: 20px">
							<img src="images/cg_img.png" style="width: 60px; height: 60px" />
						</div>
						<div class="d2"
							style="float: left; width: 50%; height: 70px; padding-top: 9%;">
							<div
								style="text-align: center; font-size: x-large; color: #0069c9">
								交易成功</div>
							<div class="transtime"
								style="padding-bottom: 0px; padding-top: 10px; font-size: inherit;">{{InnerResult.TransDate}}</div>
						</div>
						<div class="d3"
							style="padding-top: 25px; float: left; width: 20%; margin-left: -3%">
							<img v-click="gotoRewardPage()" src="images/img_reward.gif"
								style="width: 100px; height: 60px;" />
						</div>
					</div>
					<div v-hide="IsReward=='true'">
						<div class="d1"
							style="float: left; padding-left: 50px;; width: 20%; padding-top: 20px">
							<img src="images/cg_img.png" style="width: 60px; height: 60px" />
						</div>
						<div class="d2"
							style="float: right; width: 50%; height: 70px; padding-top: 9%; padding-right: 30px">
							<div
								style="text-align: center; font-size: x-large; color: #0069c9">
								交易成功</div>
							<div class="transtime"
								style="padding-bottom: 0px; padding-top: 10px; font-size: inherit;">{{InnerResult.TransDate}}</div>
						</div>
					</div>
					<div class="resultForm">
						<ul>
							<li><em>付款人账号：</em><i>{{payCard.AcNo|accountNo}}</i></li>
							<li><em>收款人账号：</em><i>{{rCard|accountNo}}</i></li>
							<li><em>收款人姓名：</em><i>{{rName}}</i></li>
							<li><em>交易金额：</em><i>{{amount|number:2}}元</i></li>
							<li><em>转账用途：</em><i>{{yongtu}}</i></li>
							<li><em>电子回单号：</em><i>{{InnerResult.ECIPSerNo}}</i></li>
						</ul>
					</div>
					<div>
						<div class="content4_left content4_button"
							v-click="continueTrans()">继续转账</div>
						<div class="content4_right content4_button"
							v-click="toQueryTransInfo()">交易明细</div>
					</div>
				</div>

			</div>
		</div>
		<div class="zz_cont">
			<div style="font-size: 12px; line-height: 16px; color: #929292;">
			</div>
		</div>
		<div style="width: 100%; height: 40px;"></div>

	</div>
</div>
</div>
</div>
<script>
EwmTransferCtrl.$inject = ["$scope","$remote","$targets","$filter","$context"];
function EwmTransferCtrl($scope,$remote,$targets,$filter,$context){
	$scope.init=function(){
		$scope.getPayeeInfo();
// 		$scope.saveThis=true;
		$scope.buttonDis="false";
		//查询借记卡
		$remote.post("/pmobile/ActListQry.do",{},function(data){
			$scope.acList=data.PayerList;
			var filterFn=$filter("filter");
			$scope.acList=filterFn($scope.acList,function(obj,text){
				if(obj.AcNo != undefined){
					obj.AcNo1=obj.AcNo.substring(0,4)+"****"+ obj.AcNo.substring(obj.AcNo.length-4)
					obj.AcNo2=obj.AcNo1;
					if(obj.AcAlias.length>4){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias.substring(0,4)+"...";
					}else if(obj.AcAlias.length<=4&&obj.AcAlias.length>0){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias;
					}else{
						obj.AcNo1=obj.AcNo1;
					}
					return true;
				}
			});
			$scope.mobileNo=data.MobilePhone;
			$scope.payCard=$scope.acList[0];
			$scope.selfRCard=$scope.acList[0];
			$scope.getCardInfo();
		});
	}
	//调用密码控件
	$scope.getPW=function(){
		$("#cardpassword").val("");
		$scope.buttonDis="false";
		var scrollHeight=$scope.getPWPosition($("#cardpassword").get(0));//定位当前密码输入栏位在文档中的位置
		$scope.getPassword(function(pwResponse){
			var resJson=vx.fromJson(pwResponse);
			if(resJson.Flag==0){
				$("#cardpassword").val(resJson.passWord);
			}else if(resJson.Flag==1){
				$scope.miwen=resJson.passWord;
				$scope.buttonDis = resJson.buttonDis;
			}
		},scrollHeight);
	}
	//回调二维码转账的收款人信息
	$scope.getPayeeInfo=function(){
		$scope.getErWeiMaInfo(function(response){
			var resJson=vx.fromJson(response);
			$scope.rCard=resJson.cardNumber;
			$scope.rName=resJson.userName;
		});
	}

	//跳转到抽奖页面
	$scope.gotoRewardPage=function(){
		$context.clear();
		$scope.TransName="20000121";
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":$scope.TransName},function(data){
			if(data.GAMETYPE=="0"){
				var param={
						"ReWardCount":data.REWARDCOUNT,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						"TransName":data.TRANSNAME,
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("LotteryDraw");
			}else if(data.GAMETYPE=="2"){
				var param={
						"ReWardCount":data.REWARDCOUNT,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						"TransName":data.TRANSNAME,
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("GuaGuaLe");
			}else if(data.GAMETYPE=="3"){
				var param={
						"ReWardCount":data.REWARDCOUNT,
						"Count":data.COUNT,
						"GameType":data.GAMETYPE,
						"IsReward":data.ISREWARD,
						"TransName":data.TRANSNAME,
						"UpDateTime":data.UPDATETIME
				}
				$context.setJson({"innerParam":param});
				$scope.goto("YaoYiYao");
			}
		});
	}
	//改变支付卡
	$scope.getCardInfo=function(){
		var cardNo=$scope.payCard.AcNo;
		//查询余额
		$remote.post("/pmobile/ActBalQry.do",{"AcNo":cardNo},function(data){
			$scope.cardInfo=data;
			$scope.balance=data.AvailBal;
		});
	}
	//跳转到确认页面
	$scope.toConfirm=function(){
		//初始化确认页面数据
// 		$scope.dycode="";
// 		$("#cardpassword").val("");
// 		$scope.miwen="";
// 		$scope.imgcode="";
// 		$scope.keypassword="";
// 		$("#anniu").text("获取动态码");
// // 		$("#anniu").css("background-color","#0084ff");
		if(!$scope.amount){
			NativeCall.toast("金额不能为空");
		}
		if(parseFloat($scope.amount)>parseFloat($scope.balance)){
			NativeCall.toast("卡内余额不足！");
			return;
		}
		if($scope.yongtu==null||$scope.yongtu==""){
			$scope.yongtu="转账"
		}
		var reg=new RegExp(/^[\u4E00-\u9FA5A-Za-z0-9]+$/);//u4e00-u9fa5---数字字母开头（包含汉字）
		if(!reg.test($scope.yongtu)){
			NativeCall.toast("用途格式只能为汉字、数字或字母");
			return false;
		}
		paramsss={
				"PayerAcNo":$scope.payCard.AcNo,
				"Amount":$scope.amount,
				"PayeeAcName":$scope.rName,
				"Currency":$scope.cardInfo.Currency,
				"Remark":$scope.yongtu,
				"Balance":$scope.cardInfo.Balance
		};
		$remote.post("/pmobile/CodeTransferConfirm.do",paramsss,function(data){
			$scope.authType=data.Flag;
			$scope.Security=data.Security;
			$scope._tokenName=data._tokenName;
			if($scope.authType==2){
				$scope.flagl=0;
				$scope.giveMes();
			}
			if($scope.authType==0&&$scope.Security=="07"){
				$scope.flagl=1;
				$scope.giveMes();
			}
			if($scope.authType==0&&$scope.Security=="05"){
				$scope.flagl=2;
				$scope.giveMes();
			}
			if(data._RejCode=="ECIP0023"||data._RejCode=="ECIP0024"){
				$scope.confirm("超过当前认证方式限额，是否切换认证方式为音频KEY？",function(){
					$remote.post("/pmobile/ChannelAuthTypeUpd.do",{"security":"05"},function(data){
						if(data._RejCode=="000000"){
							$scope.flagl=2;
							$scope.giveMes();
						}
					});
				},function(){
					return;
				});
			}
		});	
	}
	$scope.giveMes=function(){
		var paramss={
				"PayeeAcNo":$scope.rCard,
				"thenum":$scope.payCard.AcNo, //转账list
				"Amount":$scope.amount, //转账金额
				"PayeeAcName":$scope.rName,
				"Currency":$scope.cardInfo.Currency,
				"Remark":$scope.yongtu, //用途
				"Balance":$scope.cardInfo.Balance,
				"flag":$scope.flagl
		};
		$scope.params={};

		$scope.ewmShow(function(pwResponse){
// 			var resJson=vx.fromJson(pwResponse);
			var resJson=vx.fromJson(pwResponse);
			$scope.params={
					"PayeeAcNo":$scope.rCard,
					"PayerAcNo":$scope.payCard.AcNo,
					"Amount":$scope.amount, //转账金额
					"PayeeAcName":$scope.rName,
					"Currency":$scope.cardInfo.Currency,
					"Remark":$scope.yongtu, //用途
					"Balance":$scope.cardInfo.Balance
			}
			$scope.params.IsSave=$scope.saveThis?1:0;
			$scope.miwen=resJson.CardPassword;
			$scope.dycode=resJson.SmsCode;
			$scope.msmNo=resJson.SerialNo;
			$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":"20000121"},function(data){
				$scope.IsReward=data.ISREWARD;
			});
				//防重复提交码
				$scope.params._tokenName=$scope._tokenName;
				//确定认证方式
				if($scope.authType==0){//当前认证方式
					if($scope.Security=="05"){//音频key
						$scope.recAccountNo=$scope.rCard;
						$scope.recAccountName=$scope.rName;
						
// 						//音频PKY制签名需要的数据
// 						var inputData={"recAccountNo":$scope.recAccountNo,"recAccountName":$scope.recAccountName,"tranAmount":$scope.amount,
// 								"accountNo":$scope.payCard.AcNo,"currencyType":$scope.RMBChange($scope.cardInfo.CurrencyName),"payUse":$scope.yongtu};
// 						var sourceField = "收款人账号#"+inputData.recAccountNo+"|收款人户名#"+inputData.recAccountName+"|转账金额#"+inputData.tranAmount+"|付款人账号#"+inputData.accountNo;
// 						//调用音频KEY字段转换xml格式的方法
// 						var sinData = $scope.getSignSourceValue(sourceField,"币种#"+inputData.currencyType+"|用途#"+inputData.payUse);
// 						var subData={"sinData":sinData,"YPKPassword":$scope.keypassword};
// 						//通过原生调用音频key
// 						$scope.getSignData(function(outputdata){
// 							$scope.params.SignData=outputdata;
// 							//使用音频KEY调用该交易
// 							$scope.doIt();
// 						},vx.toJson(subData));
						$scope.outputdata=resJson.SignData;
						$scope.params.SignData=$scope.outputdata;
						$scope.doIt();
						
					}else if($scope.Security=="07"){//手机动态码+卡密码
						$scope.params.TrsPassword=$scope.miwen;
						$scope.params.SmsCode=$scope.dycode;
						$scope.params.SerialNo=$scope.msmNo;
					}
				}else if($scope.authType==2){//手机动态码
					$scope.params.SmsCode=$scope.dycode;
					$scope.params.SerialNo=$scope.msmNo;
				}
				//未使用音频KEY，才发送该交易
				if($scope.Security!="05"||$scope.authType!=0){
					$scope.doIt();
				}
		},vx.toJson(paramss));
// 		if(parseFloat($scope.amount)>parseFloat($scope.balance)){
// 			NativeCall.toast("卡内余额不足！");
// 			return;
// 		}
		
	}
	//二维码转账确认交易
	$scope.CodeTransConfirm=function(params){
		$remote.post("/pmobile/CodeTransferConfirm.do",params,function(data){
			$scope.authType=data.Flag;
			$scope.Security=data.Security;
			$scope._tokenName=data._tokenName;
			if($scope.authType==2||($scope.authType==0&&$scope.Security=="07")){
				$scope.getMessageCode();//启动监听手机动态码
			}
			if(data._RejCode=="ECIP0023"||data._RejCode=="ECIP0024"){
				$scope.confirm("超过当前认证方式限额，是否切换认证方式为音频KEY？",function(){
					$remote.post("/pmobile/ChannelAuthTypeUpd.do",{"security":"05"},function(data){
						if(data._RejCode=="000000"){
							$scope.changeClientInfo(vx.toJson({"Security":"05"}));//修改登录信息
						}
					});
				},null);
			}else{
				$targets("content","#2");
			}
			$remote.post("/pmobile/GenTokenImg.do",{},function(data){
				$scope.TokenImg=data.imgKey;
			});
		});	
	}
	//跳转到结果页
	$scope.toResult=function(){//---id参数用来标示提交错误时刷新图片验证码
		$remote.post("/pmobile/TransRewardsQry.do",{"TRANSNAME":"20000121"},function(data){
			$scope.IsReward=data.ISREWARD;
		});
			//防重复提交码
			$scope.params._tokenName=$scope._tokenName;
			//确定认证方式
			if($scope.authType==0){//当前认证方式
				if($scope.Security=="05"){//音频key
					$scope.recAccountNo=$scope.rCard;
					$scope.recAccountName=$scope.rName;
					
// 					//音频PKY制签名需要的数据
// 					var inputData={"recAccountNo":$scope.recAccountNo,"recAccountName":$scope.recAccountName,"tranAmount":$scope.amount,
// 							"accountNo":$scope.payCard.AcNo,"currencyType":$scope.RMBChange($scope.cardInfo.CurrencyName),"payUse":$scope.yongtu};
// 					var sourceField = "收款人账号#"+inputData.recAccountNo+"|收款人户名#"+inputData.recAccountName+"|转账金额#"+inputData.tranAmount+"|付款人账号#"+inputData.accountNo;
// 					//调用音频KEY字段转换xml格式的方法
// 					var sinData = $scope.getSignSourceValue(sourceField,"币种#"+inputData.currencyType+"|用途#"+inputData.payUse);
// 					var subData={"sinData":sinData,"YPKPassword":$scope.keypassword};
// 					//通过原生调用音频key
// 					$scope.getSignData(function(outputdata){
// 						$scope.params.SignData=outputdata;
// 						//使用音频KEY调用该交易
// 						$scope.doIt();
// 					},vx.toJson(subData));
					
					
					
				}else if($scope.Security=="07"){//手机动态码+卡密码
					$scope.params.TrsPassword=$scope.miwen;
					$scope.params.SmsCode=$scope.dycode;
					$scope.params.SerialNo=$scope.msmNo;
				}
			}else if($scope.authType==2){//手机动态码
				$scope.params.SmsCode=$scope.dycode;
				$scope.params.SerialNo=$scope.msmNo;
			}
			//未使用音频KEY，才发送该交易
			if($scope.Security!="05"||$scope.authType!=0){
				$scope.doIt();
			}
	}
	//二维码转账交易
	$scope.doIt=function(){
		$remote.post("/pmobile/CodeTransfer.do",$scope.params,function(data){
			if(data._RejCode=="000000"){
				$scope.InnerResult=data;
				$targets("content","#3");
				NativeCall.history = [];//清空历史，点击左上角返回时，可直接返回原生菜单
				NativeCall.pages=[];
			}
		},function(data){
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			//清空数据
			$("#cardpassword").val("");
			$scope.miwen="";
			$scope.dycode="";
			$scope.imgcode="";
			$scope.keypassword="";
			$scope.getToken();
			return data.jsonError;
		});
	}
	//继续转账
	$scope.continueTrans=function(){
		$targets("content","#0");
	}
	//跳转到交易明细
	$scope.toQueryTransInfo=function(){
		$context.clear();
		$scope.goto("InnerTransfer","PTransInfoQry");
	}
	//刷新验证码
	$scope.freshCode=function(id){
		$remote.post("/pmobile/GenTokenImg.do?r"+Math.random(),{},function(data){
			$scope.TokenImg=data.imgKey;
		});
	}
	//获取手机动态码
	$scope.getMessageCode=function(){
		$scope.getMseCode(function(pwResponse){
			$("#dycode").val(pwResponse);
			$scope.dycode=pwResponse;
		});
	}
	//倒计时的回调函数
	$scope.getDYcode=function(){
		//行内他人、行内本人、手机号
		$scope.businessName="二维码转账";
		var params={
				"BusinessName":$scope.businessName,
				"MobileNo":$scope.mobileNo,
				"ServiceCode":"DCA000004"
		}
		//获取手机动态码
		$remote.post("/pmobile/GenTokenName.do",params,function(data){
			$scope.msmNo=data.SerialNo;
		});
	}
	
}
</script>