//
//  SkyManagerViewController.m
//  MobileClient
//
//  Created by xiaoxin on 15/4/28.
//  Copyright (c) 2015年 pro. All rights reserved.
//

#import "SkyManagerViewController.h"
#import"MKNetworkKit.h"

#import "ZipArchive.h"

#import "CSIIUIAsyncImageView.h"

@interface SkyManagerViewController ()
{
    NSMutableArray*buttonArray;
    NSMutableArray*SkyNameArray;
    NSMutableArray*imgArray;
    NSMutableArray *skinImageViewArray;
}
@end

@implementation SkyManagerViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    buttonArray = [[NSMutableArray alloc]init];
    
    [MobileBankSession sharedInstance].delegate =self;
    [[MobileBankSession sharedInstance]postToServer:@"SkinNameQry.do" actionParams:nil method:@"POST"];
//    SkyNameArray = [NSMutableArray arrayWithObjects:@[@"天空蓝",@"芳草绿",@"活力橙"], nil];
//    imgArray = [NSMutableArray arrayWithObjects:@[@"style_blue",@"style_green",@"style_golden"], nil];
    SkyNameArray = [[NSMutableArray alloc]init];
    [SkyNameArray addObject:@"天空蓝"];
    [SkyNameArray addObject:@"芳草绿"];
    [SkyNameArray addObject:@"活力橙"];

    imgArray = [[NSMutableArray alloc]init];
    [imgArray addObject:@"skyblue"];
    [imgArray addObject:@"gressgreen"];
    [imgArray addObject:@"energyorange"];

    skinImageViewArray = [[NSMutableArray alloc]init];
    for (int i=0; i<[imgArray count]; i++) {
        UIImageView *imageView = [[UIImageView alloc]init];
        imageView.image = [UIImage imageNamed:[NSString stringWithFormat:@"%@",imgArray[i]]];
        imageView.frame = CGRectMake(20, 10,(ScreenWidth-45)/2-40 , 180*((ScreenWidth-45)/2-40)/104);

        [skinImageViewArray addObject:imageView];
    }

    
    // Do any additional setup after loading the view.
}
-(void)selectBtnShow
{
    NSString *skinString = [Context getNSUserDefaultskeyStr:@"skin"];
    NSString *skinTagString = [Context getNSUserDefaultskeyStr:@"skinTag"];
    for (int i=100; i<100+skinImageViewArray.count; i++) {
        UIButton *btn = (UIButton *)[self.view viewWithTag:i];
        if (skinTagString.length==0||[skinTagString  isEqualToString:@""]||[skinTagString isEqualToString:@"100"]) {
            if (btn.tag==100) {
                btn.selected = YES;
                btn.backgroundColor = [UIColor colorWithRed:0.01f green:0.42f blue:0.69f alpha:1.00f];
                btn.layer.borderWidth = 1;
                btn.layer.borderColor = [[UIColor colorWithRed:0.01f green:0.42f blue:0.69f alpha:1.00f]CGColor];
            }
        }
        
        else{
            if (btn.tag ==[skinTagString intValue]) {
                btn.selected = YES;
                btn.backgroundColor = [UIColor colorWithRed:0.01f green:0.42f blue:0.69f alpha:1.00f];
                btn.layer.borderWidth = 1;
                btn.layer.borderColor = [[UIColor colorWithRed:0.01f green:0.42f blue:0.69f alpha:1.00f]CGColor];
            }
        }
        
    }
}
-(void)checkAction:(UIButton *)sender{
    
    [MobileBankSession sharedInstance].changeSkinColor = imgArray[sender.tag-100];
    
    [Context setNSUserDefaults:[NSString stringWithFormat:@"%@",[MobileBankSession sharedInstance].changeSkinColor] keyStr:@"skin"];
    [Context setNSUserDefaults:[NSString stringWithFormat:@"%ld",(long)sender.tag] keyStr:@"skinTag"];

    
    [self changeSkin];
    [self viewWillAppear:YES];
    
    for (int i=100; i<100+skinImageViewArray.count; i++) {
        UIButton *button = (UIButton *)[self.view viewWithTag:i];
        button.backgroundColor = [UIColor whiteColor];
        button.selected = NO;
        button.layer.borderWidth = 1;
        button.layer.borderColor = [[UIColor grayColor]CGColor];
    }
    sender.selected = YES;
    sender.backgroundColor = [UIColor colorWithRed:0.01f green:0.42f blue:0.69f alpha:1.00f];
    sender.layer.borderWidth = 1;
    sender.layer.borderColor = [[UIColor colorWithRed:0.01f green:0.42f blue:0.69f alpha:1.00f]CGColor];
    NSLog(@"%ld",(long)sender.tag);
}
-(void)changeSkin
{
    // 解压缩完的路径
    NSArray *documentPaths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory,  NSUserDomainMask,YES);//使用C函数NSSearchPathForDirectoriesInDomains来获得沙盒中目录的全路径。
    NSString *ourDocumentPath =[documentPaths objectAtIndex:0];
    
    NSString *unZipPath = [NSString stringWithFormat:@"%@/book",ourDocumentPath];
    // 文件管理器
    NSFileManager *fm = [[NSFileManager alloc] init];
    // 判断解压缩完的路径文件是否存在
    //    if(![fm fileExistsAtPath:unZipPath])
    //    {
    NSLog(@"文件不存在,需要解压缩");
    // book.zip路径
    NSString *bookPath = [NSString stringWithFormat:@"%@/%@.zip",[[NSBundle mainBundle] resourcePath],[MobileBankSession sharedInstance].changeSkinColor];
    ZipArchive *zipArchive = [[ZipArchive alloc] init];
    // 判断解压文件是否可以打开
    if([zipArchive UnzipOpenFile:bookPath])
    {
        // 解压缩到指定路径
        [zipArchive UnzipFileTo:unZipPath overWrite:YES];
        NSLog(@"文件解压缩成功");
    }
    else
        NSLog(@"文件无法打开，无法解压缩");
    //    }
    NSArray *arr = [fm directoryContentsAtPath:[NSString stringWithFormat:@"%@/%@",unZipPath,[MobileBankSession sharedInstance].changeSkinColor]];
    NSLog(@"%@",arr);
    //    for (int i=0; i<arr.count; i++) {
    //        if ([arr[i] isEqualToString:@"1102.jpg"]) {
    //            imageView.image = [UIImage imageWithContentsOfFile:[NSString stringWithFormat:@"%@/book/%@",unZipPath,arr[i]]];
    //        }
    //    }
    
    //  unZipPath  /var/mobile/Containers/Data/Application/AA36301F-D7CA-4625-B0FE-EAACF61D1B27/Documents/book
    
}

-(void)getReturnData:(id)data WithActionName:(NSString *)action
{
    if ([action isEqualToString:@"SkinNameQry.do"]) {
        if ([[data objectForKey:@"_RejCode"]isEqualToString:@"000000"]) {
            NSLog(@"%@",data);
            NSArray *skinNameArray = [data objectForKey:@"List"];
            for (int i=0; i<skinNameArray.count; i++) {
                [imgArray addObject:[skinNameArray[i] objectForKey:@"SKINNAME"]];
                [SkyNameArray addObject:[skinNameArray[i] objectForKey:@"SKINVALUE"]];
                NSMutableDictionary *dic = [[NSMutableDictionary alloc]init];
                [dic setObject:[skinNameArray[i] objectForKey:@"SKINNAME"]  forKey:@"SkinName"];
                CSIIUIAsyncImageView *asyncImageView = [[CSIIUIAsyncImageView alloc]initWithTransaction:CGRectMake(20, 10,(ScreenWidth-45)/2-40 , 180*((ScreenWidth-45)/2-40)/104) transactionId:@"IconImageQry.do" argument:dic];
                [skinImageViewArray addObject:asyncImageView];
                
            }
            [self createImageUI];
            
        }
    }
    [self selectBtnShow];

}
-(void)createImageUI
{
    UIScrollView *backScroll = [[UIScrollView alloc]initWithFrame:CGRectMake(0, 0, self.view.frame.size.width, self.view.frame.size.height-64)];
    backScroll.contentSize = CGSizeMake(ScreenWidth, (skinImageViewArray.count/2+1)*(225+15));
    [self.view addSubview:backScroll];

    for (int x=0; x<skinImageViewArray.count; x++) {
            UIView*backgroundView = [[UIView alloc]initWithFrame:CGRectMake(15+(15+(ScreenWidth-45)/2)*(x%2), 15+(30+210)*(x/2), (ScreenWidth-45)/2, 200+10)];
            backgroundView.backgroundColor = [UIColor whiteColor];
            backgroundView.layer.borderWidth = 1.0f;
            //            backgroundView.tag = [[TagArray objectAtIndex:x] integerValue];
            backgroundView.layer.borderColor = [[UIColor colorWithHue:0 saturation:0 brightness:0.86 alpha:1.0] CGColor];
        
        UIImageView *imageView = skinImageViewArray[x];
        NSLog(@"大小%@",imageView);
            [backgroundView addSubview:imageView];
            
            UILabel*skyName = [[UILabel alloc]initWithFrame:CGRectMake(10, backgroundView.frame.size.height-25, 60, 20)];
            skyName.backgroundColor = [UIColor clearColor];
            skyName.font = [UIFont boldSystemFontOfSize:13];
            skyName.textAlignment = NSTextAlignmentCenter;
            skyName.textColor = [UIColor colorWithRed:0.50f green:0.50f blue:0.50f alpha:1.00f];
            skyName.text = [SkyNameArray objectAtIndex:x];
            [backgroundView addSubview:skyName];
            
            UIButton*btn = [UIButton buttonWithType:UIButtonTypeCustom];
            btn.backgroundColor = [UIColor whiteColor];
            btn.layer.cornerRadius = 4;
            btn.frame = CGRectMake(backgroundView.frame.size.width-60 , backgroundView.frame.size.height-25, 50, 20);
            [btn setTitle:@"设置" forState:UIControlStateNormal];
            [btn setTitle:@"使用中" forState:UIControlStateSelected];
            btn.layer.borderWidth = 1;
            btn.layer.borderColor = [UIColor grayColor].CGColor;
            btn.titleLabel.font = [UIFont systemFontOfSize:12];
            btn.tag = x+100;
            [btn addTarget:self action:@selector(checkAction:) forControlEvents:UIControlEventTouchUpInside];
            [backgroundView addSubview:btn];
            [btn setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];
            [btn setTitleColor:[UIColor whiteColor] forState:UIControlStateSelected];
            
            [buttonArray addObject:btn];
            
            //            UITapGestureRecognizer*tap = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(changeSky:)];
            //            [backgroundView addGestureRecognizer:tap];
            [backScroll addSubview:backgroundView];
    }

}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

-(void)viewWillAppear:(BOOL)animated{
    
    [super viewWillAppear:animated];
    
    ((UILabel*)[self.navigationController.navigationBar viewWithTag:99]).text = @"主题设置";
}
/*
 #pragma mark - Navigation
 
 // In a storyboard-based application, you will often want to do a little preparation before navigation
 - (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
 // Get the new view controller using [segue destinationViewController].
 // Pass the selected object to the new view controller.
 }
 */

@end
