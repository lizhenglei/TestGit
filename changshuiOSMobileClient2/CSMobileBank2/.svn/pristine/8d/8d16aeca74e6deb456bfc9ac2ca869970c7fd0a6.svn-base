<div v-view-setup="PMyPrd2Ctrl" v-init="init()">
	<!-- 我的理财 -->
	<div  class="bg_box" v-page v-transition="native" title="我的理财">
		<div class="box_cont">
			<div class="zz_cont">
					<ul>
						<li>
							<em style="width:25%">卡号：</em>
							<i>
								<select  v-change="getAllList()" v-model="payCard" name="payCard" v-options="ac.AcNo1 for ac in acList" >
								</select>
							</i>
						</li>
					</ul>
			</div>
			<div class="box_cont" style="font-size:14px;padding-top:5px;" v-show="(cancleList&&cancleList.length)||(noCancleCyList&&noCancleCyList.length)||(noCancleWtList&&noCancleWtList.length)>0">粒金理财</div>
			<!-- 可撤销的粒金理财 -->
			<div class="zz_cont bor_1" v-repeat="cl in cancleList">
					<ul style="position:relative">
						<li>
							<em style="width: 40%;">产品名称：</em>
							<i style="width: 50%;">
								{{cl.PrdctNm}}
							</i>
						</li>
						<li>
							<em style="width: 40%;">产品天数：</em>
							<i style="width: 50%;">
								{{cl.CPTSDate}}天
							</i>
						</li>
						<li>
							<em style="width: 40%;">持有金额：</em>
							<i style="width: 50%;">
								{{cl.OrigAplyAmt|number:2}}
							</i>
						</li>
						<li style="border:none">
							<div class="jindu">
								<div class="jindu_top">
									<div class="w25">购买日<br/>{{cl.OrigTxnDt|formatDate}}</div><div class="w25">&nbsp;</div><div class="w25">到期日<br/>{{cl.PrdctEndDt|formatDate}}</div><div class="w25">&nbsp;</div>
								</div>
								<div class="jindu_center">
									<div class="w25 c4242ff"><img class="sjyuan" src="images/a1.png" /></div>
									<div class="w25 cccccc"><img class="sjyuan" src="images/b2.png" /></div>
									<div class="w25 cccccc"><img class="sjyuan" src="images/b3.png" /></div>
									<div class="w25 cccccc"><img class="sjyuan" src="images/b4.png" /></div>
								</div>
								<div class="jindu_bottom">
									<div class="w25">&nbsp;</div><div class="w25">{{cl.FndPrdctDt|formatDate}}<br/>产品成立日</div><div class="w25">&nbsp;</div><div class="w25">{{cl.ZCDFDate|formatDate}}<br/>最迟兑付日</div>
								</div>
							</div>
						</li>
					</ul>
					<div >
						<div class="button_pd" v-click="cancleLJ(cl)" ><img class="cancel" src="images/chexiao.png"></div>
					</div>
					<div>
						<input type="text" style="height:0px;width:98.6%;border:white" v-disabled="true">
					</div>
			</div>
			<!-- 当前持有不可撤销的粒金理财 -->
			<div class="zz_cont bor_1" v-repeat="ncl in noCancleCyList">
					<ul>
						<li>
							<em style="width: 40%;">产品名称：</em>
							<i style="width: 50%;">
								{{ncl.PrdctNm}}
							</i>
						</li>
						<li>
							<em style="width: 40%;">产品天数：</em>
							<i style="width: 50%;">
								{{ncl.CPTSDate}}天
							</i>
						</li>
						<li>
							<em style="width: 40%;">持有金额：</em>
							<i style="width: 50%;">
								{{ncl.FndPrdctLot|number:2}}
							</i>
						</li>
						<li style="border:none">
							<div class="jindu">
								<div class="jindu_top">
									<div class="w25" style="width:35%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div class="w25" style="width:30%">到期日<br/>{{ncl.PrdctEndDt|formatDate}}</div><div class="w25">&nbsp;</div>
								</div>
								<div class="jindu_center">
									<div class="w25 c4242ff" style="width:35%"><img class="sjyuan" src="images/a1.png" /></div>
									<div class="w25 cccccc" style="width:30%"><img class="sjyuan" src="images/b2.png" /></div>
									<div class="w25 cccccc" style="width:35%"><img class="sjyuan" src="images/b3.png" /></div>
								</div>
								<div class="jindu_bottom">
									<div class="w25" style="width:35%">{{ncl.FndPrdctDt|formatDate}}<br/>产品成立日</div><div class="w25" style="width:30%">&nbsp;</div><div class="w25" style="width:35%">{{ncl.ZCDFDate|formatDate}}<br/>最迟兑付日</div>
								</div>
							</div>
						</li>
					</ul>
					<div >
						<input type="text" style="height:0px;width:98.6%;border:white" v-disabled="true">
					</div>
			</div>
			<div class="box_cont" style="font-size:14px;padding-top:5px;" v-show="(atoneList&&atoneList.length>0)||(applyCancleList&&applyCancleList.length>0)||(atoneCancleList&&atoneCancleList.length>0)">天天利</div>
			<!-- 天天利可赎回 -->
			<div class="zz_cont bor_1" v-repeat="al in atoneList">
					<ul>
						<li>
							<em style="width: 40%;">产品名称：</em>
							<i style="width: 50%;">
								{{al.prdName}}
							</i>
						</li>
						<li>
							<em style="width: 40%;">持有金额：</em>
							<i style="width: 50%;">
								{{al.balance|number:2}}
							</i>
						</li>
					</ul>
					<div>
						<div class="button_pd" v-click="atoneTTL(al)"><img class="buyback" src="images/shuhui.png"></div>
					</div>
					<div >
						<input type="text" style="margin:0px;padding:0px;height:0px;width:98.6%;border:white" v-disabled="true">
					</div>
			</div>
			
			<!-- 天天利申购撤销 -->
			<div class="zz_cont bor_1" v-repeat="apcl in applyCancleList">
					<ul>
						<li>
							<em style="width: 40%;">产品名称：</em>
							<i style="width: 50%;">
								{{apcl.prdName}}
							</i>
						</li>
						<li>
							<em style="width: 40%;">交易金额：</em>
							<i style="width: 50%;">
								{{apcl.tranAmount|number:2}}
							</i>
						</li>
					</ul>
					<div>
						<div class="button_pd" v-click="cancleTTL(apcl,0)"><img class="cancel" src="images/chexiao.png"></div>
					</div>
					<div >
						<input type="text" style="height:0px;width:98.6%;border:white" v-disabled="true">
					</div>
			</div>
		
			
		</div>
		<div class="zz_cont"><img class="hint" src="images/ts.png" />
		    <font class="tishi">
				温馨提示</br>
			</font>
				&nbsp;&nbsp;您可以查询您持有的所有理财产品。 </br>
			<div style="font-size:12px; line-height:16px; color:#929292;"> </div>
	   </div>
	</div>
	<div style="width:100%;height:40px;"></div>
</div>
<script>
PMyPrd2Ctrl.$inject = ["$scope","$remote","$targets","$context","$filter"];
function PMyPrd2Ctrl($scope,$remote,$targets,$context,$filter){
	$scope.init=function(){
		//查询借记卡
		$remote.post("/pmobile/ActListQry.do",{},function(data){
			$scope.acList=data.AcList;
			var filterFn=$filter("filter");
			$scope.acList=filterFn($scope.acList,function(obj,text){
				if(obj.AcNo != undefined){
					obj.AcNo1=obj.AcNo.substring(0,4)+"****"+ obj.AcNo.substring(obj.AcNo.length-4);
					obj.AcNo2=obj.AcNo1;
					if(obj.AcAlias.length>4){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias.substring(0,4)+"...";
					}else if(obj.AcAlias.length<=4&&obj.AcAlias.length>0){
						obj.AcNo1=obj.AcNo1+" / "+obj.AcAlias;
					}else{
						obj.AcNo1=obj.AcNo1;
					}
					return true;
				}
			});
			$scope.payCard=$scope.acList[0];
			//获取当前购买的我的理财（粒金和天天利）
			$scope.getAllList();
		});
	}
	//我的理财数据（包括粒金理财不可撤销和可撤销、天天利理财可赎回和申购撤销列表）
	$scope.getAllList=function(){
		var params={
				"CstId":$scope.payCard.AcNo
		}
		$remote.post("/pmobile/MyPrd.do",params,function(data){
			console.log(data);
			//使用过滤器统一过滤特殊条件
			var filterFn=$filter("filter");
			
			//当前委托粒金可以撤销的列表			
			$scope.cancleList=data.List2;
			$scope.cancleList=filterFn($scope.cancleList,function(obj,text){
				if(obj.TplCd=='1102'&&obj.TxnSt=='1'){
					return true;//当委托信息为粒金理财并且为交易状态未受理的情况下
				}
			});
			//当前持有不可撤销列表
			$scope.noCancleCyList=data.List1;
			$scope.noCancleCyList=filterFn($scope.noCancleCyList,function(obj,text){
				if(obj.TplCd=='1102'){
					return true;//当前持有信息过滤为粒金理财即可
				}
			});
		},function(data){
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			//清空数据
			$scope.noCancleCyList=[];
			$scope.noCancleWtList=[];
			$scope.cancleList=[];
			return data.jsonError;
		});
		
		var params={
				"AcNo":$scope.payCard.AcNo,
				"accType":0,//和客户标示类型对应、accType为0时送卡号，accType为1时送核心客户号，accType为2时送证件号
				"tranType":20,//20-代表天天利可撤销的列表（申购撤销）
				"pageSize":200,
				"currentIndex":1
		}
		$remote.post("/pmobile/MyPrdTransfer.do",params,function(data){
			$scope.atoneList=data.List[0].List3;//天天利可赎回列表
			$scope.applyCancleList=data.List[0].List4;//天天利申购撤销列表,其中dealFlag为1代表可撤销
			
			//使用过滤器统一过滤特殊条件
			var filterFn=$filter("filter");
			$scope.atoneList=filterFn($scope.atoneList,function(obj,text){
				if(obj.balance!='0.00'){//天天利可赎回列表，其中balance不为0代表已划转可以赎回
					return true;
				}
			});
			$scope.applyCancleList=$filter("filter")($scope.applyCancleList,{
				"dealFlag":1//天天利申购撤销列表,其中dealFlag为1代表可撤销
			});
		},function(data){
			if(data.jsonError){
				$scope.alert(data.jsonError);
			}
			//清空数据
			$scope.atoneList=[];
			$scope.applyCancleList=[];
			return data.jsonError;
		});
		
		if($scope.noCancleCyList==""&&$scope.cancleList==""&&$scope.atoneList==""&&$scope.applyCancleList==""){
			$scope.alert("查询无记录");
		}
	}
	
	//撤销粒金理财
	$scope.cancleLJ=function(obj){
		$scope.confirm("您将撤销此产品！",function(){
			//获取完成交易token防重复码
			$remote.post("/pmobile/getNewTokenName.do",{},function(data){
				if(data._RejCode=="000000"){
					var pars={
							"AcNo":$scope.payCard.AcNo,
							"prdCode":obj.PrdctCd,
							"tranAmount":obj.OrigAplyAmt,
							"serialNo":obj.OrigTxnSeqNo,
							"_tokenName":data._tokenName
						};
					//查询当前粒金理财委托信息（可撤销）
					$remote.post("/pmobile/TestLJLCCancelInfo.do",pars,function(data){
						var temp=$scope.cancleList;
						vx.forEach(temp,function(item,index){
							if(item.OrigTxnSeqNo==obj.OrigTxnSeqNo){
								$scope.cancleList.splice(index,1);
							}
						})
						$scope.alert("撤销成功！");
					});
				}
			});
		},null);
	}
	
	//撤销天天利
	$scope.cancleTTL=function(obj,flag){
		//日期格式转化YYYY-MM-DD转为YYYYMMDD
		var apDate=obj.applyDate.replace("-","").replace("-","");
		$scope.confirm("您将撤销此产品！",function(){
			//获取完成交易token防重复码
			$remote.post("/pmobile/getNewTokenName.do",{},function(data){
				if(data._RejCode=="000000"){
					var pars={
							"AcNo":$scope.payCard.AcNo,
							"prdCode":obj.prdCode,
							"tranAmount":obj.tranAmount,
							"contractNo":obj.contractNo,
							"flag":flag,
							"applyDate":apDate,
							"serialNo":obj.serialNo,
							"_tokenName":data._tokenName
						}
					//撤销天天利申请
					$remote.post("/pmobile/QueryTTLCancelInfo.do",pars,function(data){
						if(flag==0){
							var temp=$scope.applyCancleList;
							vx.forEach(temp,function(item,index){
								if(item.serialNo==obj.serialNo){
									$scope.applyCancleList.splice(index,1);
								}
							});
							$scope.alert("撤销成功！");
						}
					});		
				}
			});
		},null);
	}
	
	//跳往天天利赎回页面
	$scope.atoneTTL=function(obj){
		obj.AcNo=$scope.payCard.AcNo;
		$context.setJson({"selectedTTL":obj});
		$scope.goto("PMyPrd","TianTianLiRansom");
	}
}
</script>